!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],e):(t.aop=t.aop||{},t.aop.umd=t.aop.umd||{},t.aop.umd.js=e(t.tslib_1,t["@ts-ioc/core"]))}(this,function(r,A){"use strict";function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}r=r&&r.hasOwnProperty("default")?r.default:r,A=A&&A.hasOwnProperty("default")?A.default:A;var a=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.AopActions||(e.AopActions={})).registAspect="registAspect",n.exetndsInstance="exetndsInstance",n.matchPointcut="matchPointcut",n.bindPropertyPointcut="bindPropertyPointcut",n.bindMethodPointcut="bindMethodPointcut",n.invokeBeforeConstructorAdvices="invokeBeforeConstructorAdvices",n.invokeAfterConstructorAdvices="invokeAfterConstructorAdvices"});t(a);a.AopActions;var u=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorToken=new A.InjectToken("DI_IAdvisor")});t(u);u.AdvisorToken;var o=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,a.AopActions.registAspect)||this}return r.__extends(e,t),e.prototype.working=function(t,e){var n=e.targetType,r=t.getLifeScope().getClassDecorators(function(t){return t.actions.includes(a.AopActions.registAspect)&&A.hasOwnClassMetadata(t.name,n)}),o=t.get(u.AdvisorToken),i=e.raiseContainer||t;r.forEach(function(t){var e=A.getOwnTypeMetadata(t.name,n);Array.isArray(e)&&0<e.length&&e.forEach(function(t){A.isClass(t.type)&&o.add(t.type,i)})})},e.classAnnations={name:"RegistAspectAction",params:{constructor:[],working:["container","data"]}},e}(A.ActionComposite);e.RegistAspectAction=n});t(o);o.RegistAspectAction;var n=e(function(t,e){function n(e,n,r,o){return A.createMethodDecorator("Advice",function(t){n&&n(t),t.next({match:function(t){return A.isString(t)||A.isRegExp(t)},setMetadata:function(t,e){t.pointcut=e}}),r&&r(t),t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.annotationArgName=e}}),t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.annotationName=e}})},function(t){return o&&(t=o(t)),t.adviceName=e,t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createAdviceDecorator=n,e.Advice=n("Advice")});t(n);n.createAdviceDecorator,n.Advice;var i=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Aspect=A.createClassDecorator("Aspect",function(t){t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.annotation=e}}),t.next({match:function(t){return A.isArray(t)||A.isClass(t)},setMetadata:function(t,e){t.within=e}})})});t(i);i.Aspect;var c=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.After=n.createAdviceDecorator("After")});t(c);c.After;var s=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AfterReturning=n.createAdviceDecorator("AfterReturning",null,function(t){t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.returning=e}})})});t(s);s.AfterReturning;var p=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AfterThrowing=n.createAdviceDecorator("AfterThrowing",null,function(t){t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(p);p.AfterThrowing;var d=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Around=n.createAdviceDecorator("Around",null,function(t){t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.args=e}}),t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.returning=e}}),t.next({match:function(t){return A.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(d);d.Around;var f=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Before=n.createAdviceDecorator("Before")});t(f);f.Before;var v=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Pointcut=n.createAdviceDecorator("Pointcut")});t(v);v.Pointcut;var g=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NonePointcut=A.createClassDecorator("NonePointcut")});t(g);g.NonePointcut;var y=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(n,e),r.__exportStar(i,e),r.__exportStar(c,e),r.__exportStar(s,e),r.__exportStar(p,e),r.__exportStar(d,e),r.__exportStar(f,e),r.__exportStar(v,e),r.__exportStar(g,e)});t(y);var l=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isValideAspectTarget=function(t){return!(!A.isClass(t)||t===Object||t===String||t===Date||t===Boolean||t===Number||A.hasOwnClassMetadata(y.NonePointcut,t))}});t(l);l.isValideAspectTarget;var _=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorChainFactoryToken=new A.InjectToken("DI_IAdvisorChainFactory")});t(_);_.AdvisorChainFactoryToken;var h=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.JoinpointState||(e.JoinpointState={})).Before="Before",n.Pointcut="Pointcut",n.After="After",n.AfterReturning="AfterReturning",n.AfterThrowing="AfterThrowing"});t(h);h.JoinpointState;var m=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.JoinpointToken=new A.InjectToken("DI_IJoinpoint")});t(m);m.JoinpointToken;var P=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.provJoinpoint=t.provJoinpoint,this.name=t.name,this.fullName=t.fullName,this.params=t.params||[],this.args=t.args,this.returning=t.returning,this.throwing=t.throwing,this.state=t.state,this.advicer=t.advicer,this.annotations=t.annotations,this.target=t.target,this.targetType=t.targetType}return t.classAnnations={name:"Joinpoint",params:{constructor:["options"]}},r.__decorate([A.Injectable(m.JoinpointToken),y.NonePointcut(),r.__metadata("design:paramtypes",[Object])],t)}();e.Joinpoint=n});t(P);P.Joinpoint;var b=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(h,e),r.__exportStar(m,e),r.__exportStar(P,e)});t(b);var x=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorChainToken=new A.InjectToken("DI_IAdvisorChain")});t(x);x.AdvisorChainToken;var T=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e,n){this.container=t,this.advisor=e,this.advices=n}return t.prototype.getAdvicers=function(t){return(t?this.advices[t]:null)||[]},t.prototype.invoaction=function(t,e,n){switch(t.state=e,t.returning=void 0,t.throwing=void 0,e){case b.JoinpointState.Before:this.before(t);break;case b.JoinpointState.Pointcut:this.pointcut(t);break;case b.JoinpointState.After:t.returning=n,this.after(t);break;case b.JoinpointState.AfterThrowing:t.throwing=n,this.afterThrowing(t);break;case b.JoinpointState.AfterReturning:t.returning=n,this.afterReturning(t)}},t.prototype.before=function(t){var e=this,n=A.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),A.isUndefined(n.args)||(t.args=n.args),this.getAdvicers("Before").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.pointcut=function(t){var e=this,n=A.lang.assign({},t);this.getAdvicers("Pointcut").forEach(function(t){e.invokeAdvice(n,t)}),A.isUndefined(n.args)||(t.args=n.args)},t.prototype.after=function(t){var e=this,n=A.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("After").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterThrowing=function(t){var e=this,n=A.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("AfterThrowing").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterReturning=function(e){var n=this,t=A.lang.assign({},e),r=this.container.resolve(x.AdvisorChainToken,{joinPoint:t});this.getAdvicers("Around").forEach(function(e){r.next(function(t){return n.invokeAdvice(t,e)})}),this.getAdvicers("AfterReturning").forEach(function(e){r.next(function(t){return n.invokeAdvice(t,e)})}),r.next(function(t){return A.isUndefined(t.returning)||(e.returning=t.returning),e}),r.process()},t.prototype.invokeAdvice=function(r,t){var e,n=this,o=[];o.push(A.Provider.createExtends(b.Joinpoint,r,function(t,e){t._cache_JoinPoint=e.resolve(n.container)}));var i=t.advice;return!A.isUndefined(r.args)&&i.args&&o.push(A.Provider.create(i.args,r.args)),i.annotationArgName&&o.push(A.Provider.create(i.annotationArgName,function(){for(var t=r,e=t.annotations;!e&&r.provJoinpoint;)if((t=r.provJoinpoint)&&t.annotations){e=t.annotations;break}if(A.isArray(e)){if(i.annotationName){var n=i.annotationName;return n=/^@/.test(n)?n:"@"+n,e.filter(function(t){return t.decorator===n})}return e}return[]})),!A.isUndefined(r.returning)&&i.returning&&o.push(A.Provider.create(i.returning,r.returning)),!A.isUndefined(r.throwing)&&i.throwing&&o.push(A.Provider.create(i.throwing,r.throwing)),(e=this.advisor.getContainer(t.aspectType,this.container)).syncInvoke.apply(e,[t.aspectType,t.advice.propertyKey,null].concat(o))},t.classAnnations={name:"AdvisorChainFactory",params:{constructor:["container","advisor","advices"],getAdvicers:["adviceType"],invoaction:["joinPoint","state","valueOrthrowing"],before:["joinPoint"],pointcut:["joinPoint"],after:["joinPoint"],afterThrowing:["joinPoint"],afterReturning:["joinPoint"],invokeAdvice:["joinPoint","advicer"]}},r.__decorate([y.NonePointcut(),A.Injectable(_.AdvisorChainFactoryToken),r.__param(0,A.Inject(A.ContainerToken)),r.__param(1,A.Inject(u.AdvisorToken)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}();e.AdvisorChainFactory=n});t(T);T.AdvisorChainFactory;var M=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorProceedingToken=new A.InjectToken("DI_IAdvisorProceeding")});t(M);M.AdvisorProceedingToken;var k=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.joinPoint=t,this.actions=[]}return t.prototype.next=function(t){this.actions.push(t)},t.prototype.getRecognizer=function(){return this.container.get(A.RecognizerToken,this.joinPoint.state)},t.prototype.process=function(){var t,e=this.getRecognizer().recognize(this.joinPoint.returning);(t=this.container.get(M.AdvisorProceedingToken,e)).proceeding.apply(t,[this.joinPoint].concat(this.actions))},t.classAnnations={name:"AdvisorChain",params:{constructor:["joinPoint"],next:["action"],getRecognizer:[],process:[]}},r.__decorate([A.Inject(A.ContainerToken),r.__metadata("design:type",Object)],t.prototype,"container",void 0),r.__decorate([y.NonePointcut(),A.Injectable(x.AdvisorChainToken),r.__metadata("design:paramtypes",[b.Joinpoint])],t)}();e.AdvisorChain=n});t(k);k.AdvisorChain;var S=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ProxyMethodToken=new A.InjectToken("DI_IProxyMethod")});t(S);S.ProxyMethodToken;var w=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var h=b,n=function(){function t(t){this.container=t}return Object.defineProperty(t.prototype,"advisor",{get:function(){return this._advisor||(this._advisor=this.container.get(u.AdvisorToken)),this._advisor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"liefScope",{get:function(){return this._liefScope||(this._liefScope=this.container.getLifeScope()),this._liefScope},enumerable:!0,configurable:!0}),t.prototype.proceed=function(t,e,n,r){var o=this.advisor,i=n.fullName,a=n.name,c=o.getAdvices(i);if(c&&n)if(n.descriptor&&(n.descriptor.get||n.descriptor.set)){if(n.descriptor.get){var s=n.descriptor.get.bind(t);n.descriptor.get=this.proxy(s,c,t,e,n,r)}if(n.descriptor.set){var u=n.descriptor.set.bind(t);n.descriptor.set=this.proxy(u,c,t,e,n,r)}Object.defineProperty(t,a,n.descriptor)}else if(A.isFunction(t[a])){var p=t[a].bind(t);t[a]=this.proxy(p,c,t,e,n,r)}},t.prototype.proxy=function(a,c,s,u,t,p){var d=this,f=t.fullName,v=t.name,g=this.liefScope,l=this.container;return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n,r,o=d.container.resolve(h.Joinpoint,A.Provider.create("options",{name:v,fullName:f,provJoinpoint:p,annotations:p?null:g.getMethodMetadatas(u,v),params:g.getMethodParameters(u,s,v),args:t,target:s,targetType:u})),i=l.resolve(_.AdvisorChainFactoryToken,{container:l,advisor:d.advisor,advices:c});i.invoaction(o,b.JoinpointState.Before),i.invoaction(o,b.JoinpointState.Pointcut);try{n=a.apply(void 0,o.args)}catch(t){r=t}if(i.invoaction(o,b.JoinpointState.After,n),!r)return i.invoaction(o,b.JoinpointState.AfterReturning,n),o.returning;i.invoaction(o,b.JoinpointState.AfterThrowing,r)}},t.classAnnations={name:"ProxyMethod",params:{constructor:["container"],proceed:["target","targetType","pointcut","provJoinpoint"],proxy:["propertyMethod","advices","target","targetType","pointcut","provJoinpoint"]}},r.__decorate([y.NonePointcut(),A.Singleton(S.ProxyMethodToken),r.__param(0,A.Inject(A.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.ProxyMethod=n});t(w);w.ProxyMethod;var j=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.ReturningType||(e.ReturningType={})).sync="sync",n.promise="promise",n.observable="observable"});t(j);j.ReturningType;var O=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];n.returning&&t.forEach(function(e){n.returning=n.returning.then(function(t){return n.returningValue=t,Promise.resolve(e(n)).then(function(){return n.returningValue})})})},t.classAnnations={name:"AsyncPromiseProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},r.__decorate([y.NonePointcut(),A.Singleton(M.AdvisorProceedingToken,j.ReturningType.promise),r.__metadata("design:paramtypes",[])],t)}();e.AsyncPromiseProceeding=n});t(O);O.AsyncPromiseProceeding;var C=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];A.isFunction(n.returning.flatMap)?t.forEach(function(e){n.returning=n.returning.flatMap(function(t){return n.returningValue=t,e(n),A.isObservable(n.returningValue)?n.returningValue:A.isPromise(n.returningValue)?n.returningValue:Promise.resolve(n.returningValue)})}):t.forEach(function(t){t(n)})},t.classAnnations={name:"AsyncObservableProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},r.__decorate([y.NonePointcut(),A.Singleton(M.AdvisorProceedingToken,j.ReturningType.observable),r.__metadata("design:paramtypes",[])],t)}();e.AsyncObservableProceeding=n});t(C);C.AsyncObservableProceeding;var I=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.recognize=function(t){return A.isPromise(t)?j.ReturningType.promise:A.isObservable(t)?j.ReturningType.observable:j.ReturningType.sync},t.classAnnations={name:"ReturningRecognizer",params:{constructor:[],recognize:["value"]}},r.__decorate([y.NonePointcut(),A.Singleton(A.RecognizerToken,b.JoinpointState.AfterReturning),r.__metadata("design:paramtypes",[])],t)}();e.ReturningRecognizer=n});t(I);I.ReturningRecognizer;var E=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];e.returningValue=e.returning,t.forEach(function(t){t(e)})},t.classAnnations={name:"SyncProceeding",params:{proceeding:["joinPoint","actions"]}},r.__decorate([y.NonePointcut(),A.Singleton(M.AdvisorProceedingToken,j.ReturningType.sync)],t)}();e.SyncProceeding=n});t(E);E.SyncProceeding;var N=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(_,e),r.__exportStar(T,e),r.__exportStar(x,e),r.__exportStar(k,e),r.__exportStar(S,e),r.__exportStar(w,e),r.__exportStar(O,e),r.__exportStar(C,e),r.__exportStar(M,e),r.__exportStar(I,e),r.__exportStar(j,e),r.__exportStar(E,e)});t(N);var R=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,a.AopActions.bindMethodPointcut)||this}return r.__extends(e,t),e.prototype.working=function(t,e){if(e.target&&l.isValideAspectTarget(e.targetType)&&t.hasRegister(N.ProxyMethodToken.toString())){var n=t.get(N.ProxyMethodToken),r=e.target,o=e.targetType,i=A.getClassName(o),a=[],c=Object.getOwnPropertyDescriptors(o.prototype);A.lang.forIn(c,function(t,e){"constructor"!==e&&a.push({name:e,fullName:i+"."+e,descriptor:t})});var s=A.getParamerterNames(o);A.lang.forIn(s,function(t,e){"constructor"!==e&&A.isUndefined(c[e])&&a.push({name:e,fullName:i+"."+e})}),a.forEach(function(t){n.proceed(r,o,t,r._cache_JoinPoint)})}},e.classAnnations={name:"BindMethodPointcutAction",params:{constructor:[],working:["container","data"]}},e}(A.ActionComposite);e.BindMethodPointcutAction=n});t(R);R.BindMethodPointcutAction;var J=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,a.AopActions.registAspect)||this}return r.__extends(e,t),e.prototype.working=function(n,t){if(l.isValideAspectTarget(t.targetType)){var r=n.get(u.AdvisorToken),e=A.getClassName(t.targetType),o=r.getAdvices(e+".constructor");if(o){var i=t.targetType,a=t.target,c=n.resolve(b.Joinpoint,A.Provider.create("options",{name:"constructor",state:b.JoinpointState.Before,fullName:e+".constructor",target:a,args:t.args,params:t.params,targetType:i})),s=[A.Provider.create(b.Joinpoint,c)];t.providerMap&&s.push(t.providerMap),o.Before.forEach(function(t){var e;(e=r.getContainer(t.aspectType,n)).syncInvoke.apply(e,[t.aspectType,t.advice.propertyKey,null].concat(s))}),o.Around.forEach(function(t){var e;(e=r.getContainer(t.aspectType,n)).syncInvoke.apply(e,[t.aspectType,t.advice.propertyKey,null].concat(s))})}}},e.classAnnations={name:"InvokeBeforeConstructorAction",params:{constructor:[],working:["container","data"]}},e}(A.ActionComposite);e.InvokeBeforeConstructorAction=n});t(J);J.InvokeBeforeConstructorAction;var B=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,a.AopActions.invokeAfterConstructorAdvices)||this}return r.__extends(e,t),e.prototype.working=function(n,t){if(t.target&&l.isValideAspectTarget(t.targetType)){var r=n.get(u.AdvisorToken),e=A.getClassName(t.targetType),o=r.getAdvices(e+".constructor");if(o){var i=t.targetType,a=t.target,c=n.resolve(b.Joinpoint,A.Provider.create("options",{name:"constructor",state:b.JoinpointState.After,fullName:e+".constructor",target:a,args:t.args,params:t.params,targetType:i})),s=[A.Provider.create(b.Joinpoint,c)];t.providerMap&&s.push(t.providerMap),o.After.forEach(function(t){var e;(e=r.getContainer(t.aspectType,n)).syncInvoke.apply(e,[t.aspectType,t.advice.propertyKey,null].concat(s))}),o.Around.forEach(function(t){var e;(e=r.getContainer(t.aspectType,n)).syncInvoke.apply(e,[t.aspectType,t.advice.propertyKey,null].concat(s))})}}},e.classAnnations={name:"InvokeAfterConstructorAction",params:{constructor:[],working:["container","data"]}},e}(A.ActionComposite);e.InvokeAfterConstructorAction=n});t(B);B.InvokeAfterConstructorAction;var D=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdviceMatcherToken=new A.InjectToken("DI_IAdviceMatcher")});t(D);D.AdviceMatcherToken;var F=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,a.AopActions.matchPointcut)||this}return r.__extends(e,t),e.prototype.working=function(t,e){var a=this;if(l.isValideAspectTarget(e.targetType)){var c=t.get(u.AdvisorToken),n=t.get(D.AdviceMatcherToken);c.aspects.forEach(function(t,i){n.match(i,e.targetType,t,e.target).forEach(function(t){var e=t.fullName,n=t.advice,r=c.getAdvices(e);r||(r={Before:[],Pointcut:[],After:[],Around:[],AfterThrowing:[],AfterReturning:[]},c.setAdvices(e,r));var o=A.lang.assign(t,{aspectType:i});"Before"===n.adviceName?r.Before.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Before.push(o):"Pointcut"===n.adviceName?r.Pointcut.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Pointcut.push(o):"Around"===n.adviceName?r.Around.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Around.push(o):"After"===n.adviceName?r.After.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.After.push(o):"AfterThrowing"===n.adviceName?r.AfterThrowing.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.AfterThrowing.push(o):"AfterReturning"===n.adviceName&&(r.AfterReturning.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.AfterReturning.push(o))})})}},e.prototype.isAdviceEquals=function(t,e){return!(!t||!e)&&(t===e||t.adviceName===e.adviceName&&t.pointcut===e.pointcut&&t.propertyKey===e.propertyKey)},e.classAnnations={name:"MatchPointcutAction",params:{constructor:[],working:["container","data"],isAdviceEquals:["advice1","advice2"]}},e}(A.ActionComposite);e.MatchPointcutAction=n});t(F);F.MatchPointcutAction;var V=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.create=function(t){var e;switch(t){case a.AopActions.registAspect:e=new o.RegistAspectAction;break;case a.AopActions.matchPointcut:e=new q.MatchPointcutAction;break;case a.AopActions.invokeBeforeConstructorAdvices:e=new q.InvokeBeforeConstructorAction;break;case a.AopActions.invokeAfterConstructorAdvices:e=new q.InvokeAfterConstructorAction;break;case a.AopActions.bindMethodPointcut:e=new q.BindMethodPointcutAction;break;case a.AopActions.exetndsInstance:e=new q.ExetndsInstanceAction}return e},t.classAnnations={name:"AopActionFactory",params:{create:["type"]}},t}();e.AopActionFactory=n});t(V);V.AopActionFactory;var z=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,a.AopActions.registAspect)||this}return r.__extends(e,t),e.prototype.working=function(t,e){!e.target||!e.providers||e.providers.length<1||e.providers.forEach(function(t){t&&t instanceof A.ExtendsProvider&&t.extends(e.target)})},e.classAnnations={name:"ExetndsInstanceAction",params:{constructor:[],working:["container","data"]}},e}(A.ActionComposite);e.ExetndsInstanceAction=n});t(z);z.ExetndsInstanceAction;var q=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(a,e),r.__exportStar(o,e),r.__exportStar(R,e),r.__exportStar(J,e),r.__exportStar(B,e),r.__exportStar(F,e),r.__exportStar(V,e),r.__exportStar(z,e)});t(q);var K=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this.aspects=new A.MapSet,this.aspectIocs=new A.MapSet,this.advices=new A.MapSet}return t.prototype.setAdvices=function(t,e){this.advices.has(t)||this.advices.set(t,e)},t.prototype.getAdvices=function(t){return this.advices.has(t)?this.advices.get(t):null},t.prototype.hasRegisterAdvices=function(t){var e=this,n=A.lang.keys(Object.getOwnPropertyDescriptors(t.prototype)),r=A.getClassName(t);return n.some(function(t){return e.advices.has(r+"."+t)})},t.prototype.add=function(t,e){if(!this.aspects.has(t)){var n=A.getOwnMethodMetadata(y.Advice,t);this.aspects.set(t,n),this.aspectIocs.set(t,e)}},t.prototype.getContainer=function(t,e){return this.aspectIocs.has(t)&&this.aspectIocs.get(t)||e},t.prototype.resolve=function(t){for(var e,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return this.aspectIocs.has(t)?(e=this.aspectIocs.get(t)).resolve.apply(e,[t].concat(n)):null},t.classAnnations={name:"Advisor",params:{constructor:[],setAdvices:["key","advices"],getAdvices:["key"],hasRegisterAdvices:["targetType"],add:["aspect","raiseContainer"],getContainer:["aspect","defaultContainer"],resolve:["aspect","providers"]}},r.__decorate([y.NonePointcut(),A.Singleton(u.AdvisorToken),r.__metadata("design:paramtypes",[])],t)}();e.Advisor=n});t(K);K.Advisor;var L=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.match=function(t,e,n,r){var o=this,i=A.lang.first(A.getOwnTypeMetadata(y.Aspect,t));if(i){if(i.within&&(A.isArray(i.within)?i.within:[i.within]).indexOf(e)<0)return[];if(i.annotation){var a=A.isFunction(i.annotation)?i.annotation.toString():i.annotation,c=(/^\^?@\w+/.test(a)?"":"@")+a;if(!A.hasOwnClassMetadata(c,e))return[]}}var s=A.getClassName(e);n=n||A.getOwnMethodMetadata(y.Advice,e);var u=[];if(e===t){var p=A.lang.keys(n);if(1<p.length){var d=[];p.forEach(function(t){d=d.concat(n[t])}),p.forEach(function(e){d.forEach(function(t){t.propertyKey!==e&&o.matchAspectSelf(e,t)&&u.push({name:e,fullName:s+"."+e,advice:t})})})}}else{var f=[],v=Object.getOwnPropertyDescriptors(e.prototype);for(var g in v)f.push({name:g,fullName:s+"."+g});var l=A.getParamerterNames(e);A.lang.forIn(l,function(t,e){"constructor"!==e&&A.isUndefined(v[e])&&f.push({name:e,fullName:s+"."+e})}),Object.getOwnPropertyNames(n).forEach(function(t){n[t].forEach(function(t){u=u.concat(o.filterPointcut(e,f,t))})})}return u},t.prototype.matchAspectSelf=function(t,e){if(e.pointcut){var n=e.pointcut;if(A.isString(n))return/^execution\(\S+\)$/.test(n)&&(n=n.substring(10,n.length-1)),n.startsWith(t);if(A.isRegExp(n))return n.test(t)}return!1},t.prototype.filterPointcut=function(e,t,n,r){if(!n.pointcut)return[];var o;if(n.pointcut){var i=this.matchTypeFactory(e,n);o=t.filter(function(t){return i(t.name,t.fullName,e,r,t)})}return(o=o||[]).map(function(t){return A.lang.assign({},t,{advice:n})})},t.prototype.matchTypeFactory=function(r,o){var t=o.pointcut,e=[];if(o.within&&(e.push(function(t,e,n){return A.isArray(o.within)?0<=o.within.indexOf(n):o.within===n}),e.push("&&")),o.target&&(e.push(function(t,e,n,r){return o.target=r}),e.push("&&")),o.annotation&&(e.push(function(t,e,n,r){return A.hasOwnMethodMetadata(o.annotation,n,t)}),e.push("&&")),A.isString(t)){var n=(t||"").trim();e.push(this.tranlateExpress(r,n))}else if(A.isRegExp(t)){var i=t;/^\^?@\w+/.test(i.source)?e.push(function(t,e,n){return Reflect.getMetadataKeys(r,t).some(function(t){return A.isString(t)&&i.test(t)})}):e.push(function(t,e){return i.test(e)})}return this.mergeExpress.apply(this,e)},t.prototype.spiltBrace=function(t){return t=t.trim(),/^\(/.test(t)&&/\)$/.test(t)&&(t=t.substring(1,t.length-1).trim()),/^\(/.test(t)&&/\)$/.test(t)?this.spiltBrace(t):t},t.prototype.expressToFunc=function(n,t){var r=this;if(/^@annotation\(.*\)$/.test(t)){var e=t.substring(12,t.length-1),o=/^@/.test(e)?e:"@"+e;return function(t,e){return A.hasOwnMethodMetadata(o,n,t)&&!A.hasOwnClassMetadata(y.Aspect,n)}}if(/^execution\(.*\)$/.test(t)){if("*"===(e=t.substring(10,t.length-1))||"*.*"===e)return function(t,e){return!!t&&!A.hasOwnClassMetadata(y.Aspect,n)};if(/^\w+(\((\s*\w+\s*,)*\s*\w*\))?$/.test(e))return function(){return!1};if(/^([\w\*]+\.)+[\w\*]+(\((\s*\w+\s*,)*\s*\w*\))?$/.test(e)){e=e.replace(/\*\*/gi,"(\\w+(\\.|\\/)){0,}\\w+").replace(/\*/gi,"\\w+").replace(/\./gi,"\\.").replace(/\//gi,"\\/");var i=new RegExp(e+"$");return function(t,e){return i.test(e)}}return function(){return!1}}if(/^@within\(\s*\w+/.test(t)){var a=t.substring(t.indexOf("(")+1,t.length-1).split(",").map(function(t){return t.trim()});return function(t,e,n){return 0<=a.indexOf(A.getClassName(n))}}if(/^@target\(\s*\w+/.test(t)){var c=t.substring(t.indexOf("(")+1,t.length-1).trim();return function(t,e,n){return r.container.getTokenImpl(c)===n}}return function(){return!1}},t.prototype.tranlateExpress=function(t,e){var n=[],r=e.indexOf("||"),o=e.indexOf("&&");if(o<0&&r<0)n.push(this.expressToFunc(t,this.spiltBrace(e)));else if(o<r)(i=this.spiltBrace(e.substring(0,r)))&&n.push(this.tranlateExpress(t,i)),(a=this.spiltBrace(e.substring(r+2)))&&(n.push("||"),n.push(this.tranlateExpress(t,a)));else if(r<o){var i,a;(i=this.spiltBrace(e.substring(0,o)))&&n.push(this.tranlateExpress(t,i)),(a=this.spiltBrace(e.substring(o+2)))&&(n.push("&&"),n.push(this.tranlateExpress(t,a)))}return this.mergeExpress.apply(this,n)},t.prototype.mergeExpress=function(){for(var s=[],t=0;t<arguments.length;t++)s[t]=arguments[t];return function(r,o,i,a){var c;return s.forEach(function(t,e){if(A.isUndefined(c)&&A.isFunction(t)){var n=t(r,o,i,a);e<s.length-2?(n||"&&"!==t[e+1]||(c=!1),n&&"||"===t[e+1]&&(c=!0)):c=n}}),c}},t.classAnnations={name:"AdviceMatcher",params:{constructor:["container"],match:["aspectType","targetType","adviceMetas","target"],matchAspectSelf:["name","metadata"],filterPointcut:["type","points","metadata","target"],matchTypeFactory:["type","metadata"],spiltBrace:["strExp"],expressToFunc:["type","strExp"],tranlateExpress:["type","strExp"],mergeExpress:["expresses"]}},r.__decorate([y.NonePointcut(),A.Singleton(D.AdviceMatcherToken),r.__param(0,A.Inject(A.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.AdviceMatcher=n});t(L);L.AdviceMatcher;var U=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container;t.register(b.Joinpoint),t.register(N.AdvisorChainFactory),t.register(N.ReturningRecognizer),t.register(N.SyncProceeding),t.register(N.AsyncPromiseProceeding),t.register(N.AsyncObservableProceeding),t.register(N.AdvisorChain),t.register(N.ProxyMethod),t.register(K.Advisor),t.register(L.AdviceMatcher);var e=t.get(A.LifeScopeToken),n=new V.AopActionFactory;e.addAction(n.create(q.AopActions.registAspect),A.IocState.design),e.addAction(n.create(q.AopActions.matchPointcut),A.IocState.runtime,A.LifeState.beforeConstructor),e.addAction(n.create(q.AopActions.bindMethodPointcut),A.IocState.runtime,A.LifeState.AfterInit),e.addAction(n.create(q.AopActions.invokeBeforeConstructorAdvices),A.IocState.runtime,A.LifeState.beforeConstructor),e.addAction(n.create(q.AopActions.exetndsInstance),A.IocState.runtime,A.LifeState.onInit,A.LifeState.afterConstructor),e.addAction(n.create(q.AopActions.invokeAfterConstructorAdvices),A.IocState.runtime,A.LifeState.afterConstructor),e.registerDecorator(y.Aspect,q.AopActions.registAspect,q.AopActions.exetndsInstance)},t.classAnnations={name:"AopModule",params:{constructor:["container"],setup:[]}},r.__decorate([A.IocExt("setup"),r.__param(0,A.Inject(A.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.AopModule=n});t(U);U.AopModule;return t(e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(q,e),r.__exportStar(y,e),r.__exportStar(b,e),r.__exportStar(N,e),r.__exportStar(u,e),r.__exportStar(K,e),r.__exportStar(L,e),r.__exportStar(l,e),r.__exportStar(U,e)}))});