!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["@ts-ioc/core"],e):(t.aop=t.aop||{},t.aop.umd=t.aop.umd||{},t.aop.umd.js=e(t["@ts-ioc/core"]))}(this,function(h){"use strict";function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}h=h&&h.hasOwnProperty("default")?h.default:h;var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};var n=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t};function o(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function i(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function f(t){return this instanceof f?(this.v=t,this):new f(t)}var a=Object.freeze({__extends:function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__assign:n,__rest:function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&(n[r[o]]=t[r[o]])}return n},__decorate:function(t,e,n,r){var o,i=arguments.length,a=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var c=t.length-1;0<=c;c--)(o=t[c])&&(a=(i<3?o(a):3<i?o(e,n,a):o(e,n))||a);return 3<i&&a&&Object.defineProperty(e,n,a),a},__param:function(n,r){return function(t,e){r(t,e,n)}},__metadata:function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__awaiter:function(i,a,c,s){return new(c||(c=Promise))(function(t,e){function n(t){try{o(s.next(t))}catch(t){e(t)}}function r(t){try{o(s.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new c(function(t){t(e.value)}).then(n,r)}o((s=s.apply(i,a||[])).next())})},__generator:function(n,r){var o,i,a,t,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(a=i[2&e[0]?"return":e[0]?"throw":"next"])&&!(a=a.call(i,e[1])).done)return a;switch(i=0,a&&(e=[0,a.value]),e[0]){case 0:case 1:a=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,i=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){c.label=e[1];break}if(6===e[0]&&c.label<a[1]){c.label=a[1],a=e;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(e);break}a[2]&&c.ops.pop(),c.trys.pop();continue}e=r.call(n,c)}catch(t){e=[6,t],i=0}finally{o=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},__exportStar:function(t,e){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])},__values:o,__read:i,__spread:function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(i(arguments[e]));return t},__await:f,__asyncGenerator:function(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o,i=n.apply(t,e||[]),a=[];return o={},r("next"),r("throw"),r("return"),o[Symbol.asyncIterator]=function(){return this},o;function r(r){i[r]&&(o[r]=function(n){return new Promise(function(t,e){1<a.push([r,n,t,e])||c(r,n)})})}function c(t,e){try{(n=i[t](e)).value instanceof f?Promise.resolve(n.value.v).then(s,u):p(a[0][2],n)}catch(t){p(a[0][3],t)}var n}function s(t){c("next",t)}function u(t){c("throw",t)}function p(t,e){t(e),a.shift(),a.length&&c(a[0][0],a[0][1])}},__asyncDelegator:function(r){var t,o;return t={},e("next"),e("throw",function(t){throw t}),e("return"),t[Symbol.iterator]=function(){return this},t;function e(e,n){r[e]&&(t[e]=function(t){return(o=!o)?{value:f(r[e](t)),done:"return"===e}:n?n(t):t})}},__asyncValues:function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator];return e?e.call(t):o(t)},__makeTemplateObject:function(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t},__importStar:function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e},__importDefault:function(t){return t&&t.__esModule?t:{default:t}}}),c=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.AopActions||(e.AopActions={})).registAspect="registAspect",n.exetndsInstance="exetndsInstance",n.matchPointcut="matchPointcut",n.bindPropertyPointcut="bindPropertyPointcut",n.bindMethodPointcut="bindMethodPointcut",n.invokeBeforeConstructorAdvices="invokeBeforeConstructorAdvices",n.invokeAfterConstructorAdvices="invokeAfterConstructorAdvices"});t(c);c.AopActions;var v=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorToken=new h.InjectToken("__IOC_IAdvisor")});t(v);v.AdvisorToken;var s=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,c.AopActions.registAspect)||this}return a.__extends(e,t),e.prototype.working=function(t,e){var n=e.targetType,r=(e.propertyKey,t.getLifeScope().getClassDecorators(function(t){return t.actions.includes(c.AopActions.registAspect)&&h.hasOwnClassMetadata(t.name,n)})),o=t.get(v.AdvisorToken);r.forEach(function(t){var e=h.getOwnTypeMetadata(t.name,n);Array.isArray(e)&&0<e.length&&e.forEach(function(t){h.isClass(t.type)&&o.add(t.type)})})},e.classAnnations={name:"RegistAspectAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.RegistAspectAction=n});t(s);s.RegistAspectAction;var u=e(function(t,e){function n(e,n,r,o){return h.createMethodDecorator("Advice",function(t){n&&n(t),t.next({isMetadata:function(t){return h.isClassMetadata(t,["pointcut"])},match:function(t){return h.isString(t)||h.isRegExp(t)},setMetadata:function(t,e){t.pointcut=e}}),r&&r(t),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotationArgName=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotation=e}})},function(t){return o&&(t=o(t)),t.adviceName=e,t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createAdviceDecorator=n,e.Advice=n("Advice")});t(u);u.createAdviceDecorator,u.Advice;var p=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Aspect=h.createClassDecorator("Aspect")});t(p);p.Aspect;var d=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.After=u.createAdviceDecorator("After")});t(d);d.After;var l=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AfterReturning=u.createAdviceDecorator("AfterReturning",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.returning=e}})})});t(l);l.AfterReturning;var g=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AfterThrowing=u.createAdviceDecorator("AfterThrowing",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(g);g.AfterThrowing;var A=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Around=u.createAdviceDecorator("Around",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.args=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.returning=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(A);A.Around;var _=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Before=u.createAdviceDecorator("Before")});t(_);_.Before;var y=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Pointcut=u.createAdviceDecorator("Pointcut")});t(y);y.Pointcut;var m=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NonePointcut=h.createClassDecorator("NonePointcut")});t(m);m.NonePointcut;var P=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),a.__exportStar(u,e),a.__exportStar(p,e),a.__exportStar(d,e),a.__exportStar(l,e),a.__exportStar(g,e),a.__exportStar(A,e),a.__exportStar(_,e),a.__exportStar(y,e),a.__exportStar(m,e)});t(P);var b=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isValideAspectTarget=function(t){return!(!h.isClass(t)||t===Object||t===String||t===Date||t===Boolean||t===Number||h.hasOwnClassMetadata(P.NonePointcut,t))}});t(b);b.isValideAspectTarget;var S=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorChainFactoryToken=new h.InjectToken("__IOC_IAdvisorChainFactory")});t(S);S.AdvisorChainFactoryToken;var M=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.JoinpointState||(e.JoinpointState={})).Before="Before",n.Pointcut="Pointcut",n.After="After",n.AfterReturning="AfterReturning",n.AfterThrowing="AfterThrowing"});t(M);M.JoinpointState;var T=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.JoinpointToken=new h.InjectToken("__IOC_IJoinpoint")});t(T);T.JoinpointToken;var k=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.provJoinpoint=t.provJoinpoint,this.name=t.name,this.fullName=t.fullName,this.params=t.params||[],this.args=t.args,this.returning=t.returning,this.throwing=t.throwing,this.state=t.state,this.advicer=t.advicer,this.annotations=t.annotations,this.target=t.target,this.targetType=t.targetType}return t.classAnnations={name:"Joinpoint",params:{constructor:["options"]}},t=a.__decorate([h.Injectable(T.JoinpointToken),P.NonePointcut(),a.__metadata("design:paramtypes",[Object])],t)}();e.Joinpoint=n});t(k);k.Joinpoint;var O=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),a.__exportStar(M,e),a.__exportStar(T,e),a.__exportStar(k,e)});t(O);var x=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorChainToken=new h.InjectToken("__IOC_IAdvisorChain")});t(x);x.AdvisorChainToken;var j=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){this.container=t,this.advices=e}return t.prototype.getAdvicers=function(t){return(t?this.advices[t]:null)||[]},t.prototype.invoaction=function(t,e,n){switch(t.state=e,t.returning=void 0,t.throwing=void 0,e){case O.JoinpointState.Before:this.before(t);break;case O.JoinpointState.Pointcut:this.pointcut(t);break;case O.JoinpointState.After:t.returning=n,this.after(t);break;case O.JoinpointState.AfterThrowing:t.throwing=n,this.afterThrowing(t);break;case O.JoinpointState.AfterReturning:t.returning=n,this.afterReturning(t)}},t.prototype.before=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),h.isUndefined(n.args)||(t.args=n.args),this.getAdvicers("Before").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.pointcut=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Pointcut").forEach(function(t){e.invokeAdvice(n,t)}),h.isUndefined(n.args)||(t.args=n.args)},t.prototype.after=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("After").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterThrowing=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("AfterThrowing").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterReturning=function(e){var n=this,t=h.lang.assign({},e),r=this.container.resolve(x.AdvisorChainToken,{joinPoint:t});this.getAdvicers("Around").forEach(function(e){r.next(function(t){return n.invokeAdvice(t,e)})}),this.getAdvicers("AfterReturning").forEach(function(e){r.next(function(t){return n.invokeAdvice(t,e)})}),r.next(function(t){return h.isUndefined(t.returning)||(e.returning=t.returning),e}),r.process()},t.prototype.invokeAdvice=function(r,t){var n=this,e=[];e.push(h.Provider.createExtends(O.Joinpoint,r,function(t,e){t._cache_JoinPoint=e.resolve(n.container)}));var o,i=t.advice;return!h.isUndefined(r.args)&&i.args&&e.push(h.Provider.create(i.args,r.args)),i.annotationArgName&&e.push(h.Provider.create(i.annotationArgName,function(){for(var t=r,e=t.annotations;!e&&r.provJoinpoint;)if((t=r.provJoinpoint)&&t.annotations){e=t.annotations;break}if(h.isArray(e)){if(i.annotation){var n=i.annotation;return n=/^@/.test(n)?n:"@"+n,e.filter(function(t){return t.decorator===n})}return e}return[]})),!h.isUndefined(r.returning)&&i.returning&&e.push(h.Provider.create(i.returning,r.returning)),!h.isUndefined(r.throwing)&&i.throwing&&e.push(h.Provider.create(i.throwing,r.throwing)),(o=this.container).syncInvoke.apply(o,[t.aspectType,t.advice.propertyKey,null].concat(e))},t.classAnnations={name:"AdvisorChainFactory",params:{constructor:["container","advices"],getAdvicers:["adviceType"],invoaction:["joinPoint","state","valueOrthrowing"],before:["joinPoint"],pointcut:["joinPoint"],after:["joinPoint"],afterThrowing:["joinPoint"],afterReturning:["joinPoint"],invokeAdvice:["joinPoint","advicer"]}},t=a.__decorate([P.NonePointcut(),h.Injectable(S.AdvisorChainFactoryToken),a.__param(0,h.Inject(h.ContainerToken)),a.__metadata("design:paramtypes",[Object,Object])],t)}();e.AdvisorChainFactory=n});t(j);j.AdvisorChainFactory;var w=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorProceedingToken=new h.InjectToken("__IOC_IAdvisorProceeding")});t(w);w.AdvisorProceedingToken;var C=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.joinPoint=t,this.actions=[]}return t.prototype.next=function(t){this.actions.push(t)},t.prototype.getRecognizer=function(){return this.container.get(h.RecognizerToken,this.joinPoint.state)},t.prototype.process=function(){var t,e=this.getRecognizer().recognize(this.joinPoint.returning);(t=this.container.get(w.AdvisorProceedingToken,e)).proceeding.apply(t,[this.joinPoint].concat(this.actions))},t.classAnnations={name:"AdvisorChain",params:{constructor:["joinPoint"],next:["action"],getRecognizer:[],process:[]}},a.__decorate([h.Inject(h.ContainerToken),a.__metadata("design:type",Object)],t.prototype,"container",void 0),t=a.__decorate([P.NonePointcut(),h.Injectable(x.AdvisorChainToken),a.__metadata("design:paramtypes",[O.Joinpoint])],t)}();e.AdvisorChain=n});t(C);C.AdvisorChain;var I=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ProxyMethodToken=new h.InjectToken("__IOC_IProxyMethod")});t(I);I.ProxyMethodToken;var R=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var A=O,n=function(){function t(t){this.container=t}return Object.defineProperty(t.prototype,"aspectMgr",{get:function(){return this._aspectMgr||(this._aspectMgr=this.container.get(v.AdvisorToken)),this._aspectMgr},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"liefScope",{get:function(){return this._liefScope||(this._liefScope=this.container.getLifeScope()),this._liefScope},enumerable:!0,configurable:!0}),t.prototype.proceed=function(t,e,n,r){var o=this.aspectMgr,i=n.fullName,a=n.name,c=o.getAdvices(i);if(c&&n)if(n.descriptor&&(n.descriptor.get||n.descriptor.set)){if(n.descriptor.get){var s=n.descriptor.get.bind(t);n.descriptor.get=this.proxy(s,c,t,e,n,r)}if(n.descriptor.set){var u=n.descriptor.set.bind(t);n.descriptor.set=this.proxy(u,c,t,e,n,r)}Object.defineProperty(t,a,n.descriptor)}else if(h.isFunction(t[a])){var p=t[a].bind(t);t[a]=this.proxy(p,c,t,e,n,r)}},t.prototype.proxy=function(a,c,s,u,t,p){var f=this,d=(this.aspectMgr,t.fullName),v=t.name,l=this.liefScope,g=this.container;return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n,r,o=f.container.resolve(A.Joinpoint,h.Provider.create("options",{name:v,fullName:d,provJoinpoint:p,annotations:p?null:l.getMethodMetadatas(u,v),params:l.getMethodParameters(u,s,v),args:t,target:s,targetType:u})),i=g.resolve(S.AdvisorChainFactoryToken,{container:g,advices:c});i.invoaction(o,O.JoinpointState.Before),i.invoaction(o,O.JoinpointState.Pointcut);try{n=a.apply(void 0,o.args)}catch(t){r=t}if(i.invoaction(o,O.JoinpointState.After,n),!r)return i.invoaction(o,O.JoinpointState.AfterReturning,n),o.returning;i.invoaction(o,O.JoinpointState.AfterThrowing,r)}},t.classAnnations={name:"ProxyMethod",params:{constructor:["container"],proceed:["target","targetType","pointcut","provJoinpoint"],proxy:["propertyMethod","advices","target","targetType","pointcut","provJoinpoint"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(I.ProxyMethodToken),a.__param(0,h.Inject(h.ContainerToken)),a.__metadata("design:paramtypes",[Object])],t)}();e.ProxyMethod=n});t(R);R.ProxyMethod;var E=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.ReturningType||(e.ReturningType={})).sync="sync",n.promise="promise",n.observable="observable"});t(E);E.ReturningType;var N=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];n.returning&&t.forEach(function(e){n.returning=n.returning.then(function(t){return n.returningValue=t,Promise.resolve(e(n)).then(function(){return n.returningValue})})})},t.classAnnations={name:"AsyncPromiseProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(w.AdvisorProceedingToken,E.ReturningType.promise),a.__metadata("design:paramtypes",[])],t)}();e.AsyncPromiseProceeding=n});t(N);N.AsyncPromiseProceeding;var J=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];h.isFunction(n.returning.flatMap)?t.forEach(function(e){n.returning=n.returning.flatMap(function(t){return n.returningValue=t,e(n),h.isObservable(n.returningValue)?n.returningValue:h.isPromise(n.returningValue)?n.returningValue:Promise.resolve(n.returningValue)})}):t.forEach(function(t){t(n)})},t.classAnnations={name:"AsyncObservableProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(w.AdvisorProceedingToken,E.ReturningType.observable),a.__metadata("design:paramtypes",[])],t)}();e.AsyncObservableProceeding=n});t(J);J.AsyncObservableProceeding;var B=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.recognize=function(t){return h.isPromise(t)?E.ReturningType.promise:h.isObservable(t)?E.ReturningType.observable:E.ReturningType.sync},t.classAnnations={name:"ReturningRecognizer",params:{constructor:[],recognize:["value"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(h.RecognizerToken,O.JoinpointState.AfterReturning),a.__metadata("design:paramtypes",[])],t)}();e.ReturningRecognizer=n});t(B);B.ReturningRecognizer;var D=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];e.returningValue=e.returning,t.forEach(function(t){t(e)})},t.classAnnations={name:"SyncProceeding",params:{proceeding:["joinPoint","actions"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(w.AdvisorProceedingToken,E.ReturningType.sync)],t)}();e.SyncProceeding=n});t(D);D.SyncProceeding;var F=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),a.__exportStar(S,e),a.__exportStar(j,e),a.__exportStar(x,e),a.__exportStar(C,e),a.__exportStar(I,e),a.__exportStar(R,e),a.__exportStar(N,e),a.__exportStar(J,e),a.__exportStar(w,e),a.__exportStar(B,e),a.__exportStar(E,e),a.__exportStar(D,e)});t(F);var V=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,c.AopActions.bindMethodPointcut)||this}return a.__extends(e,t),e.prototype.working=function(t,e){if(e.target&&b.isValideAspectTarget(e.targetType)){var n=t.get(F.ProxyMethodToken),r=e.target,o=e.targetType,i=h.getClassName(o),a=[],c=Object.getOwnPropertyDescriptors(o.prototype);h.lang.forIn(c,function(t,e){"constructor"!==e&&a.push({name:e,fullName:i+"."+e,descriptor:t})});var s=h.getParamerterNames(o);h.lang.forIn(s,function(t,e){"constructor"!==e&&h.isUndefined(c[e])&&a.push({name:e,fullName:i+"."+e})}),a.forEach(function(t){n.proceed(r,o,t,r._cache_JoinPoint)})}},e.classAnnations={name:"BindMethodPointcutAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.BindMethodPointcutAction=n});t(V);V.BindMethodPointcutAction;var z=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,c.AopActions.registAspect)||this}return a.__extends(e,t),e.prototype.working=function(t,e){if(b.isValideAspectTarget(e.targetType)){var n=t.get(v.AdvisorToken),r=h.getClassName(e.targetType),o=n.getAdvices(r+".constructor");if(o){var i=e.targetType,a=e.target,c=t.resolve(O.Joinpoint,h.Provider.create("options",{name:"constructor",state:O.JoinpointState.Before,fullName:r+".constructor",target:a,args:e.args,params:e.params,targetType:i})),s=[h.Provider.create(O.Joinpoint,c)],u=t.get(h.MethodAccessorToken);o.Before.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))}),o.Around.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))})}}},e.classAnnations={name:"InvokeBeforeConstructorAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.InvokeBeforeConstructorAction=n});t(z);z.InvokeBeforeConstructorAction;var K=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,c.AopActions.invokeAfterConstructorAdvices)||this}return a.__extends(e,t),e.prototype.working=function(t,e){if(e.target&&b.isValideAspectTarget(e.targetType)){var n=t.get(v.AdvisorToken),r=h.getClassName(e.targetType),o=n.getAdvices(r+".constructor");if(o){var i=e.targetType,a=e.target,c=t.resolve(O.Joinpoint,h.Provider.create("options",{name:"constructor",state:O.JoinpointState.After,fullName:r+".constructor",target:a,args:e.args,params:e.params,targetType:i})),s=[h.Provider.create(O.Joinpoint,c)],u=t.get(h.MethodAccessorToken);o.After.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))}),o.Around.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))})}}},e.classAnnations={name:"InvokeAfterConstructorAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.InvokeAfterConstructorAction=n});t(K);K.InvokeAfterConstructorAction;var q=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdviceMatcherToken=new h.InjectToken("__IOC_IAdviceMatcher")});t(q);q.AdviceMatcherToken;var L=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,c.AopActions.matchPointcut)||this}return a.__extends(e,t),e.prototype.working=function(t,e){var a=this;if(b.isValideAspectTarget(e.targetType)){var c=t.get(v.AdvisorToken),n=t.get(q.AdviceMatcherToken);c.aspects.forEach(function(t,i){n.match(i,e.targetType,t).forEach(function(t){var e=t.fullName,n=t.advice,r=c.getAdvices(e);r||(r={Before:[],Pointcut:[],After:[],Around:[],AfterThrowing:[],AfterReturning:[]},c.setAdvices(e,r));var o=h.lang.assign(t,{aspectType:i});"Before"===n.adviceName?r.Before.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Before.push(o):"Pointcut"===n.adviceName?r.Pointcut.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Pointcut.push(o):"Around"===n.adviceName?r.Around.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Around.push(o):"After"===n.adviceName?r.After.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.After.push(o):"AfterThrowing"===n.adviceName?r.AfterThrowing.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.AfterThrowing.push(o):"AfterReturning"===n.adviceName&&(r.AfterReturning.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.AfterReturning.push(o))})})}},e.prototype.isAdviceEquals=function(t,e){return!(!t||!e)&&(t===e||t.adviceName===e.adviceName&&t.pointcut===e.pointcut&&t.propertyKey===e.propertyKey)},e.classAnnations={name:"MatchPointcutAction",params:{constructor:[],working:["container","data"],isAdviceEquals:["advice1","advice2"]}},e}(h.ActionComposite);e.MatchPointcutAction=n});t(L);L.MatchPointcutAction;var U=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.create=function(t){var e;switch(t){case c.AopActions.registAspect:e=new s.RegistAspectAction;break;case c.AopActions.matchPointcut:e=new G.MatchPointcutAction;break;case c.AopActions.invokeBeforeConstructorAdvices:e=new G.InvokeBeforeConstructorAction;break;case c.AopActions.invokeAfterConstructorAdvices:e=new G.InvokeAfterConstructorAction;break;case c.AopActions.bindMethodPointcut:e=new G.BindMethodPointcutAction;break;case c.AopActions.exetndsInstance:e=new G.ExetndsInstanceAction}return e},t.classAnnations={name:"AopActionFactory",params:{create:["type"]}},t}();e.AopActionFactory=n});t(U);U.AopActionFactory;var $=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,c.AopActions.registAspect)||this}return a.__extends(e,t),e.prototype.working=function(t,e){!e.target||!e.providers||e.providers.length<1||e.providers.forEach(function(t){t&&t instanceof h.ExtendsProvider&&t.extends(e.target)})},e.classAnnations={name:"ExetndsInstanceAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.ExetndsInstanceAction=n});t($);$.ExetndsInstanceAction;var G=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),a.__exportStar(c,e),a.__exportStar(s,e),a.__exportStar(V,e),a.__exportStar(z,e),a.__exportStar(K,e),a.__exportStar(L,e),a.__exportStar(U,e),a.__exportStar($,e)});t(G);var H=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t,this.aspects=new h.MapSet,this.advices=new h.MapSet}return t.prototype.setAdvices=function(t,e){this.advices.has(t)||this.advices.set(t,e)},t.prototype.getAdvices=function(t){return this.advices.has(t)?this.advices.get(t):null},t.prototype.hasRegisterAdvices=function(t){var e=this,n=h.lang.keys(Object.getOwnPropertyDescriptors(t.prototype)),r=h.getClassName(t);return n.some(function(t){return e.advices.has(r+"."+t)})},t.prototype.add=function(t){if(!this.aspects.has(t)){var e=h.getOwnMethodMetadata(P.Advice,t);this.aspects.set(t,e)}},t.classAnnations={name:"Advisor",params:{constructor:["container"],setAdvices:["key","advices"],getAdvices:["key"],hasRegisterAdvices:["targetType"],add:["aspect"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(v.AdvisorToken),a.__param(0,h.Inject(h.ContainerToken)),a.__metadata("design:paramtypes",[Object])],t)}();e.Advisor=n});t(H);H.Advisor;var Q=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.match=function(t,e,n,r){var o=this,i=h.getClassName(e);n=n||h.getOwnMethodMetadata(P.Advice,e);this.container.get(v.AdvisorToken);var a=[];if(e===t){var c=h.lang.keys(n);if(1<c.length){var s=[];c.forEach(function(t){s=s.concat(n[t])}),c.forEach(function(e){s.forEach(function(t){t.propertyKey!==e&&o.matchAspectSelf(e,t)&&a.push({name:e,fullName:i+"."+e,advice:t})})})}}else{var u=[],p=Object.getOwnPropertyDescriptors(e.prototype);for(var f in p)u.push({name:f,fullName:i+"."+f});var d=h.getParamerterNames(e);h.lang.forIn(d,function(t,e){"constructor"!==e&&h.isUndefined(p[e])&&u.push({name:e,fullName:i+"."+e})}),Object.getOwnPropertyNames(n).forEach(function(t){n[t].forEach(function(t){a=a.concat(o.filterPointcut(e,u,t))})})}return a},t.prototype.matchAspectSelf=function(t,e){if(e.pointcut){var n=e.pointcut;if(h.isString(n)){if(/^execution\(\S+\)$/.test(n))return(n=n.substring(10,n.length-1))===t}else if(h.isRegExp(n))return n.test(t)}return!1},t.prototype.filterPointcut=function(t,e,n){if(!n.pointcut)return[];var r;if(n.pointcut){var o=this.matchTypeFactory(t,n.pointcut);r=e.filter(function(t){return o(t.name,t.fullName,t)})}return(r=r||[]).map(function(t){return h.lang.assign({},t,{advice:n})})},t.prototype.matchTypeFactory=function(r,t){if(h.isString(t)){if(t=(t||"").trim(),/^@annotation\(\S+\)$/.test(t)){t=t.substring(12,t.length-1);var n=/^@/.test(t)?t:"@"+t;return function(t,e){return h.hasOwnMethodMetadata(n,r,t)&&!h.hasOwnClassMetadata(P.Aspect,r)}}if(/^execution\(\S+\)$/.test(t)&&(t=t.substring(10,t.length-1)),"*"===t||"*.*"===t)return function(t,e,n){return!!t&&!h.hasOwnClassMetadata(P.Aspect,r)};t=t.replace(/\*\*/gi,"(\\w+(\\.|\\/)){0,}\\w+").replace(/\*/gi,"\\w+").replace(/\./gi,"\\.").replace(/\//gi,"\\/");var o=new RegExp(t+"$");return function(t,e,n){return o.test(e)}}if(h.isRegExp(t)){var i=t;return/^\^?@\w+/.test(i.source)?function(t,e,n){return Reflect.getMetadataKeys(r,t).some(function(t){return h.isString(t)&&i.test(t)})}:function(t,e,n){return i.test(e)}}return null},t.classAnnations={name:"AdviceMatcher",params:{constructor:["container"],match:["aspectType","targetType","adviceMetas","instance"],matchAspectSelf:["name","metadata"],filterPointcut:["type","points","metadata"],matchTypeFactory:["type","pointcut"]}},t=a.__decorate([P.NonePointcut(),h.Singleton(q.AdviceMatcherToken),a.__param(0,h.Inject(h.ContainerToken)),a.__metadata("design:paramtypes",[Object])],t)}();e.AdviceMatcher=n});t(Q);Q.AdviceMatcher;var W=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container;t.register(O.Joinpoint),t.register(F.AdvisorChainFactory),t.register(F.ReturningRecognizer),t.register(F.SyncProceeding),t.register(F.AsyncPromiseProceeding),t.register(F.AsyncObservableProceeding),t.register(F.AdvisorChain),t.register(F.ProxyMethod),t.register(H.Advisor),t.register(Q.AdviceMatcher);var e=t.get(h.LifeScopeToken),n=new U.AopActionFactory;e.addAction(n.create(G.AopActions.registAspect),h.IocState.design),e.addAction(n.create(G.AopActions.matchPointcut),h.IocState.runtime,h.LifeState.beforeConstructor),e.addAction(n.create(G.AopActions.bindMethodPointcut),h.IocState.runtime,h.LifeState.AfterInit),e.addAction(n.create(G.AopActions.invokeBeforeConstructorAdvices),h.IocState.runtime,h.LifeState.beforeConstructor),e.addAction(n.create(G.AopActions.exetndsInstance),h.IocState.runtime,h.LifeState.onInit,h.LifeState.afterConstructor),e.addAction(n.create(G.AopActions.invokeAfterConstructorAdvices),h.IocState.runtime,h.LifeState.afterConstructor),e.registerDecorator(P.Aspect,G.AopActions.registAspect,G.AopActions.exetndsInstance)},t.classAnnations={name:"AopModule",params:{constructor:["container"],setup:[]}},t=a.__decorate([h.IocExt("setup"),a.__param(0,h.Inject(h.ContainerToken)),a.__metadata("design:paramtypes",[Object])],t)}();e.AopModule=n});t(W);W.AopModule;return t(e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),a.__exportStar(G,e),a.__exportStar(P,e),a.__exportStar(O,e),a.__exportStar(F,e),a.__exportStar(v,e),a.__exportStar(H,e),a.__exportStar(Q,e),a.__exportStar(b,e),a.__exportStar(W,e)}))});