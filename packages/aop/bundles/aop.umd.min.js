!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],e):(t.aop=t.aop||{},t.aop.umd=t.aop.umd||{},t.aop.umd.js=e(t.tslib_1,t["@ts-ioc/core"]))}(this,function(r,h){"use strict";function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}r=r&&r.hasOwnProperty("default")?r.default:r,h=h&&h.hasOwnProperty("default")?h.default:h;var i=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.AopActions||(e.AopActions={})).registAspect="registAspect",n.exetndsInstance="exetndsInstance",n.matchPointcut="matchPointcut",n.bindPropertyPointcut="bindPropertyPointcut",n.bindMethodPointcut="bindMethodPointcut",n.invokeBeforeConstructorAdvices="invokeBeforeConstructorAdvices",n.invokeAfterConstructorAdvices="invokeAfterConstructorAdvices"});t(i);i.AopActions;var _=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorToken=new h.InjectToken("__IOC_IAdvisor")});t(_);_.AdvisorToken;var o=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,i.AopActions.registAspect)||this}return r.__extends(e,t),e.prototype.working=function(t,e){var n=e.targetType,r=(e.propertyKey,t.getLifeScope().getClassDecorators(function(t){return t.actions.includes(i.AopActions.registAspect)&&h.hasOwnClassMetadata(t.name,n)})),o=t.get(_.AdvisorToken);r.forEach(function(t){var e=h.getOwnTypeMetadata(t.name,n);Array.isArray(e)&&0<e.length&&e.forEach(function(t){h.isClass(t.type)&&o.add(t.type)})})},e.classAnnations={name:"RegistAspectAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.RegistAspectAction=n});t(o);o.RegistAspectAction;var n=e(function(t,e){function n(e,n,r,o){return h.createMethodDecorator("Advice",function(t){n&&n(t),t.next({match:function(t){return h.isString(t)||h.isRegExp(t)},setMetadata:function(t,e){t.pointcut=e}}),r&&r(t),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotationArgName=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotationName=e}})},function(t){return o&&(t=o(t)),t.adviceName=e,t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createAdviceDecorator=n,e.Advice=n("Advice")});t(n);n.createAdviceDecorator,n.Advice;var a=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Aspect=h.createClassDecorator("Aspect",function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotation=e}}),t.next({match:function(t){return h.isArray(t)||h.isClass(t)},setMetadata:function(t,e){t.within=e}})})});t(a);a.Aspect;var c=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.After=n.createAdviceDecorator("After")});t(c);c.After;var s=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AfterReturning=n.createAdviceDecorator("AfterReturning",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.returning=e}})})});t(s);s.AfterReturning;var u=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AfterThrowing=n.createAdviceDecorator("AfterThrowing",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(u);u.AfterThrowing;var p=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Around=n.createAdviceDecorator("Around",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.args=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.returning=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(p);p.Around;var d=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Before=n.createAdviceDecorator("Before")});t(d);d.Before;var f=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Pointcut=n.createAdviceDecorator("Pointcut")});t(f);f.Pointcut;var v=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NonePointcut=h.createClassDecorator("NonePointcut")});t(v);v.NonePointcut;var y=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(n,e),r.__exportStar(a,e),r.__exportStar(c,e),r.__exportStar(s,e),r.__exportStar(u,e),r.__exportStar(p,e),r.__exportStar(d,e),r.__exportStar(f,e),r.__exportStar(v,e)});t(y);var g=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.isValideAspectTarget=function(t){return!(!h.isClass(t)||t===Object||t===String||t===Date||t===Boolean||t===Number||h.hasOwnClassMetadata(y.NonePointcut,t))}});t(g);g.isValideAspectTarget;var m=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorChainFactoryToken=new h.InjectToken("__IOC_IAdvisorChainFactory")});t(m);m.AdvisorChainFactoryToken;var A=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.JoinpointState||(e.JoinpointState={})).Before="Before",n.Pointcut="Pointcut",n.After="After",n.AfterReturning="AfterReturning",n.AfterThrowing="AfterThrowing"});t(A);A.JoinpointState;var l=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.JoinpointToken=new h.InjectToken("__IOC_IJoinpoint")});t(l);l.JoinpointToken;var P=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.provJoinpoint=t.provJoinpoint,this.name=t.name,this.fullName=t.fullName,this.params=t.params||[],this.args=t.args,this.returning=t.returning,this.throwing=t.throwing,this.state=t.state,this.advicer=t.advicer,this.annotations=t.annotations,this.target=t.target,this.targetType=t.targetType}return t.classAnnations={name:"Joinpoint",params:{constructor:["options"]}},t=r.__decorate([h.Injectable(l.JoinpointToken),y.NonePointcut(),r.__metadata("design:paramtypes",[Object])],t)}();e.Joinpoint=n});t(P);P.Joinpoint;var b=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(A,e),r.__exportStar(l,e),r.__exportStar(P,e)});t(b);var M=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorChainToken=new h.InjectToken("__IOC_IAdvisorChain")});t(M);M.AdvisorChainToken;var T=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){this.container=t,this.advices=e}return t.prototype.getAdvicers=function(t){return(t?this.advices[t]:null)||[]},t.prototype.invoaction=function(t,e,n){switch(t.state=e,t.returning=void 0,t.throwing=void 0,e){case b.JoinpointState.Before:this.before(t);break;case b.JoinpointState.Pointcut:this.pointcut(t);break;case b.JoinpointState.After:t.returning=n,this.after(t);break;case b.JoinpointState.AfterThrowing:t.throwing=n,this.afterThrowing(t);break;case b.JoinpointState.AfterReturning:t.returning=n,this.afterReturning(t)}},t.prototype.before=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),h.isUndefined(n.args)||(t.args=n.args),this.getAdvicers("Before").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.pointcut=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Pointcut").forEach(function(t){e.invokeAdvice(n,t)}),h.isUndefined(n.args)||(t.args=n.args)},t.prototype.after=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("After").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterThrowing=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("AfterThrowing").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterReturning=function(e){var n=this,t=h.lang.assign({},e),r=this.container.resolve(M.AdvisorChainToken,{joinPoint:t});this.getAdvicers("Around").forEach(function(e){r.next(function(t){return n.invokeAdvice(t,e)})}),this.getAdvicers("AfterReturning").forEach(function(e){r.next(function(t){return n.invokeAdvice(t,e)})}),r.next(function(t){return h.isUndefined(t.returning)||(e.returning=t.returning),e}),r.process()},t.prototype.invokeAdvice=function(r,t){var n=this,e=[];e.push(h.Provider.createExtends(b.Joinpoint,r,function(t,e){t._cache_JoinPoint=e.resolve(n.container)}));var o,i=t.advice;return!h.isUndefined(r.args)&&i.args&&e.push(h.Provider.create(i.args,r.args)),i.annotationArgName&&e.push(h.Provider.create(i.annotationArgName,function(){for(var t=r,e=t.annotations;!e&&r.provJoinpoint;)if((t=r.provJoinpoint)&&t.annotations){e=t.annotations;break}if(h.isArray(e)){if(i.annotationName){var n=i.annotationName;return n=/^@/.test(n)?n:"@"+n,e.filter(function(t){return t.decorator===n})}return e}return[]})),!h.isUndefined(r.returning)&&i.returning&&e.push(h.Provider.create(i.returning,r.returning)),!h.isUndefined(r.throwing)&&i.throwing&&e.push(h.Provider.create(i.throwing,r.throwing)),(o=this.container).syncInvoke.apply(o,[t.aspectType,t.advice.propertyKey,null].concat(e))},t.classAnnations={name:"AdvisorChainFactory",params:{constructor:["container","advices"],getAdvicers:["adviceType"],invoaction:["joinPoint","state","valueOrthrowing"],before:["joinPoint"],pointcut:["joinPoint"],after:["joinPoint"],afterThrowing:["joinPoint"],afterReturning:["joinPoint"],invokeAdvice:["joinPoint","advicer"]}},t=r.__decorate([y.NonePointcut(),h.Injectable(m.AdvisorChainFactoryToken),r.__param(0,h.Inject(h.ContainerToken)),r.__metadata("design:paramtypes",[Object,Object])],t)}();e.AdvisorChainFactory=n});t(T);T.AdvisorChainFactory;var k=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdvisorProceedingToken=new h.InjectToken("__IOC_IAdvisorProceeding")});t(k);k.AdvisorProceedingToken;var S=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.joinPoint=t,this.actions=[]}return t.prototype.next=function(t){this.actions.push(t)},t.prototype.getRecognizer=function(){return this.container.get(h.RecognizerToken,this.joinPoint.state)},t.prototype.process=function(){var t,e=this.getRecognizer().recognize(this.joinPoint.returning);(t=this.container.get(k.AdvisorProceedingToken,e)).proceeding.apply(t,[this.joinPoint].concat(this.actions))},t.classAnnations={name:"AdvisorChain",params:{constructor:["joinPoint"],next:["action"],getRecognizer:[],process:[]}},r.__decorate([h.Inject(h.ContainerToken),r.__metadata("design:type",Object)],t.prototype,"container",void 0),t=r.__decorate([y.NonePointcut(),h.Injectable(M.AdvisorChainToken),r.__metadata("design:paramtypes",[b.Joinpoint])],t)}();e.AdvisorChain=n});t(S);S.AdvisorChain;var x=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ProxyMethodToken=new h.InjectToken("__IOC_IProxyMethod")});t(x);x.ProxyMethodToken;var O=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var l=b,n=function(){function t(t){this.container=t}return Object.defineProperty(t.prototype,"aspectMgr",{get:function(){return this._aspectMgr||(this._aspectMgr=this.container.get(_.AdvisorToken)),this._aspectMgr},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"liefScope",{get:function(){return this._liefScope||(this._liefScope=this.container.getLifeScope()),this._liefScope},enumerable:!0,configurable:!0}),t.prototype.proceed=function(t,e,n,r){var o=this.aspectMgr,i=n.fullName,a=n.name,c=o.getAdvices(i);if(c&&n)if(n.descriptor&&(n.descriptor.get||n.descriptor.set)){if(n.descriptor.get){var s=n.descriptor.get.bind(t);n.descriptor.get=this.proxy(s,c,t,e,n,r)}if(n.descriptor.set){var u=n.descriptor.set.bind(t);n.descriptor.set=this.proxy(u,c,t,e,n,r)}Object.defineProperty(t,a,n.descriptor)}else if(h.isFunction(t[a])){var p=t[a].bind(t);t[a]=this.proxy(p,c,t,e,n,r)}},t.prototype.proxy=function(a,c,s,u,t,p){var d=this,f=(this.aspectMgr,t.fullName),v=t.name,g=this.liefScope,A=this.container;return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n,r,o=d.container.resolve(l.Joinpoint,h.Provider.create("options",{name:v,fullName:f,provJoinpoint:p,annotations:p?null:g.getMethodMetadatas(u,v),params:g.getMethodParameters(u,s,v),args:t,target:s,targetType:u})),i=A.resolve(m.AdvisorChainFactoryToken,{container:A,advices:c});i.invoaction(o,b.JoinpointState.Before),i.invoaction(o,b.JoinpointState.Pointcut);try{n=a.apply(void 0,o.args)}catch(t){r=t}if(i.invoaction(o,b.JoinpointState.After,n),!r)return i.invoaction(o,b.JoinpointState.AfterReturning,n),o.returning;i.invoaction(o,b.JoinpointState.AfterThrowing,r)}},t.classAnnations={name:"ProxyMethod",params:{constructor:["container"],proceed:["target","targetType","pointcut","provJoinpoint"],proxy:["propertyMethod","advices","target","targetType","pointcut","provJoinpoint"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(x.ProxyMethodToken),r.__param(0,h.Inject(h.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.ProxyMethod=n});t(O);O.ProxyMethod;var w=e(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.ReturningType||(e.ReturningType={})).sync="sync",n.promise="promise",n.observable="observable"});t(w);w.ReturningType;var j=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];n.returning&&t.forEach(function(e){n.returning=n.returning.then(function(t){return n.returningValue=t,Promise.resolve(e(n)).then(function(){return n.returningValue})})})},t.classAnnations={name:"AsyncPromiseProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(k.AdvisorProceedingToken,w.ReturningType.promise),r.__metadata("design:paramtypes",[])],t)}();e.AsyncPromiseProceeding=n});t(j);j.AsyncPromiseProceeding;var C=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];h.isFunction(n.returning.flatMap)?t.forEach(function(e){n.returning=n.returning.flatMap(function(t){return n.returningValue=t,e(n),h.isObservable(n.returningValue)?n.returningValue:h.isPromise(n.returningValue)?n.returningValue:Promise.resolve(n.returningValue)})}):t.forEach(function(t){t(n)})},t.classAnnations={name:"AsyncObservableProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(k.AdvisorProceedingToken,w.ReturningType.observable),r.__metadata("design:paramtypes",[])],t)}();e.AsyncObservableProceeding=n});t(C);C.AsyncObservableProceeding;var I=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.recognize=function(t){return h.isPromise(t)?w.ReturningType.promise:h.isObservable(t)?w.ReturningType.observable:w.ReturningType.sync},t.classAnnations={name:"ReturningRecognizer",params:{constructor:[],recognize:["value"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(h.RecognizerToken,b.JoinpointState.AfterReturning),r.__metadata("design:paramtypes",[])],t)}();e.ReturningRecognizer=n});t(I);I.ReturningRecognizer;var N=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.proceeding=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];e.returningValue=e.returning,t.forEach(function(t){t(e)})},t.classAnnations={name:"SyncProceeding",params:{proceeding:["joinPoint","actions"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(k.AdvisorProceedingToken,w.ReturningType.sync)],t)}();e.SyncProceeding=n});t(N);N.SyncProceeding;var E=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(m,e),r.__exportStar(T,e),r.__exportStar(M,e),r.__exportStar(S,e),r.__exportStar(x,e),r.__exportStar(O,e),r.__exportStar(j,e),r.__exportStar(C,e),r.__exportStar(k,e),r.__exportStar(I,e),r.__exportStar(w,e),r.__exportStar(N,e)});t(E);var R=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,i.AopActions.bindMethodPointcut)||this}return r.__extends(e,t),e.prototype.working=function(t,e){if(e.target&&g.isValideAspectTarget(e.targetType)){var n=t.get(E.ProxyMethodToken),r=e.target,o=e.targetType,i=h.getClassName(o),a=[],c=Object.getOwnPropertyDescriptors(o.prototype);h.lang.forIn(c,function(t,e){"constructor"!==e&&a.push({name:e,fullName:i+"."+e,descriptor:t})});var s=h.getParamerterNames(o);h.lang.forIn(s,function(t,e){"constructor"!==e&&h.isUndefined(c[e])&&a.push({name:e,fullName:i+"."+e})}),a.forEach(function(t){n.proceed(r,o,t,r._cache_JoinPoint)})}},e.classAnnations={name:"BindMethodPointcutAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.BindMethodPointcutAction=n});t(R);R.BindMethodPointcutAction;var J=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,i.AopActions.registAspect)||this}return r.__extends(e,t),e.prototype.working=function(t,e){if(g.isValideAspectTarget(e.targetType)){var n=t.get(_.AdvisorToken),r=h.getClassName(e.targetType),o=n.getAdvices(r+".constructor");if(o){var i=e.targetType,a=e.target,c=t.resolve(b.Joinpoint,h.Provider.create("options",{name:"constructor",state:b.JoinpointState.Before,fullName:r+".constructor",target:a,args:e.args,params:e.params,targetType:i})),s=[h.Provider.create(b.Joinpoint,c)],u=t.get(h.MethodAccessorToken);o.Before.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))}),o.Around.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))})}}},e.classAnnations={name:"InvokeBeforeConstructorAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.InvokeBeforeConstructorAction=n});t(J);J.InvokeBeforeConstructorAction;var B=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,i.AopActions.invokeAfterConstructorAdvices)||this}return r.__extends(e,t),e.prototype.working=function(t,e){if(e.target&&g.isValideAspectTarget(e.targetType)){var n=t.get(_.AdvisorToken),r=h.getClassName(e.targetType),o=n.getAdvices(r+".constructor");if(o){var i=e.targetType,a=e.target,c=t.resolve(b.Joinpoint,h.Provider.create("options",{name:"constructor",state:b.JoinpointState.After,fullName:r+".constructor",target:a,args:e.args,params:e.params,targetType:i})),s=[h.Provider.create(b.Joinpoint,c)],u=t.get(h.MethodAccessorToken);o.After.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))}),o.Around.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))})}}},e.classAnnations={name:"InvokeAfterConstructorAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.InvokeAfterConstructorAction=n});t(B);B.InvokeAfterConstructorAction;var F=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AdviceMatcherToken=new h.InjectToken("__IOC_IAdviceMatcher")});t(F);F.AdviceMatcherToken;var D=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,i.AopActions.matchPointcut)||this}return r.__extends(e,t),e.prototype.working=function(t,e){var a=this;if(g.isValideAspectTarget(e.targetType)){var c=t.get(_.AdvisorToken),n=t.get(F.AdviceMatcherToken);c.aspects.forEach(function(t,i){n.match(i,e.targetType,t,e.target).forEach(function(t){var e=t.fullName,n=t.advice,r=c.getAdvices(e);r||(r={Before:[],Pointcut:[],After:[],Around:[],AfterThrowing:[],AfterReturning:[]},c.setAdvices(e,r));var o=h.lang.assign(t,{aspectType:i});"Before"===n.adviceName?r.Before.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Before.push(o):"Pointcut"===n.adviceName?r.Pointcut.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Pointcut.push(o):"Around"===n.adviceName?r.Around.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.Around.push(o):"After"===n.adviceName?r.After.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.After.push(o):"AfterThrowing"===n.adviceName?r.AfterThrowing.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.AfterThrowing.push(o):"AfterReturning"===n.adviceName&&(r.AfterReturning.some(function(t){return a.isAdviceEquals(t.advice,n)})||r.AfterReturning.push(o))})})}},e.prototype.isAdviceEquals=function(t,e){return!(!t||!e)&&(t===e||t.adviceName===e.adviceName&&t.pointcut===e.pointcut&&t.propertyKey===e.propertyKey)},e.classAnnations={name:"MatchPointcutAction",params:{constructor:[],working:["container","data"],isAdviceEquals:["advice1","advice2"]}},e}(h.ActionComposite);e.MatchPointcutAction=n});t(D);D.MatchPointcutAction;var V=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.create=function(t){var e;switch(t){case i.AopActions.registAspect:e=new o.RegistAspectAction;break;case i.AopActions.matchPointcut:e=new q.MatchPointcutAction;break;case i.AopActions.invokeBeforeConstructorAdvices:e=new q.InvokeBeforeConstructorAction;break;case i.AopActions.invokeAfterConstructorAdvices:e=new q.InvokeAfterConstructorAction;break;case i.AopActions.bindMethodPointcut:e=new q.BindMethodPointcutAction;break;case i.AopActions.exetndsInstance:e=new q.ExetndsInstanceAction}return e},t.classAnnations={name:"AopActionFactory",params:{create:["type"]}},t}();e.AopActionFactory=n});t(V);V.AopActionFactory;var z=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return t.call(this,i.AopActions.registAspect)||this}return r.__extends(e,t),e.prototype.working=function(t,e){!e.target||!e.providers||e.providers.length<1||e.providers.forEach(function(t){t&&t instanceof h.ExtendsProvider&&t.extends(e.target)})},e.classAnnations={name:"ExetndsInstanceAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.ExetndsInstanceAction=n});t(z);z.ExetndsInstanceAction;var q=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(i,e),r.__exportStar(o,e),r.__exportStar(R,e),r.__exportStar(J,e),r.__exportStar(B,e),r.__exportStar(D,e),r.__exportStar(V,e),r.__exportStar(z,e)});t(q);var K=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t,this.aspects=new h.MapSet,this.advices=new h.MapSet}return t.prototype.setAdvices=function(t,e){this.advices.has(t)||this.advices.set(t,e)},t.prototype.getAdvices=function(t){return this.advices.has(t)?this.advices.get(t):null},t.prototype.hasRegisterAdvices=function(t){var e=this,n=h.lang.keys(Object.getOwnPropertyDescriptors(t.prototype)),r=h.getClassName(t);return n.some(function(t){return e.advices.has(r+"."+t)})},t.prototype.add=function(t){if(!this.aspects.has(t)){var e=h.getOwnMethodMetadata(y.Advice,t);this.aspects.set(t,e)}},t.classAnnations={name:"Advisor",params:{constructor:["container"],setAdvices:["key","advices"],getAdvices:["key"],hasRegisterAdvices:["targetType"],add:["aspect"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(_.AdvisorToken),r.__param(0,h.Inject(h.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.Advisor=n});t(K);K.Advisor;var L=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.match=function(t,e,n,r){var o=this,i=h.lang.first(h.getOwnTypeMetadata(y.Aspect,t));if(i){if(i.within)if((h.isArray(i.within)?i.within:[i.within]).indexOf(e)<0)return[];if(i.annotation){var a=h.isFunction(i.annotation)?i.annotation.toString():i.annotation,c=(/^\^?@\w+/.test(a)?"":"@")+a;if(!h.hasOwnClassMetadata(c,e))return[]}}var s=h.getClassName(e);n=n||h.getOwnMethodMetadata(y.Advice,e);this.container.get(_.AdvisorToken);var u=[];if(e===t){var p=h.lang.keys(n);if(1<p.length){var d=[];p.forEach(function(t){d=d.concat(n[t])}),p.forEach(function(e){d.forEach(function(t){t.propertyKey!==e&&o.matchAspectSelf(e,t)&&u.push({name:e,fullName:s+"."+e,advice:t})})})}}else{var f=[],v=Object.getOwnPropertyDescriptors(e.prototype);for(var g in v)f.push({name:g,fullName:s+"."+g});var A=h.getParamerterNames(e);h.lang.forIn(A,function(t,e){"constructor"!==e&&h.isUndefined(v[e])&&f.push({name:e,fullName:s+"."+e})}),Object.getOwnPropertyNames(n).forEach(function(t){n[t].forEach(function(t){u=u.concat(o.filterPointcut(e,f,t))})})}return u},t.prototype.matchAspectSelf=function(t,e){if(e.pointcut){var n=e.pointcut;if(h.isString(n))return/^execution\(\S+\)$/.test(n)&&(n=n.substring(10,n.length-1)),n.startsWith(t);if(h.isRegExp(n))return n.test(t)}return!1},t.prototype.filterPointcut=function(e,t,n,r){if(!n.pointcut)return[];var o;if(n.pointcut){var i=this.matchTypeFactory(e,n);o=t.filter(function(t){return i(t.name,t.fullName,e,r,t)})}return(o=o||[]).map(function(t){return h.lang.assign({},t,{advice:n})})},t.prototype.matchTypeFactory=function(a,o){var c=this,t=o.pointcut;if(h.isString(t)){var e=(t||"").trim().split(/(&&)|(\|\|)/gi),s=t.substring(0),u=[];return e.forEach(function(t){if(/^@annotation\(\s*\w+/.test(t)){t=t.substring(12,t.length-1);var n=/^@/.test(t)?t:"@"+t;u.push(function(t,e){return h.hasOwnMethodMetadata(n,a,t)&&!h.hasOwnClassMetadata(y.Aspect,a)})}else if(/^execution\(\s*\w+/.test(t))if("*"===(t=t.substring(10,t.length-1))||"*.*"===t)u.push(function(t,e){return!!t&&!h.hasOwnClassMetadata(y.Aspect,a)});else if(/^\w+\(\s*\w+/.test(t))u.push(function(){return!1});else{t=t.replace(/\*\*/gi,"(\\w+(\\.|\\/)){0,}\\w+").replace(/\*/gi,"\\w+").replace(/\./gi,"\\.").replace(/\//gi,"\\/");var r=new RegExp(t+"$");u.push(function(t,e){return r.test(e)})}else if(/^@within\(\s*\w+/.test(t)){var o=t.substring(t.indexOf("(")+1,t.length-1).split(",").map(function(t){return t.trim()});u.push(function(t,e,n){return 0<=o.indexOf(h.getClassName(n))})}else if(/^@target\(\s*\w+/.test(t)){var i=t.substring(t.indexOf("(")+1,t.length-1).trim();u.push(function(t,e,n){return c.container.getTokenImpl(i)===n})}else u.push(function(){return!0});(s=s.substring(t.length))&&/^(&&)|(\|\|)/.test(s)&&(u.push(s.substring(0,2)),s=s.substring(2))}),o.within&&(u.push("&&"),u.push(function(t,e,n){return h.isArray(o.within)?0<=o.within.indexOf(n):o.within===n})),o.target&&(u.push("&&"),u.push(function(t,e,n,r){return o.target=r})),o.annotation&&(u.push("&&"),u.push(function(t,e,n,r){return h.hasOwnMethodMetadata(o.annotation,n,t)})),function(r,o,i,a){var c;return u.forEach(function(t,e){if(h.isUndefined(c)&&h.isFunction(t)){var n=t(r,o,i,a);e<u.length-2?(n||"&&"!==t[e+1]||(c=!1),n&&"||"===t[e+1]&&(c=!0)):c=n}}),c}}if(h.isRegExp(t)){var r=t;return/^\^?@\w+/.test(r.source)?function(t,e,n){return Reflect.getMetadataKeys(a,t).some(function(t){return h.isString(t)&&r.test(t)})}:function(t,e){return r.test(e)}}return null},t.classAnnations={name:"AdviceMatcher",params:{constructor:["container"],match:["aspectType","targetType","adviceMetas","target"],matchAspectSelf:["name","metadata"],filterPointcut:["type","points","metadata","target"],matchTypeFactory:["type","metadata"]}},t=r.__decorate([y.NonePointcut(),h.Singleton(F.AdviceMatcherToken),r.__param(0,h.Inject(h.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.AdviceMatcher=n});t(L);L.AdviceMatcher;var U=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container;t.register(b.Joinpoint),t.register(E.AdvisorChainFactory),t.register(E.ReturningRecognizer),t.register(E.SyncProceeding),t.register(E.AsyncPromiseProceeding),t.register(E.AsyncObservableProceeding),t.register(E.AdvisorChain),t.register(E.ProxyMethod),t.register(K.Advisor),t.register(L.AdviceMatcher);var e=t.get(h.LifeScopeToken),n=new V.AopActionFactory;e.addAction(n.create(q.AopActions.registAspect),h.IocState.design),e.addAction(n.create(q.AopActions.matchPointcut),h.IocState.runtime,h.LifeState.beforeConstructor),e.addAction(n.create(q.AopActions.bindMethodPointcut),h.IocState.runtime,h.LifeState.AfterInit),e.addAction(n.create(q.AopActions.invokeBeforeConstructorAdvices),h.IocState.runtime,h.LifeState.beforeConstructor),e.addAction(n.create(q.AopActions.exetndsInstance),h.IocState.runtime,h.LifeState.onInit,h.LifeState.afterConstructor),e.addAction(n.create(q.AopActions.invokeAfterConstructorAdvices),h.IocState.runtime,h.LifeState.afterConstructor),e.registerDecorator(y.Aspect,q.AopActions.registAspect,q.AopActions.exetndsInstance)},t.classAnnations={name:"AopModule",params:{constructor:["container"],setup:[]}},t=r.__decorate([h.IocExt("setup"),r.__param(0,h.Inject(h.ContainerToken)),r.__metadata("design:paramtypes",[Object])],t)}();e.AopModule=n});t(U);U.AopModule;return t(e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),r.__exportStar(q,e),r.__exportStar(y,e),r.__exportStar(b,e),r.__exportStar(E,e),r.__exportStar(_,e),r.__exportStar(K,e),r.__exportStar(L,e),r.__exportStar(g,e),r.__exportStar(U,e)}))});