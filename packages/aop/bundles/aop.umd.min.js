!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["@ts-ioc/core"],e):(t.aop=t.aop||{},t.aop.umd=t.aop.umd||{},t.aop.umd.js=e(t["@ts-ioc/core"]))}(this,function(h){"use strict";h=h&&h.hasOwnProperty("default")?h.default:h;var i="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}var y=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AopSymbols={IProxyMethod:Symbol("IProxyMethod"),IAdviceMatcher:Symbol("IAdviceMatcher"),IAdvisor:Symbol("IAdvisor"),IAdvisorChainFactory:Symbol("IAdvisorChainFactory"),IAdvisorChain:Symbol("IAdvisorChain"),IAdvisorProceeding:Symbol("IAdvisorProceeding"),IJoinpoint:Symbol("IJoinpoint")}});t(y);y.AopSymbols;var c=e(function(t,e){var n;(n=e.AopActions||(e.AopActions={})).registAspect="registAspect",n.exetndsInstance="exetndsInstance",n.matchPointcut="matchPointcut",n.bindPropertyPointcut="bindPropertyPointcut",n.bindMethodPointcut="bindMethodPointcut",n.invokeBeforeConstructorAdvices="invokeBeforeConstructorAdvices",n.invokeAfterConstructorAdvices="invokeAfterConstructorAdvices"});t(c);c.AopActions;var o=e(function(t,e){var o,n=i&&i.__extends||(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),r=function(t){function e(){return t.call(this,c.AopActions.registAspect)||this}return n(e,t),e.prototype.working=function(t,e){var n=e.targetType,o=(e.propertyKey,t.getLifeScope().getClassDecorators(function(t){return t.actions.includes(c.AopActions.registAspect)&&h.hasOwnClassMetadata(t.name,n)})),r=t.get(y.AopSymbols.IAdvisor);o.forEach(function(t){var e=h.getOwnTypeMetadata(t.name,n);Array.isArray(e)&&0<e.length&&e.forEach(function(t){h.isClass(t.type)&&r.add(t.type)})})},e.classAnnations={name:"RegistAspectAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.RegistAspectAction=r});t(o);o.RegistAspectAction;var r=e(function(t,e){function n(e,n,o,r){return h.createMethodDecorator("Advice",function(t){n&&n(t),t.next({isMetadata:function(t){return h.isClassMetadata(t,["pointcut"])},match:function(t){return h.isString(t)||h.isRegExp(t)},setMetadata:function(t,e){t.pointcut=e}}),o&&o(t),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotationArgName=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.annotation=e}})},function(t){return r&&(t=r(t)),t.adviceName=e,t})}e.createAdviceDecorator=n,e.Advice=n("Advice")});t(r);r.createAdviceDecorator,r.Advice;var a=e(function(t,e){e.Aspect=h.createClassDecorator("Aspect")});t(a);a.Aspect;var s=e(function(t,e){e.After=r.createAdviceDecorator("After")});t(s);s.After;var u=e(function(t,e){e.AfterReturning=r.createAdviceDecorator("AfterReturning",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.returning=e}})})});t(u);u.AfterReturning;var p=e(function(t,e){e.AfterThrowing=r.createAdviceDecorator("AfterThrowing",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(p);p.AfterThrowing;var f=e(function(t,e){e.Around=r.createAdviceDecorator("Around",null,function(t){t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.args=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.returning=e}}),t.next({match:function(t){return h.isString(t)},setMetadata:function(t,e){t.throwing=e}})})});t(f);f.Around;var d=e(function(t,e){e.Before=r.createAdviceDecorator("Before")});t(d);d.Before;var g=e(function(t,e){e.Pointcut=r.createAdviceDecorator("Pointcut")});t(g);g.Pointcut;var v=e(function(t,e){e.NonePointcut=h.createClassDecorator("NonePointcut")});t(v);v.NonePointcut;var l=e(function(t,n){function e(t){for(var e in t)n.hasOwnProperty(e)||(n[e]=t[e])}e(r),e(a),e(s),e(u),e(p),e(f),e(d),e(g),e(v)});t(l);var A=e(function(t,e){e.isValideAspectTarget=function(t){return!(!h.isClass(t)||t===Object||t===String||t===Date||t===Boolean||t===Number||h.hasOwnClassMetadata(l.NonePointcut,t))}});t(A);A.isValideAspectTarget;var m=e(function(t,e){var n=function(t){function e(){return t.call(this,c.AopActions.bindMethodPointcut)||this}return __extends(e,t),e.prototype.working=function(t,e){if(e.target&&A.isValideAspectTarget(e.targetType)){var n=t.get(y.AopSymbols.IProxyMethod),o=e.target,r=e.targetType,i=h.getClassName(r),c=[],a=Object.getOwnPropertyDescriptors(r.prototype);h.lang.forIn(a,function(t,e){"constructor"!==e&&c.push({name:e,fullName:i+"."+e,descriptor:t})});var s=h.getParamerterNames(r);h.lang.forIn(s,function(t,e){"constructor"!==e&&h.isUndefined(a[e])&&c.push({name:e,fullName:i+"."+e})}),c.forEach(function(t){n.proceed(o,r,t,o._cache_JoinPoint)})}},e.classAnnations={name:"BindMethodPointcutAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.BindMethodPointcutAction=n});t(m);m.BindMethodPointcutAction;var P=e(function(t,e){var n;(n=e.JoinpointState||(e.JoinpointState={})).Before="Before",n.Pointcut="Pointcut",n.After="After",n.AfterReturning="AfterReturning",n.AfterThrowing="AfterThrowing"});t(P);P.JoinpointState;var b=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=i&&i.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},r=function(){function t(t){this.provJoinpoint=t.provJoinpoint,this.name=t.name,this.fullName=t.fullName,this.params=t.params||[],this.args=t.args,this.returning=t.returning,this.throwing=t.throwing,this.state=t.state,this.advicer=t.advicer,this.annotations=t.annotations,this.target=t.target,this.targetType=t.targetType}return t.classAnnations={name:"Joinpoint",params:{constructor:["options"]}},t=n([h.Injectable(y.AopSymbols.IJoinpoint),l.NonePointcut(),o("design:paramtypes",[Object])],t)}();e.Joinpoint=r});t(b);b.Joinpoint;var S=e(function(t,n){function e(t){for(var e in t)n.hasOwnProperty(e)||(n[e]=t[e])}e(P),e(b)});t(S);var w=e(function(t,e){var n=function(t){function e(){return t.call(this,c.AopActions.registAspect)||this}return __extends(e,t),e.prototype.working=function(t,e){if(A.isValideAspectTarget(e.targetType)){var n=t.get(y.AopSymbols.IAdvisor),o=h.getClassName(e.targetType),r=n.getAdvices(o+".constructor");if(r){var i=e.targetType,c=e.target,a=t.resolve(S.Joinpoint,h.Provider.create("options",{name:"constructor",state:S.JoinpointState.Before,fullName:o+".constructor",target:c,args:e.args,targetType:i})),s=[h.Provider.create(S.Joinpoint,a)],u=t.get(h.symbols.IMethodAccessor);r.Before.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))}),r.Around.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))})}}},e.classAnnations={name:"InvokeBeforeConstructorAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.InvokeBeforeConstructorAction=n});t(w);w.InvokeBeforeConstructorAction;var _=e(function(t,e){var n=function(t){function e(){return t.call(this,c.AopActions.invokeAfterConstructorAdvices)||this}return __extends(e,t),e.prototype.working=function(t,e){if(e.target&&A.isValideAspectTarget(e.targetType)){var n=t.get(y.AopSymbols.IAdvisor),o=h.getClassName(e.targetType),r=n.getAdvices(o+".constructor");if(r){var i=e.targetType,c=e.target,a=t.resolve(S.Joinpoint,h.Provider.create("options",{name:"constructor",state:S.JoinpointState.After,fullName:o+".constructor",target:c,args:e.args,targetType:i})),s=[h.Provider.create(S.Joinpoint,a)],u=t.get(h.symbols.IMethodAccessor);r.After.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))}),r.Around.forEach(function(t){u.syncInvoke.apply(u,[t.aspectType,t.advice.propertyKey,void 0].concat(s))})}}},e.classAnnations={name:"InvokeAfterConstructorAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.InvokeAfterConstructorAction=n});t(_);_.InvokeAfterConstructorAction;var I=e(function(t,e){var n=function(t){function e(){return t.call(this,c.AopActions.matchPointcut)||this}return __extends(e,t),e.prototype.working=function(t,e){var c=this;if(A.isValideAspectTarget(e.targetType)){var a=t.get(y.AopSymbols.IAdvisor),n=t.get(y.AopSymbols.IAdviceMatcher);a.aspects.forEach(function(t,i){n.match(i,e.targetType,t).forEach(function(t){var e=t.fullName,n=t.advice,o=a.getAdvices(e);o||(o={Before:[],Pointcut:[],After:[],Around:[],AfterThrowing:[],AfterReturning:[]},a.setAdvices(e,o));var r=h.lang.assign(t,{aspectType:i});"Before"===n.adviceName?o.Before.some(function(t){return c.isAdviceEquals(t.advice,n)})||o.Before.push(r):"Pointcut"===n.adviceName?o.Pointcut.some(function(t){return c.isAdviceEquals(t.advice,n)})||o.Pointcut.push(r):"Around"===n.adviceName?o.Around.some(function(t){return c.isAdviceEquals(t.advice,n)})||o.Around.push(r):"After"===n.adviceName?o.After.some(function(t){return c.isAdviceEquals(t.advice,n)})||o.After.push(r):"AfterThrowing"===n.adviceName?o.AfterThrowing.some(function(t){return c.isAdviceEquals(t.advice,n)})||o.AfterThrowing.push(r):"AfterReturning"===n.adviceName&&(o.AfterReturning.some(function(t){return c.isAdviceEquals(t.advice,n)})||o.AfterReturning.push(r))})})}},e.prototype.isAdviceEquals=function(t,e){return!(!t||!e)&&(t===e||t.adviceName===e.adviceName&&t.pointcut===e.pointcut&&t.propertyKey===e.propertyKey)},e.classAnnations={name:"MatchPointcutAction",params:{constructor:[],working:["container","data"],isAdviceEquals:["advice1","advice2"]}},e}(h.ActionComposite);e.MatchPointcutAction=n});t(I);I.MatchPointcutAction;var R=e(function(t,e){var n=function(){function t(){}return t.prototype.create=function(t){var e;switch(t){case c.AopActions.registAspect:e=new o.RegistAspectAction;break;case c.AopActions.matchPointcut:e=new O.MatchPointcutAction;break;case c.AopActions.invokeBeforeConstructorAdvices:e=new O.InvokeBeforeConstructorAction;break;case c.AopActions.invokeAfterConstructorAdvices:e=new O.InvokeAfterConstructorAction;break;case c.AopActions.bindMethodPointcut:e=new O.BindMethodPointcutAction;break;case c.AopActions.exetndsInstance:e=new O.ExetndsInstanceAction}return e},t.classAnnations={name:"AopActionFactory",params:{create:["type"]}},t}();e.AopActionFactory=n});t(R);R.AopActionFactory;var j=e(function(t,e){var n=function(t){function e(){return t.call(this,c.AopActions.registAspect)||this}return __extends(e,t),e.prototype.working=function(t,e){!e.target||!e.providers||e.providers.length<1||e.providers.forEach(function(t){t&&t instanceof h.ExtendsProvider&&t.extends(e.target)})},e.classAnnations={name:"ExetndsInstanceAction",params:{constructor:[],working:["container","data"]}},e}(h.ActionComposite);e.ExetndsInstanceAction=n});t(j);j.ExetndsInstanceAction;var O=e(function(t,n){function e(t){for(var e in t)n.hasOwnProperty(e)||(n[e]=t[e])}e(c),e(o),e(m),e(w),e(_),e(I),e(R),e(j)});t(O);var M=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=i&&i.__param||function(n,o){return function(t,e){o(t,e,n)}},r=function(){function t(t,e){this.container=t,this.advices=e}return t.prototype.getAdvicers=function(t){return(t?this.advices[t]:null)||[]},t.prototype.invoaction=function(t,e,n){switch(t.state=e,t.returning=void 0,t.throwing=void 0,e){case S.JoinpointState.Before:this.before(t);break;case S.JoinpointState.Pointcut:this.pointcut(t);break;case S.JoinpointState.After:t.returning=n,this.after(t);break;case S.JoinpointState.AfterThrowing:t.throwing=n,this.afterThrowing(t);break;case S.JoinpointState.AfterReturning:t.returning=n,this.afterReturning(t)}},t.prototype.before=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),h.isUndefined(n.args)||(t.args=n.args),this.getAdvicers("Before").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.pointcut=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Pointcut").forEach(function(t){e.invokeAdvice(n,t)}),h.isUndefined(n.args)||(t.args=n.args)},t.prototype.after=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("After").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterThrowing=function(t){var e=this,n=h.lang.assign({},t);this.getAdvicers("Around").forEach(function(t){e.invokeAdvice(n,t)}),this.getAdvicers("AfterThrowing").forEach(function(t){e.invokeAdvice(n,t)})},t.prototype.afterReturning=function(e){var n=this,t=h.lang.assign({},e),o=this.container.resolve(y.AopSymbols.IAdvisorChain,{joinPoint:t});this.getAdvicers("Around").forEach(function(e){o.next(function(t){return n.invokeAdvice(t,e)})}),this.getAdvicers("AfterReturning").forEach(function(e){o.next(function(t){return n.invokeAdvice(t,e)})}),o.next(function(t){return h.isUndefined(t.returning)||(e.returning=t.returning),e}),o.process()},t.prototype.invokeAdvice=function(o,t){var n=this,e=[];e.push(h.Provider.createExtends(S.Joinpoint,o,function(t,e){t._cache_JoinPoint=e.resolve(n.container)}));var r,i=t.advice;return!h.isUndefined(o.args)&&i.args&&e.push(h.Provider.create(i.args,o.args)),i.annotationArgName&&e.push(h.Provider.create(i.annotationArgName,function(){for(var t=o,e=t.annotations;!e&&o.provJoinpoint;)if((t=o.provJoinpoint)&&t.annotations){e=t.annotations;break}if(h.isArray(e)){if(i.annotation){var n=i.annotation;return n=/^@/.test(n)?n:"@"+n,e.filter(function(t){return t.decorator===n})}return e}return[]})),!h.isUndefined(o.returning)&&i.returning&&e.push(h.Provider.create(i.returning,o.returning)),!h.isUndefined(o.throwing)&&i.throwing&&e.push(h.Provider.create(i.throwing,o.throwing)),(r=this.container).syncInvoke.apply(r,[t.aspectType,t.advice.propertyKey,null].concat(e))},t.classAnnations={name:"AdvisorChainFactory",params:{constructor:["container","advices"],getAdvicers:["adviceType"],invoaction:["joinPoint","state","valueOrthrowing"],before:["joinPoint"],pointcut:["joinPoint"],after:["joinPoint"],afterThrowing:["joinPoint"],afterReturning:["joinPoint"],invokeAdvice:["joinPoint","advicer"]}},t=n([l.NonePointcut(),h.Injectable(y.AopSymbols.IAdvisorChainFactory),o(0,h.Inject(h.symbols.IContainer)),__metadata("design:paramtypes",[Object,Object])],t)}();e.AdvisorChainFactory=r});t(M);M.AdvisorChainFactory;var C=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(t){this.joinPoint=t,this.actions=[]}return t.prototype.next=function(t){this.actions.push(t)},t.prototype.getRecognizer=function(){return this.container.get(h.symbols.IRecognizer,this.joinPoint.state)},t.prototype.process=function(){var t,e=this.getRecognizer().recognize(this.joinPoint.returning);(t=this.container.get(y.AopSymbols.IAdvisorProceeding,e)).proceeding.apply(t,[this.joinPoint].concat(this.actions))},t.classAnnations={name:"AdvisorChain",params:{constructor:["joinPoint"],next:["action"],getRecognizer:[],process:[]}},n([h.Inject(h.symbols.IContainer),__metadata("design:type",Object)],t.prototype,"container",void 0),t=n([l.NonePointcut(),h.Injectable(y.AopSymbols.IAdvisorChain),__metadata("design:paramtypes",[S.Joinpoint])],t)}();e.AdvisorChain=o});t(C);C.AdvisorChain;var T=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},A=S,o=function(){function t(t){this.container=t}return Object.defineProperty(t.prototype,"aspectMgr",{get:function(){return this._aspectMgr||(this._aspectMgr=this.container.get(y.AopSymbols.IAdvisor)),this._aspectMgr},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"liefScope",{get:function(){return this._liefScope||(this._liefScope=this.container.getLifeScope()),this._liefScope},enumerable:!0,configurable:!0}),t.prototype.proceed=function(t,e,n,o){var r=this.aspectMgr,i=n.fullName,c=n.name,a=r.getAdvices(i);if(a&&n)if(n.descriptor&&(n.descriptor.get||n.descriptor.set)){if(n.descriptor.get){var s=n.descriptor.get.bind(t);n.descriptor.get=this.proxy(s,a,t,e,n,o)}if(n.descriptor.set){var u=n.descriptor.set.bind(t);n.descriptor.set=this.proxy(u,a,t,e,n,o)}Object.defineProperty(t,c,n.descriptor)}else if(h.isFunction(t[c])){var p=t[c].bind(t);t[c]=this.proxy(p,a,t,e,n,o)}},t.prototype.proxy=function(c,a,s,u,t,p){var f=this,d=(this.aspectMgr,t.fullName),g=t.name,v=this.liefScope,l=this.container;return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n,o,r=f.container.resolve(A.Joinpoint,h.Provider.create("options",{name:g,fullName:d,provJoinpoint:p,annotations:p?null:v.getMethodMetadatas(u,g),params:v.getMethodParameters(u,s,g),args:t,target:s,targetType:u})),i=l.resolve(y.AopSymbols.IAdvisorChainFactory,{container:l,advices:a});i.invoaction(r,S.JoinpointState.Before),i.invoaction(r,S.JoinpointState.Pointcut);try{n=c.apply(void 0,r.args)}catch(t){o=t}if(i.invoaction(r,S.JoinpointState.After,n),!o)return i.invoaction(r,S.JoinpointState.AfterReturning,n),r.returning;i.invoaction(r,S.JoinpointState.AfterThrowing,o)}},t.classAnnations={name:"ProxyMethod",params:{constructor:["container"],proceed:["target","targetType","pointcut","provJoinpoint"],proxy:["propertyMethod","advices","target","targetType","pointcut","provJoinpoint"]}},t=n([l.NonePointcut(),h.Singleton(y.AopSymbols.IProxyMethod),__param(0,h.Inject(h.symbols.IContainer)),__metadata("design:paramtypes",[Object])],t)}();e.ProxyMethod=o});t(T);T.ProxyMethod;var k=e(function(t,e){var n;(n=e.ReturningType||(e.ReturningType={})).sync="sync",n.promise="promise",n.observable="observable"});t(k);k.ReturningType;var x=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];n.returning&&t.forEach(function(e){n.returning=n.returning.then(function(t){return n.returningValue=t,Promise.resolve(e(n)).then(function(){return n.returningValue})})})},t.classAnnations={name:"AsyncPromiseProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},t=n([l.NonePointcut(),h.Singleton(y.AopSymbols.IAdvisorProceeding,k.ReturningType.promise),__metadata("design:paramtypes",[])],t)}();e.AsyncPromiseProceeding=o});t(x);x.AsyncPromiseProceeding;var N=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(){}return t.prototype.proceeding=function(n){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];h.isFunction(n.returning.flatMap)?t.forEach(function(e){n.returning=n.returning.flatMap(function(t){return n.returningValue=t,e(n),h.isObservable(n.returningValue)?n.returningValue:h.isPromise(n.returningValue)?n.returningValue:Promise.resolve(n.returningValue)})}):t.forEach(function(t){t(n)})},t.classAnnations={name:"AsyncObservableProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},t=n([l.NonePointcut(),h.Singleton(y.AopSymbols.IAdvisorProceeding,k.ReturningType.observable),__metadata("design:paramtypes",[])],t)}();e.AsyncObservableProceeding=o});t(N);N.AsyncObservableProceeding;var E=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(){}return t.prototype.recognize=function(t){return h.isPromise(t)?k.ReturningType.promise:h.isObservable(t)?k.ReturningType.observable:k.ReturningType.sync},t.classAnnations={name:"ReturningRecognizer",params:{constructor:[],recognize:["value"]}},t=n([l.NonePointcut(),h.Singleton(h.symbols.IRecognizer,S.JoinpointState.AfterReturning),__metadata("design:paramtypes",[])],t)}();e.ReturningRecognizer=o});t(E);E.ReturningRecognizer;var J=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(){}return t.prototype.proceeding=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];e.returningValue=e.returning,t.forEach(function(t){t(e)})},t.classAnnations={name:"SyncProceeding",params:{proceeding:["joinPoint","actions"]}},t=n([l.NonePointcut(),h.Singleton(y.AopSymbols.IAdvisorProceeding,k.ReturningType.sync)],t)}();e.SyncProceeding=o});t(J);J.SyncProceeding;var D=e(function(t,n){function e(t){for(var e in t)n.hasOwnProperty(e)||(n[e]=t[e])}e(M),e(C),e(T),e(x),e(N),e(E),e(k),e(J)});t(D);var B=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(t){this.container=t,this.aspects=new h.MapSet,this.advices=new h.MapSet}return t.prototype.setAdvices=function(t,e){this.advices.has(t)||this.advices.set(t,e)},t.prototype.getAdvices=function(t){return this.advices.has(t)?this.advices.get(t):null},t.prototype.hasRegisterAdvices=function(t){var e=this,n=h.lang.keys(Object.getOwnPropertyDescriptors(t.prototype)),o=h.getClassName(t);return n.some(function(t){return e.advices.has(o+"."+t)})},t.prototype.add=function(t){if(!this.aspects.has(t)){var e=h.getOwnMethodMetadata(l.Advice,t);this.aspects.set(t,e)}},t.classAnnations={name:"Advisor",params:{constructor:["container"],setAdvices:["key","advices"],getAdvices:["key"],hasRegisterAdvices:["targetType"],add:["aspect"]}},t=n([l.NonePointcut(),h.Singleton(y.AopSymbols.IAdvisor),__param(0,h.Inject(h.symbols.IContainer)),__metadata("design:paramtypes",[Object])],t)}();e.Advisor=o});t(B);B.Advisor;var F=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(t){this.container=t}return t.prototype.match=function(t,e,n,o){var r=this,i=h.getClassName(e);n=n||h.getOwnMethodMetadata(l.Advice,e);this.container.get(y.AopSymbols.IAdvisor);var c=[];if(e===t){var a=h.lang.keys(n);if(1<a.length){var s=[];a.forEach(function(t){s=s.concat(n[t])}),a.forEach(function(e){s.forEach(function(t){t.propertyKey!==e&&r.matchAspectSelf(e,t)&&c.push({name:e,fullName:i+"."+e,advice:t})})})}}else{var u=[],p=Object.getOwnPropertyDescriptors(e.prototype);for(var f in p)u.push({name:f,fullName:i+"."+f});var d=h.getParamerterNames(e);h.lang.forIn(d,function(t,e){"constructor"!==e&&h.isUndefined(p[e])&&u.push({name:e,fullName:i+"."+e})}),Object.getOwnPropertyNames(n).forEach(function(t){n[t].forEach(function(t){c=c.concat(r.filterPointcut(e,u,t))})})}return c},t.prototype.matchAspectSelf=function(t,e){if(e.pointcut){var n=e.pointcut;if(h.isString(n)){if(/^execution\(\S+\)$/.test(n))return(n=n.substring(10,n.length-1))===t}else if(h.isRegExp(n))return n.test(t)}return!1},t.prototype.filterPointcut=function(t,e,n){if(!n.pointcut)return[];var o;if(n.pointcut){var r=this.matchTypeFactory(t,n.pointcut);o=e.filter(function(t){return r(t.name,t.fullName,t)})}return(o=o||[]).map(function(t){return h.lang.assign({},t,{advice:n})})},t.prototype.matchTypeFactory=function(o,t){if(h.isString(t)){if(t=(t||"").trim(),/^@annotation\(\S+\)$/.test(t)){t=t.substring(12,t.length-1);var n=/^@/.test(t)?t:"@"+t;return function(t,e){return h.hasOwnMethodMetadata(n,o,t)&&!h.hasOwnClassMetadata(l.Aspect,o)}}if(/^execution\(\S+\)$/.test(t)&&(t=t.substring(10,t.length-1)),"*"===t||"*.*"===t)return function(t,e,n){return!!t&&!h.hasOwnClassMetadata(l.Aspect,o)};t=t.replace(/\*\*/gi,"(\\w+(\\.|\\/)){0,}\\w+").replace(/\*/gi,"\\w+").replace(/\./gi,"\\.").replace(/\//gi,"\\/");var r=new RegExp(t+"$");return function(t,e,n){return r.test(e)}}if(h.isRegExp(t)){var i=t;return/^\^?@\w+/.test(i.source)?function(t,e,n){return Reflect.getMetadataKeys(o,t).some(function(t){return h.isString(t)&&i.test(t)})}:function(t,e,n){return i.test(e)}}return null},t.classAnnations={name:"AdviceMatcher",params:{constructor:["container"],match:["aspectType","targetType","adviceMetas","instance"],matchAspectSelf:["name","metadata"],filterPointcut:["type","points","metadata"],matchTypeFactory:["type","pointcut"]}},t=n([l.NonePointcut(),h.Singleton(y.AopSymbols.IAdviceMatcher),__param(0,h.Inject(h.symbols.IContainer)),__metadata("design:paramtypes",[Object])],t)}();e.AdviceMatcher=o});t(F);F.AdviceMatcher;var V=e(function(t,e){var n=i&&i.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},o=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container;t.register(S.Joinpoint),t.register(D.AdvisorChainFactory),t.register(D.ReturningRecognizer),t.register(D.SyncProceeding),t.register(D.AsyncPromiseProceeding),t.register(D.AsyncObservableProceeding),t.register(D.AdvisorChain),t.register(D.ProxyMethod),t.register(B.Advisor),t.register(F.AdviceMatcher);var e=t.get(h.symbols.LifeScope),n=new R.AopActionFactory;e.addAction(n.create(O.AopActions.registAspect),h.IocState.design),e.addAction(n.create(O.AopActions.matchPointcut),h.IocState.runtime,h.LifeState.beforeConstructor),e.addAction(n.create(O.AopActions.bindMethodPointcut),h.IocState.runtime,h.LifeState.AfterInit),e.addAction(n.create(O.AopActions.invokeBeforeConstructorAdvices),h.IocState.runtime,h.LifeState.beforeConstructor),e.addAction(n.create(O.AopActions.exetndsInstance),h.IocState.runtime,h.LifeState.onInit,h.LifeState.afterConstructor),e.addAction(n.create(O.AopActions.invokeAfterConstructorAdvices),h.IocState.runtime,h.LifeState.afterConstructor),e.registerDecorator(l.Aspect,O.AopActions.registAspect,O.AopActions.exetndsInstance)},t.symbols=y.AopSymbols,t.classAnnations={name:"AopModule",params:{constructor:["container"],setup:[]}},t=n([h.IocModule("setup"),__param(0,h.Inject(h.symbols.IContainer)),__metadata("design:paramtypes",[Object])],t)}();e.AopModule=o});t(V);V.AopModule;return t(e(function(t,n){function e(t){for(var e in t)n.hasOwnProperty(e)||(n[e]=t[e])}e(y),e(O),e(l),e(S),e(D),e(B),e(F),e(A),e(V)}))});