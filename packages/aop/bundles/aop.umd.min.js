!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.aop=e.aop||{},e.aop.umd=e.aop.umd||{},e.aop.umd.js=t(e.tslib_1,e["@ts-ioc/core"]))}(this,function(o,h){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}o=o&&o.hasOwnProperty("default")?o.default:o,h=h&&h.hasOwnProperty("default")?h.default:h;var i=t(function(e,t){var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.AopActions||(t.AopActions={})).registAspect="registAspect",n.exetndsInstance="exetndsInstance",n.matchPointcut="matchPointcut",n.bindPropertyPointcut="bindPropertyPointcut",n.bindMethodPointcut="bindMethodPointcut",n.invokeBeforeConstructorAdvices="invokeBeforeConstructorAdvices",n.invokeAfterConstructorAdvices="invokeAfterConstructorAdvices"});e(i);i.AopActions;var v=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvisorToken=new h.InjectToken("__IOC_IAdvisor")});e(v);v.AdvisorToken;var r=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return e.call(this,i.AopActions.registAspect)||this}return o.__extends(t,e),t.prototype.working=function(e,t){var n=t.targetType,o=(t.propertyKey,e.getLifeScope().getClassDecorators(function(e){return e.actions.includes(i.AopActions.registAspect)&&h.hasOwnClassMetadata(e.name,n)})),r=e.get(v.AdvisorToken);o.forEach(function(e){var t=h.getOwnTypeMetadata(e.name,n);Array.isArray(t)&&0<t.length&&t.forEach(function(e){h.isClass(e.type)&&r.add(e.type)})})},t.classAnnations={name:"RegistAspectAction",params:{constructor:[],working:["container","data"]}},t}(h.ActionComposite);t.RegistAspectAction=n});e(r);r.RegistAspectAction;var n=t(function(e,t){function n(t,n,o,r){return h.createMethodDecorator("Advice",function(e){n&&n(e),e.next({isMetadata:function(e){return h.isClassMetadata(e,["pointcut"])},match:function(e){return h.isString(e)||h.isRegExp(e)},setMetadata:function(e,t){e.pointcut=t}}),o&&o(e),e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.annotationArgName=t}}),e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.annotation=t}})},function(e){return r&&(e=r(e)),e.adviceName=t,e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createAdviceDecorator=n,t.Advice=n("Advice")});e(n);n.createAdviceDecorator,n.Advice;var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Aspect=h.createClassDecorator("Aspect")});e(a);a.Aspect;var c=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.After=n.createAdviceDecorator("After")});e(c);c.After;var s=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AfterReturning=n.createAdviceDecorator("AfterReturning",null,function(e){e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.returning=t}})})});e(s);s.AfterReturning;var u=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AfterThrowing=n.createAdviceDecorator("AfterThrowing",null,function(e){e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.throwing=t}})})});e(u);u.AfterThrowing;var p=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Around=n.createAdviceDecorator("Around",null,function(e){e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.args=t}}),e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.returning=t}}),e.next({match:function(e){return h.isString(e)},setMetadata:function(e,t){e.throwing=t}})})});e(p);p.Around;var d=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Before=n.createAdviceDecorator("Before")});e(d);d.Before;var f=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Pointcut=n.createAdviceDecorator("Pointcut")});e(f);f.Pointcut;var g=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.NonePointcut=h.createClassDecorator("NonePointcut")});e(g);g.NonePointcut;var A=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),o.__exportStar(n,t),o.__exportStar(a,t),o.__exportStar(c,t),o.__exportStar(s,t),o.__exportStar(u,t),o.__exportStar(p,t),o.__exportStar(d,t),o.__exportStar(f,t),o.__exportStar(g,t)});e(A);var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isValideAspectTarget=function(e){return!(!h.isClass(e)||e===Object||e===String||e===Date||e===Boolean||e===Number||h.hasOwnClassMetadata(A.NonePointcut,e))}});e(l);l.isValideAspectTarget;var _=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvisorChainFactoryToken=new h.InjectToken("__IOC_IAdvisorChainFactory")});e(_);_.AdvisorChainFactoryToken;var y=t(function(e,t){var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.JoinpointState||(t.JoinpointState={})).Before="Before",n.Pointcut="Pointcut",n.After="After",n.AfterReturning="AfterReturning",n.AfterThrowing="AfterThrowing"});e(y);y.JoinpointState;var m=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.JoinpointToken=new h.InjectToken("__IOC_IJoinpoint")});e(m);m.JoinpointToken;var P=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.provJoinpoint=e.provJoinpoint,this.name=e.name,this.fullName=e.fullName,this.params=e.params||[],this.args=e.args,this.returning=e.returning,this.throwing=e.throwing,this.state=e.state,this.advicer=e.advicer,this.annotations=e.annotations,this.target=e.target,this.targetType=e.targetType}return e.classAnnations={name:"Joinpoint",params:{constructor:["options"]}},e=o.__decorate([h.Injectable(m.JoinpointToken),A.NonePointcut(),o.__metadata("design:paramtypes",[Object])],e)}();t.Joinpoint=n});e(P);P.Joinpoint;var b=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),o.__exportStar(y,t),o.__exportStar(m,t),o.__exportStar(P,t)});e(b);var M=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvisorChainToken=new h.InjectToken("__IOC_IAdvisorChain")});e(M);M.AdvisorChainToken;var T=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.container=e,this.advices=t}return e.prototype.getAdvicers=function(e){return(e?this.advices[e]:null)||[]},e.prototype.invoaction=function(e,t,n){switch(e.state=t,e.returning=void 0,e.throwing=void 0,t){case b.JoinpointState.Before:this.before(e);break;case b.JoinpointState.Pointcut:this.pointcut(e);break;case b.JoinpointState.After:e.returning=n,this.after(e);break;case b.JoinpointState.AfterThrowing:e.throwing=n,this.afterThrowing(e);break;case b.JoinpointState.AfterReturning:e.returning=n,this.afterReturning(e)}},e.prototype.before=function(e){var t=this,n=h.lang.assign({},e);this.getAdvicers("Around").forEach(function(e){t.invokeAdvice(n,e)}),h.isUndefined(n.args)||(e.args=n.args),this.getAdvicers("Before").forEach(function(e){t.invokeAdvice(n,e)})},e.prototype.pointcut=function(e){var t=this,n=h.lang.assign({},e);this.getAdvicers("Pointcut").forEach(function(e){t.invokeAdvice(n,e)}),h.isUndefined(n.args)||(e.args=n.args)},e.prototype.after=function(e){var t=this,n=h.lang.assign({},e);this.getAdvicers("Around").forEach(function(e){t.invokeAdvice(n,e)}),this.getAdvicers("After").forEach(function(e){t.invokeAdvice(n,e)})},e.prototype.afterThrowing=function(e){var t=this,n=h.lang.assign({},e);this.getAdvicers("Around").forEach(function(e){t.invokeAdvice(n,e)}),this.getAdvicers("AfterThrowing").forEach(function(e){t.invokeAdvice(n,e)})},e.prototype.afterReturning=function(t){var n=this,e=h.lang.assign({},t),o=this.container.resolve(M.AdvisorChainToken,{joinPoint:e});this.getAdvicers("Around").forEach(function(t){o.next(function(e){return n.invokeAdvice(e,t)})}),this.getAdvicers("AfterReturning").forEach(function(t){o.next(function(e){return n.invokeAdvice(e,t)})}),o.next(function(e){return h.isUndefined(e.returning)||(t.returning=e.returning),t}),o.process()},e.prototype.invokeAdvice=function(o,e){var n=this,t=[];t.push(h.Provider.createExtends(b.Joinpoint,o,function(e,t){e._cache_JoinPoint=t.resolve(n.container)}));var r,i=e.advice;return!h.isUndefined(o.args)&&i.args&&t.push(h.Provider.create(i.args,o.args)),i.annotationArgName&&t.push(h.Provider.create(i.annotationArgName,function(){for(var e=o,t=e.annotations;!t&&o.provJoinpoint;)if((e=o.provJoinpoint)&&e.annotations){t=e.annotations;break}if(h.isArray(t)){if(i.annotation){var n=i.annotation;return n=/^@/.test(n)?n:"@"+n,t.filter(function(e){return e.decorator===n})}return t}return[]})),!h.isUndefined(o.returning)&&i.returning&&t.push(h.Provider.create(i.returning,o.returning)),!h.isUndefined(o.throwing)&&i.throwing&&t.push(h.Provider.create(i.throwing,o.throwing)),(r=this.container).syncInvoke.apply(r,[e.aspectType,e.advice.propertyKey,null].concat(t))},e.classAnnations={name:"AdvisorChainFactory",params:{constructor:["container","advices"],getAdvicers:["adviceType"],invoaction:["joinPoint","state","valueOrthrowing"],before:["joinPoint"],pointcut:["joinPoint"],after:["joinPoint"],afterThrowing:["joinPoint"],afterReturning:["joinPoint"],invokeAdvice:["joinPoint","advicer"]}},e=o.__decorate([A.NonePointcut(),h.Injectable(_.AdvisorChainFactoryToken),o.__param(0,h.Inject(h.ContainerToken)),o.__metadata("design:paramtypes",[Object,Object])],e)}();t.AdvisorChainFactory=n});e(T);T.AdvisorChainFactory;var k=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvisorProceedingToken=new h.InjectToken("__IOC_IAdvisorProceeding")});e(k);k.AdvisorProceedingToken;var S=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.joinPoint=e,this.actions=[]}return e.prototype.next=function(e){this.actions.push(e)},e.prototype.getRecognizer=function(){return this.container.get(h.RecognizerToken,this.joinPoint.state)},e.prototype.process=function(){var e,t=this.getRecognizer().recognize(this.joinPoint.returning);(e=this.container.get(k.AdvisorProceedingToken,t)).proceeding.apply(e,[this.joinPoint].concat(this.actions))},e.classAnnations={name:"AdvisorChain",params:{constructor:["joinPoint"],next:["action"],getRecognizer:[],process:[]}},o.__decorate([h.Inject(h.ContainerToken),o.__metadata("design:type",Object)],e.prototype,"container",void 0),e=o.__decorate([A.NonePointcut(),h.Injectable(M.AdvisorChainToken),o.__metadata("design:paramtypes",[b.Joinpoint])],e)}();t.AdvisorChain=n});e(S);S.AdvisorChain;var x=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyMethodToken=new h.InjectToken("__IOC_IProxyMethod")});e(x);x.ProxyMethodToken;var j=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var l=b,n=function(){function e(e){this.container=e}return Object.defineProperty(e.prototype,"aspectMgr",{get:function(){return this._aspectMgr||(this._aspectMgr=this.container.get(v.AdvisorToken)),this._aspectMgr},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"liefScope",{get:function(){return this._liefScope||(this._liefScope=this.container.getLifeScope()),this._liefScope},enumerable:!0,configurable:!0}),e.prototype.proceed=function(e,t,n,o){var r=this.aspectMgr,i=n.fullName,a=n.name,c=r.getAdvices(i);if(c&&n)if(n.descriptor&&(n.descriptor.get||n.descriptor.set)){if(n.descriptor.get){var s=n.descriptor.get.bind(e);n.descriptor.get=this.proxy(s,c,e,t,n,o)}if(n.descriptor.set){var u=n.descriptor.set.bind(e);n.descriptor.set=this.proxy(u,c,e,t,n,o)}Object.defineProperty(e,a,n.descriptor)}else if(h.isFunction(e[a])){var p=e[a].bind(e);e[a]=this.proxy(p,c,e,t,n,o)}},e.prototype.proxy=function(a,c,s,u,e,p){var d=this,f=(this.aspectMgr,e.fullName),v=e.name,g=this.liefScope,A=this.container;return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n,o,r=d.container.resolve(l.Joinpoint,h.Provider.create("options",{name:v,fullName:f,provJoinpoint:p,annotations:p?null:g.getMethodMetadatas(u,v),params:g.getMethodParameters(u,s,v),args:e,target:s,targetType:u})),i=A.resolve(_.AdvisorChainFactoryToken,{container:A,advices:c});i.invoaction(r,b.JoinpointState.Before),i.invoaction(r,b.JoinpointState.Pointcut);try{n=a.apply(void 0,r.args)}catch(e){o=e}if(i.invoaction(r,b.JoinpointState.After,n),!o)return i.invoaction(r,b.JoinpointState.AfterReturning,n),r.returning;i.invoaction(r,b.JoinpointState.AfterThrowing,o)}},e.classAnnations={name:"ProxyMethod",params:{constructor:["container"],proceed:["target","targetType","pointcut","provJoinpoint"],proxy:["propertyMethod","advices","target","targetType","pointcut","provJoinpoint"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(x.ProxyMethodToken),o.__param(0,h.Inject(h.ContainerToken)),o.__metadata("design:paramtypes",[Object])],e)}();t.ProxyMethod=n});e(j);j.ProxyMethod;var O=t(function(e,t){var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.ReturningType||(t.ReturningType={})).sync="sync",n.promise="promise",n.observable="observable"});e(O);O.ReturningType;var w=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.proceeding=function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];n.returning&&e.forEach(function(t){n.returning=n.returning.then(function(e){return n.returningValue=e,Promise.resolve(t(n)).then(function(){return n.returningValue})})})},e.classAnnations={name:"AsyncPromiseProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(k.AdvisorProceedingToken,O.ReturningType.promise),o.__metadata("design:paramtypes",[])],e)}();t.AsyncPromiseProceeding=n});e(w);w.AsyncPromiseProceeding;var C=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.proceeding=function(n){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];h.isFunction(n.returning.flatMap)?e.forEach(function(t){n.returning=n.returning.flatMap(function(e){return n.returningValue=e,t(n),h.isObservable(n.returningValue)?n.returningValue:h.isPromise(n.returningValue)?n.returningValue:Promise.resolve(n.returningValue)})}):e.forEach(function(e){e(n)})},e.classAnnations={name:"AsyncObservableProceeding",params:{constructor:[],proceeding:["joinPoint","actions"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(k.AdvisorProceedingToken,O.ReturningType.observable),o.__metadata("design:paramtypes",[])],e)}();t.AsyncObservableProceeding=n});e(C);C.AsyncObservableProceeding;var I=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.recognize=function(e){return h.isPromise(e)?O.ReturningType.promise:h.isObservable(e)?O.ReturningType.observable:O.ReturningType.sync},e.classAnnations={name:"ReturningRecognizer",params:{constructor:[],recognize:["value"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(h.RecognizerToken,b.JoinpointState.AfterReturning),o.__metadata("design:paramtypes",[])],e)}();t.ReturningRecognizer=n});e(I);I.ReturningRecognizer;var N=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.proceeding=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t.returningValue=t.returning,e.forEach(function(e){e(t)})},e.classAnnations={name:"SyncProceeding",params:{proceeding:["joinPoint","actions"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(k.AdvisorProceedingToken,O.ReturningType.sync)],e)}();t.SyncProceeding=n});e(N);N.SyncProceeding;var R=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),o.__exportStar(_,t),o.__exportStar(T,t),o.__exportStar(M,t),o.__exportStar(S,t),o.__exportStar(x,t),o.__exportStar(j,t),o.__exportStar(w,t),o.__exportStar(C,t),o.__exportStar(k,t),o.__exportStar(I,t),o.__exportStar(O,t),o.__exportStar(N,t)});e(R);var E=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return e.call(this,i.AopActions.bindMethodPointcut)||this}return o.__extends(t,e),t.prototype.working=function(e,t){if(t.target&&l.isValideAspectTarget(t.targetType)){var n=e.get(R.ProxyMethodToken),o=t.target,r=t.targetType,i=h.getClassName(r),a=[],c=Object.getOwnPropertyDescriptors(r.prototype);h.lang.forIn(c,function(e,t){"constructor"!==t&&a.push({name:t,fullName:i+"."+t,descriptor:e})});var s=h.getParamerterNames(r);h.lang.forIn(s,function(e,t){"constructor"!==t&&h.isUndefined(c[t])&&a.push({name:t,fullName:i+"."+t})}),a.forEach(function(e){n.proceed(o,r,e,o._cache_JoinPoint)})}},t.classAnnations={name:"BindMethodPointcutAction",params:{constructor:[],working:["container","data"]}},t}(h.ActionComposite);t.BindMethodPointcutAction=n});e(E);E.BindMethodPointcutAction;var J=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return e.call(this,i.AopActions.registAspect)||this}return o.__extends(t,e),t.prototype.working=function(e,t){if(l.isValideAspectTarget(t.targetType)){var n=e.get(v.AdvisorToken),o=h.getClassName(t.targetType),r=n.getAdvices(o+".constructor");if(r){var i=t.targetType,a=t.target,c=e.resolve(b.Joinpoint,h.Provider.create("options",{name:"constructor",state:b.JoinpointState.Before,fullName:o+".constructor",target:a,args:t.args,params:t.params,targetType:i})),s=[h.Provider.create(b.Joinpoint,c)],u=e.get(h.MethodAccessorToken);r.Before.forEach(function(e){u.syncInvoke.apply(u,[e.aspectType,e.advice.propertyKey,void 0].concat(s))}),r.Around.forEach(function(e){u.syncInvoke.apply(u,[e.aspectType,e.advice.propertyKey,void 0].concat(s))})}}},t.classAnnations={name:"InvokeBeforeConstructorAction",params:{constructor:[],working:["container","data"]}},t}(h.ActionComposite);t.InvokeBeforeConstructorAction=n});e(J);J.InvokeBeforeConstructorAction;var B=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return e.call(this,i.AopActions.invokeAfterConstructorAdvices)||this}return o.__extends(t,e),t.prototype.working=function(e,t){if(t.target&&l.isValideAspectTarget(t.targetType)){var n=e.get(v.AdvisorToken),o=h.getClassName(t.targetType),r=n.getAdvices(o+".constructor");if(r){var i=t.targetType,a=t.target,c=e.resolve(b.Joinpoint,h.Provider.create("options",{name:"constructor",state:b.JoinpointState.After,fullName:o+".constructor",target:a,args:t.args,params:t.params,targetType:i})),s=[h.Provider.create(b.Joinpoint,c)],u=e.get(h.MethodAccessorToken);r.After.forEach(function(e){u.syncInvoke.apply(u,[e.aspectType,e.advice.propertyKey,void 0].concat(s))}),r.Around.forEach(function(e){u.syncInvoke.apply(u,[e.aspectType,e.advice.propertyKey,void 0].concat(s))})}}},t.classAnnations={name:"InvokeAfterConstructorAction",params:{constructor:[],working:["container","data"]}},t}(h.ActionComposite);t.InvokeAfterConstructorAction=n});e(B);B.InvokeAfterConstructorAction;var F=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AdviceMatcherToken=new h.InjectToken("__IOC_IAdviceMatcher")});e(F);F.AdviceMatcherToken;var D=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return e.call(this,i.AopActions.matchPointcut)||this}return o.__extends(t,e),t.prototype.working=function(e,t){var a=this;if(l.isValideAspectTarget(t.targetType)){var c=e.get(v.AdvisorToken),n=e.get(F.AdviceMatcherToken);c.aspects.forEach(function(e,i){n.match(i,t.targetType,e).forEach(function(e){var t=e.fullName,n=e.advice,o=c.getAdvices(t);o||(o={Before:[],Pointcut:[],After:[],Around:[],AfterThrowing:[],AfterReturning:[]},c.setAdvices(t,o));var r=h.lang.assign(e,{aspectType:i});"Before"===n.adviceName?o.Before.some(function(e){return a.isAdviceEquals(e.advice,n)})||o.Before.push(r):"Pointcut"===n.adviceName?o.Pointcut.some(function(e){return a.isAdviceEquals(e.advice,n)})||o.Pointcut.push(r):"Around"===n.adviceName?o.Around.some(function(e){return a.isAdviceEquals(e.advice,n)})||o.Around.push(r):"After"===n.adviceName?o.After.some(function(e){return a.isAdviceEquals(e.advice,n)})||o.After.push(r):"AfterThrowing"===n.adviceName?o.AfterThrowing.some(function(e){return a.isAdviceEquals(e.advice,n)})||o.AfterThrowing.push(r):"AfterReturning"===n.adviceName&&(o.AfterReturning.some(function(e){return a.isAdviceEquals(e.advice,n)})||o.AfterReturning.push(r))})})}},t.prototype.isAdviceEquals=function(e,t){return!(!e||!t)&&(e===t||e.adviceName===t.adviceName&&e.pointcut===t.pointcut&&e.propertyKey===t.propertyKey)},t.classAnnations={name:"MatchPointcutAction",params:{constructor:[],working:["container","data"],isAdviceEquals:["advice1","advice2"]}},t}(h.ActionComposite);t.MatchPointcutAction=n});e(D);D.MatchPointcutAction;var V=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.prototype.create=function(e){var t;switch(e){case i.AopActions.registAspect:t=new r.RegistAspectAction;break;case i.AopActions.matchPointcut:t=new q.MatchPointcutAction;break;case i.AopActions.invokeBeforeConstructorAdvices:t=new q.InvokeBeforeConstructorAction;break;case i.AopActions.invokeAfterConstructorAdvices:t=new q.InvokeAfterConstructorAction;break;case i.AopActions.bindMethodPointcut:t=new q.BindMethodPointcutAction;break;case i.AopActions.exetndsInstance:t=new q.ExetndsInstanceAction}return t},e.classAnnations={name:"AopActionFactory",params:{create:["type"]}},e}();t.AopActionFactory=n});e(V);V.AopActionFactory;var z=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){function t(){return e.call(this,i.AopActions.registAspect)||this}return o.__extends(t,e),t.prototype.working=function(e,t){!t.target||!t.providers||t.providers.length<1||t.providers.forEach(function(e){e&&e instanceof h.ExtendsProvider&&e.extends(t.target)})},t.classAnnations={name:"ExetndsInstanceAction",params:{constructor:[],working:["container","data"]}},t}(h.ActionComposite);t.ExetndsInstanceAction=n});e(z);z.ExetndsInstanceAction;var q=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),o.__exportStar(i,t),o.__exportStar(r,t),o.__exportStar(E,t),o.__exportStar(J,t),o.__exportStar(B,t),o.__exportStar(D,t),o.__exportStar(V,t),o.__exportStar(z,t)});e(q);var K=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.container=e,this.aspects=new h.MapSet,this.advices=new h.MapSet}return e.prototype.setAdvices=function(e,t){this.advices.has(e)||this.advices.set(e,t)},e.prototype.getAdvices=function(e){return this.advices.has(e)?this.advices.get(e):null},e.prototype.hasRegisterAdvices=function(e){var t=this,n=h.lang.keys(Object.getOwnPropertyDescriptors(e.prototype)),o=h.getClassName(e);return n.some(function(e){return t.advices.has(o+"."+e)})},e.prototype.add=function(e){if(!this.aspects.has(e)){var t=h.getOwnMethodMetadata(A.Advice,e);this.aspects.set(e,t)}},e.classAnnations={name:"Advisor",params:{constructor:["container"],setAdvices:["key","advices"],getAdvices:["key"],hasRegisterAdvices:["targetType"],add:["aspect"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(v.AdvisorToken),o.__param(0,h.Inject(h.ContainerToken)),o.__metadata("design:paramtypes",[Object])],e)}();t.Advisor=n});e(K);K.Advisor;var L=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.container=e}return e.prototype.match=function(e,t,n,o){var r=this,i=h.getClassName(t);n=n||h.getOwnMethodMetadata(A.Advice,t);this.container.get(v.AdvisorToken);var a=[];if(t===e){var c=h.lang.keys(n);if(1<c.length){var s=[];c.forEach(function(e){s=s.concat(n[e])}),c.forEach(function(t){s.forEach(function(e){e.propertyKey!==t&&r.matchAspectSelf(t,e)&&a.push({name:t,fullName:i+"."+t,advice:e})})})}}else{var u=[],p=Object.getOwnPropertyDescriptors(t.prototype);for(var d in p)u.push({name:d,fullName:i+"."+d});var f=h.getParamerterNames(t);h.lang.forIn(f,function(e,t){"constructor"!==t&&h.isUndefined(p[t])&&u.push({name:t,fullName:i+"."+t})}),Object.getOwnPropertyNames(n).forEach(function(e){n[e].forEach(function(e){a=a.concat(r.filterPointcut(t,u,e))})})}return a},e.prototype.matchAspectSelf=function(e,t){if(t.pointcut){var n=t.pointcut;if(h.isString(n)){if(/^execution\(\S+\)$/.test(n))return(n=n.substring(10,n.length-1))===e}else if(h.isRegExp(n))return n.test(e)}return!1},e.prototype.filterPointcut=function(e,t,n){if(!n.pointcut)return[];var o;if(n.pointcut){var r=this.matchTypeFactory(e,n.pointcut);o=t.filter(function(e){return r(e.name,e.fullName,e)})}return(o=o||[]).map(function(e){return h.lang.assign({},e,{advice:n})})},e.prototype.matchTypeFactory=function(o,e){if(h.isString(e)){if(e=(e||"").trim(),/^@annotation\(\S+\)$/.test(e)){e=e.substring(12,e.length-1);var n=/^@/.test(e)?e:"@"+e;return function(e,t){return h.hasOwnMethodMetadata(n,o,e)&&!h.hasOwnClassMetadata(A.Aspect,o)}}if(/^execution\(\S+\)$/.test(e)&&(e=e.substring(10,e.length-1)),"*"===e||"*.*"===e)return function(e,t,n){return!!e&&!h.hasOwnClassMetadata(A.Aspect,o)};e=e.replace(/\*\*/gi,"(\\w+(\\.|\\/)){0,}\\w+").replace(/\*/gi,"\\w+").replace(/\./gi,"\\.").replace(/\//gi,"\\/");var r=new RegExp(e+"$");return function(e,t,n){return r.test(t)}}if(h.isRegExp(e)){var i=e;return/^\^?@\w+/.test(i.source)?function(e,t,n){return Reflect.getMetadataKeys(o,e).some(function(e){return h.isString(e)&&i.test(e)})}:function(e,t,n){return i.test(t)}}return null},e.classAnnations={name:"AdviceMatcher",params:{constructor:["container"],match:["aspectType","targetType","adviceMetas","instance"],matchAspectSelf:["name","metadata"],filterPointcut:["type","points","metadata"],matchTypeFactory:["type","pointcut"]}},e=o.__decorate([A.NonePointcut(),h.Singleton(F.AdviceMatcherToken),o.__param(0,h.Inject(h.ContainerToken)),o.__metadata("design:paramtypes",[Object])],e)}();t.AdviceMatcher=n});e(L);L.AdviceMatcher;var U=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container;e.register(b.Joinpoint),e.register(R.AdvisorChainFactory),e.register(R.ReturningRecognizer),e.register(R.SyncProceeding),e.register(R.AsyncPromiseProceeding),e.register(R.AsyncObservableProceeding),e.register(R.AdvisorChain),e.register(R.ProxyMethod),e.register(K.Advisor),e.register(L.AdviceMatcher);var t=e.get(h.LifeScopeToken),n=new V.AopActionFactory;t.addAction(n.create(q.AopActions.registAspect),h.IocState.design),t.addAction(n.create(q.AopActions.matchPointcut),h.IocState.runtime,h.LifeState.beforeConstructor),t.addAction(n.create(q.AopActions.bindMethodPointcut),h.IocState.runtime,h.LifeState.AfterInit),t.addAction(n.create(q.AopActions.invokeBeforeConstructorAdvices),h.IocState.runtime,h.LifeState.beforeConstructor),t.addAction(n.create(q.AopActions.exetndsInstance),h.IocState.runtime,h.LifeState.onInit,h.LifeState.afterConstructor),t.addAction(n.create(q.AopActions.invokeAfterConstructorAdvices),h.IocState.runtime,h.LifeState.afterConstructor),t.registerDecorator(A.Aspect,q.AopActions.registAspect,q.AopActions.exetndsInstance)},e.classAnnations={name:"AopModule",params:{constructor:["container"],setup:[]}},e=o.__decorate([h.IocExt("setup"),o.__param(0,h.Inject(h.ContainerToken)),o.__metadata("design:paramtypes",[Object])],e)}();t.AopModule=n});e(U);U.AopModule;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),o.__exportStar(q,t),o.__exportStar(A,t),o.__exportStar(b,t),o.__exportStar(R,t),o.__exportStar(v,t),o.__exportStar(K,t),o.__exportStar(L,t),o.__exportStar(l,t),o.__exportStar(U,t)}))});