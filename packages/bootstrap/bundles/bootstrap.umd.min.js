!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(u,c){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}u=u&&u.hasOwnProperty("default")?u.default:u,c=c&&c.hasOwnProperty("default")?c.default:c;var o=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_ModuleBuilder",e)||this}return u.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(c.Registration);t.InjectModuleBuilder=r,t.ModuleBuilderToken=new r(""),t.RootModuleBuilderToken=new r("RootModule"),t.RootContainerToken=new c.InjectToken("DI_RootContainer")});e(o);o.InjectModuleBuilder,o.ModuleBuilderToken,o.RootModuleBuilderToken,o.RootContainerToken;var r=t(function(e,t){function r(t,r,n,o,i){return c.createClassDecorator("DIModule",function(e){o&&o(e)},function(e){(i&&(e=i(e)),!e.name&&c.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||n,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=r),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createDIModuleDecorator=r,t.DIModule=r("module",o.ModuleBuilderToken)});e(r);r.createDIModuleDecorator,r.DIModule;var n=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationBuilderToken=new c.InjectToken("DI_AppBuilder")});e(n);n.ApplicationBuilderToken;var i=t(function(e,t){function r(t,r,n,o,i){return c.createClassDecorator("Bootstrap",function(e){o&&o(e)},function(e){(i&&(e=i(e)),!e.name&&c.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||n,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=r),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createBootstrapDecorator=r,t.Bootstrap=r("bootstrap",n.ApplicationBuilderToken)});e(i);i.createBootstrapDecorator,i.Bootstrap;var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),u.__exportStar(r,t),u.__exportStar(i,t)});e(a);var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AppConfigurationToken=new c.InjectToken("DI_APP_Configuration")});e(l);l.AppConfigurationToken;var d=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(c.LifeScopeToken);t.registerDecorator(a.DIModule,c.CoreActions.bindProvider,c.CoreActions.cache,c.CoreActions.componentBeforeInit,c.CoreActions.componentInit,c.CoreActions.componentAfterInit),t.registerDecorator(a.Bootstrap,c.CoreActions.bindProvider,c.CoreActions.cache,c.CoreActions.componentBeforeInit,c.CoreActions.componentInit,c.CoreActions.componentAfterInit),e.register(s.ModuleBuilder),e.register(p.ApplicationBuilder)},e.classAnnations={name:"BootstrapModule",params:{constructor:["container"],setup:[]}},e=u.__decorate([c.IocExt("setup"),u.__param(0,c.Inject(c.ContainerToken)),u.__metadata("design:paramtypes",[Object])],e)}();t.BootstrapModule=r});e(d);d.BootstrapModule;var s=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s="__exportProviders",r=function(){function e(){}return e.prototype.getContainer=function(){return this.container},e.prototype.resetContainer=function(t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(e){return this.container=this.getContainerBuilder().create(),this.container!==t&&(this.container.parent=t),[2,this.container]})})},e.prototype.getContainerBuilder=function(){return this.getContainer().resolve(c.ContainerBuilderToken)},e.prototype.build=function(o,i){return u.__awaiter(this,void 0,void 0,function(){var t,r,n;return u.__generator(this,function(e){switch(e.label){case 0:return t=this.getConfigure(o),[4,(r=this.getBuilder(t)).createInstance(c.isToken(o)?o:null,t,i)];case 1:return n=e.sent(),[4,r.buildStrategy(n,t)];case 2:return e.sent(),[2,n]}})})},e.prototype.buildStrategy=function(t,e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(e){return[2,t]})})},e.prototype.importModule=function(s,a){return void 0===a&&(a=!1),u.__awaiter(this,void 0,void 0,function(){var t,r,n,o,i;return u.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(),c.isClass(s)&&!this.isDIModule(s)?(t.register(s),[2,t]):(r=this.getConfigure(s),n=this.getBuilder(r,a),a?[4,n.resetContainer(t)]:[3,2]);case 1:e.sent(),e.label=2;case 2:return o=n.getContainer(),[4,n.registerDepdences(o,r)];case 3:return e.sent(),i=n.getBootstrapToken(r,c.isClass(s)?s:null),c.isToken(i)&&t.bindProvider(i,function(){return n.createInstance(i,r)}),[4,this.importConfigExports(t,o,r)];case 4:return e.sent(),[2,t]}})})},e.prototype.getBuilder=function(e,t){var r;if(void 0===t&&(t=!1),e.builder)r=this.getBuilderViaConfig(e.builder);else{var n=this.getBootstrapToken(e);n&&(r=this.getBuilderViaToken(n))}return r||(r=t?this.createBuilder():this),r},e.prototype.getDecorator=function(){return a.DIModule.toString()},e.prototype.getConfigure=function(e){var t,r=this.getContainer();if(c.isClass(e))t=this.getMetaConfig(e);else if(c.isToken(e)){var n=r.getTokenImpl(e);c.isClass(n)&&(t=this.getMetaConfig(n))}else{t=e;var o=this.getBootstrapToken(t),i=c.isClass(o)?o:r.getTokenImpl(o);c.isClass(i)&&(t=c.lang.assign({},this.getMetaConfig(i),t||{}))}return t||{}},e.prototype.createInstance=function(n,o,e){return u.__awaiter(this,void 0,void 0,function(){var t,r;return u.__generator(this,function(e){switch(e.label){case 0:if(!(t=this.getBootstrapToken(o,n)))throw new Error("not find bootstrap token.");return r=this.getContainer(),[4,this.registerDepdences(r,o)];case 1:return e.sent(),[2,this.resolveToken(r,t,o)]}})})},e.prototype.registerDepdences=function(t,r){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(e){switch(e.label){case 0:return[4,this.registerExts(t,r)];case 1:return e.sent(),[4,this.registerConfgureDepds(t,r)];case 2:return e.sent(),[2,t]}})})},e.prototype.resolveToken=function(e,t,r){return c.isClass(t)&&(e.has(t)||e.register(t)),e.resolve(t)},e.prototype.importConfigExports=function(o,i,r){return u.__awaiter(this,void 0,void 0,function(){var t,n=this;return u.__generator(this,function(e){switch(e.label){case 0:return r.exports&&r.exports.length?[4,Promise.all(r.exports.map(function(r){return u.__awaiter(n,void 0,void 0,function(){return u.__generator(this,function(e){return o.bindProvider(r,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.resolve.apply(i,[r].concat(e))}),[2,r]})})}))]:[3,2];case 1:e.sent(),e.label=2;case 2:return(t=r[s])&&t.length&&t.forEach(function(e){o.bindProvider(e,function(){return i.get(e)})}),[2,o]}})})},e.prototype.needRegister=function(e){return!!this.isIocExt(e)},e.prototype.registerConfgureDepds=function(n,o){return u.__awaiter(this,void 0,void 0,function(){var t,r=this;return u.__generator(this,function(e){switch(e.label){case 0:return c.isArray(o.imports)&&o.imports.length?[4,n.get(c.ContainerBuilderToken).loader.loadTypes(o.imports,function(e){return r.isIocExt(e)||r.isDIModule(e)})]:[3,3];case 1:return t=e.sent(),[4,Promise.all(t.map(function(e){return r.importModule(e,!0)}))];case 2:e.sent(),e.label=3;case 3:return c.isArray(o.providers)&&o.providers.length&&(o[s]=this.bindProvider(n,o.providers)),[2,n]}})})},e.prototype.createBuilder=function(){return new e},e.prototype.getBootstrapToken=function(e,t){return e.bootstrap||t},e.prototype.getBuilderViaConfig=function(e){return c.isToken(e)?this.getContainer().resolve(e):e instanceof n?e:null},e.prototype.getBuilderViaToken=function(e){if(c.isToken(e)){var t=c.isClass(e)?e:this.getContainer().getTokenImpl(e);if(t){var r=c.lang.first(c.getTypeMetadata(this.getDecorator(),t));if(r&&r.builder)return c.isToken(r.builder)?this.getContainer().resolve(r.builder):r.builder}}return null},e.prototype.getMetaConfig=function(e){var t=this.getDecorator();if(this.isDIModule(e)){var r=c.getTypeMetadata(t,e);if(r&&r.length){var n=r[0];return n.bootstrap=n.bootstrap||e,c.lang.omit(n,"builder")}}return null},e.prototype.isIocExt=function(e){return c.hasOwnClassMetadata(c.IocExt,e)},e.prototype.isDIModule=function(e){return!!c.isClass(e)&&(!!c.hasOwnClassMetadata(this.getDecorator(),e)||c.hasOwnClassMetadata(a.DIModule,e))},e.prototype.registerExts=function(t,e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(e){return t.has(d.BootstrapModule)||t.register(d.BootstrapModule),[2,t]})})},e.prototype.bindProvider=function(o,e){var i=[];return e.forEach(function(r,e){if(!c.isUndefined(r)&&!c.isNull(r))if(c.isProviderMap(r))r.forEach(function(e,t){i.push(e),o.bindProvider(e,t)});else if(r instanceof c.Provider)i.push(r.type),o.bindProvider(r.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.resolve.apply(r,[o].concat(e))});else if(c.isClass(r))o.has(r)||(i.push(r),o.register(r));else if(c.isBaseObject(r)){var t=r,n=!1;c.isToken(t.provide)?(c.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){c.isClass(e)&&!o.has(e)&&o.register(e)}),c.isUndefined(t.useValue)?c.isClass(t.useClass)?(o.has(t.useClass)||o.register(t.useClass),i.push(t.provide),o.bindProvider(t.provide,t.useClass)):c.isFunction(t.useFactory)?(i.push(t.provide),o.bindProvider(t.provide,function(){var e=[];return c.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return c.isClass(e)?o.get(e):e})),t.useFactory.apply(t,e)})):c.isToken(t.useExisting)?o.has(t.useExisting)?(i.push(t.provide),o.bindProvider(t.provide,t.useExisting)):console.log("has not register:",t.useExisting):n=!0:(i.push(t.provide),o.bindProvider(t.provide,function(){return t.useValue}))):n=!0,n&&c.lang.forIn(r,function(e,t){c.isUndefined(e)||(c.isClass(e)?o.bindProvider(t,e):c.isFunction(e)||c.isString(e)?o.bindProvider(t,function(){return e}):o.bindProvider(t,e),i.push(t))})}else c.isFunction(r)&&(i.push(name),o.bindProvider(name,function(){return r}))}),i},e.classAnnations={name:"BaseModuleBuilder",params:{constructor:[],getContainer:[],resetContainer:["parent"],getContainerBuilder:[],build:["token","data"],buildStrategy:["instance","config"],importModule:["token","forceNew"],getBuilder:["config","forceNew"],getDecorator:[],getConfigure:["token"],createInstance:["token","cfg","data"],registerDepdences:["container","config"],resolveToken:["container","token","config"],importConfigExports:["container","parentContainer","cfg"],needRegister:["type"],registerConfgureDepds:["container","config"],createBuilder:[],getBootstrapToken:["cfg","token"],getBuilderViaConfig:["builder"],getBuilderViaToken:["mdl"],getMetaConfig:["bootModule"],isIocExt:["token"],isDIModule:["token"],registerExts:["container","config"],bindProvider:["container","providers"]}},e}(),n=function(e){function t(){return e.call(this)||this}return u.__extends(t,e),(r=t).prototype.createBuilder=function(){return new r},t.classAnnations={name:"ModuleBuilder",params:{constructor:[],createBuilder:[]}},u.__decorate([c.Inject(c.ContainerToken),u.__metadata("design:type",Object)],t.prototype,"container",void 0),t=r=u.__decorate([c.Injectable(o.ModuleBuilderToken),u.__metadata("design:paramtypes",[])],t);var r}(t.BaseModuleBuilder=r);t.ModuleBuilder=n});e(s);s.BaseModuleBuilder,s.ModuleBuilder;var p=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(s){function e(e){var t=s.call(this)||this;return t.baseURL=e,t.globalModules=[],t.customRegs=[],t}return u.__extends(e,s),(t=e).prototype.getContainer=function(){if(!this.container){var e=this.getContainerBuilder();this.container=e.create()}return this.container},e.prototype.getContainerBuilder=function(){return this.containerBuilder||(this.containerBuilder=this.createContainerBuilder()),this.containerBuilder},e.prototype.createContainerBuilder=function(){return new c.DefaultContainerBuilder},e.prototype.useConfiguration=function(e){var t;this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig()));var r=this.getContainerBuilder();return c.isString(e)?t=r.loader.load([e]).then(function(e){return e.length?e[0]:null}):e&&(t=Promise.resolve(e)),t&&(this.globalConfig=this.globalConfig.then(function(r){return t.then(function(e){var t=e.default?e.default:e;return r=c.lang.assign(r||{},t||{})})})),this},e.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.globalModules=this.globalModules.concat(e),this},e.prototype.bootstrap=function(o){return u.__awaiter(this,void 0,void 0,function(){var t,r,n;return u.__generator(this,function(e){switch(e.label){case 0:return[4,this.build(o)];case 1:return t=e.sent(),n=t.container||this.getContainer(),t.config&&c.isToken(o)&&t.config.bootstrap!==o&&(!n.has(o)&&c.isClass(o)&&n.register(o),n.has(o)&&(r=n.resolve(o))),r=r||t,c.isFunction(r.onStart)?[4,Promise.resolve(r.onStart(t))]:[3,3];case 2:e.sent(),e.label=3;case 3:return c.isFunction(r.onStarted)&&r.onStarted(t),[2,t]}})})},e.prototype.build=function(t,r){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(e){switch(e.label){case 0:return this.root?[3,2]:[4,this.registerRoot()];case 1:e.sent(),e.label=2;case 2:return[4,this.resetContainer(this.root)];case 3:return e.sent(),this.container.has(o.RootModuleBuilderToken)?[4,this.container.get(o.RootModuleBuilderToken).build(t,r)]:[3,5];case 4:return[2,e.sent()];case 5:return[4,s.prototype.build.call(this,t,r)];case 6:return[2,e.sent()]}})})},e.prototype.registerRoot=function(){return u.__awaiter(this,void 0,void 0,function(){var t;return u.__generator(this,function(e){switch(e.label){case 0:return this.root?[3,3]:(this.root=this.getContainerBuilder().create(),[4,this.getGlobalConfigure()]);case 1:return t=e.sent(),this.bindAppConfig(t),[4,this.registerDepdences(this.root,t)];case 2:e.sent(),this.root.bindProvider(l.AppConfigurationToken,t),e.label=3;case 3:return[2,this.root]}})})},e.prototype.getGlobalConfigure=function(){return this.globalConfig||this.useConfiguration(),this.globalConfig},e.prototype.createBuilder=function(e){return new t(e)},e.prototype.registerExts=function(o,i){return u.__awaiter(this,void 0,void 0,function(){var t,r,n=this;return u.__generator(this,function(e){switch(e.label){case 0:return[4,s.prototype.registerExts.call(this,o,i)];case 1:return e.sent(),i.exports=i.exports||[],this.customRegs.length?[4,Promise.all(this.customRegs.map(function(r){return u.__awaiter(n,void 0,void 0,function(){var t;return u.__generator(this,function(e){switch(e.label){case 0:return[4,r(o,i,this)];case 1:return t=e.sent(),c.isArray(t)&&t.length&&(i.exports=i.exports.concat(t)),[2]}})})}))]:[3,3];case 2:e.sent(),e.label=3;case 3:return this.globalModules.length?(t=this.globalModules,[4,o.loadModule.apply(o,t)]):[3,5];case 4:(r=e.sent()).length&&(i.exports=i.exports.concat(r)),e.label=5;case 5:return[2,o]}})})},e.prototype.bindAppConfig=function(e){return this.baseURL&&(e.baseURL=this.baseURL),e},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"ApplicationBuilder",params:{constructor:["baseURL"],getContainer:[],getContainerBuilder:[],createContainerBuilder:[],useConfiguration:["config"],use:["modules"],bootstrap:["token"],build:["token","data"],registerRoot:[],getGlobalConfigure:[],createBuilder:["baseURL"],registerExts:["container","config"],bindAppConfig:["config"],getDefaultConfig:[]}},e=t=u.__decorate([c.Injectable(n.ApplicationBuilderToken),u.__metadata("design:paramtypes",[String])],e);var t}(s.BaseModuleBuilder);t.ApplicationBuilder=r});e(p);p.ApplicationBuilder;var f=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_Application",e)||this}return u.__extends(e,t),e.classAnnations={name:"InjectApplicationToken",params:{constructor:["desc"]}},e}(c.Registration);t.InjectApplicationToken=r,t.ApplicationToken=new r("")});e(f);f.InjectApplicationToken,f.ApplicationToken;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),u.__exportStar(a,t),u.__exportStar(l,t),u.__exportStar(p,t),u.__exportStar(f,t),u.__exportStar(n,t),u.__exportStar(o,t),u.__exportStar(s,t),u.__exportStar(d,t)}))});