!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(c,d){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}c=c&&c.hasOwnProperty("default")?c.default:c,d=d&&d.hasOwnProperty("default")?d.default:d;var s=t(function(e,t){function r(t,r,n,o,i,a,s){return d.createClassDecorator("DIModule",function(e){a&&a(e)},function(e){(s&&(e=s(e)),!e.name&&d.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||i,e.alias=e.alias||e.name,e.decorType=t,r&&!e.builder&&(e.builder=r),n&&!e.moduleBuilder&&(e.moduleBuilder=n),o&&!e.bootstrapBuilder&&(e.bootstrapBuilder=o),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createDIModuleDecorator=r,t.DIModule=r("module")});e(s);s.createDIModuleDecorator,s.DIModule;var n=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationBuilderToken=new d.InjectToken("DI_AppBuilder")});e(n);n.ApplicationBuilderToken;var r=t(function(e,t){function r(e,t,r,n,o,i,a){return s.createDIModuleDecorator(e,t,r,n,o,i,a)}Object.defineProperty(t,"__esModule",{value:!0}),t.createBootstrapDecorator=r,t.Bootstrap=r("bootstrap",n.ApplicationBuilderToken)});e(r);r.createBootstrapDecorator,r.Bootstrap;var o=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),c.__exportStar(s,t),c.__exportStar(r,t)});e(o);var i=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AppConfigurationToken=new d.InjectToken("DI_APP_Configuration")});e(i);i.AppConfigurationToken;var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_ModuleBuilder",e)||this}return c.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(d.Registration);t.InjectModuleBuilder=r,t.ModuleBuilderToken=new r("")});e(l);l.InjectModuleBuilder,l.ModuleBuilderToken;var p=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_ModuleBootstrap",e)||this}return c.__extends(e,t),e.classAnnations={name:"InjectBootBuilder",params:{constructor:["desc"]}},e}(d.Registration);t.InjectBootBuilder=r,t.BootBuilderToken=new r("")});e(p);p.InjectBootBuilder,p.BootBuilderToken;var f=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}var r;return(r=e).prototype.build=function(r,n,o){return c.__awaiter(this,void 0,void 0,function(){var t;return c.__generator(this,function(e){switch(e.label){case 0:return[4,this.createInstance(r,o)];case 1:return t=e.sent(),[4,this.buildStrategy(t,n)];case 2:return[2,t=e.sent()]}})})},e.prototype.buildByConfig=function(r,n){return c.__awaiter(this,void 0,void 0,function(){var t;return c.__generator(this,function(e){return d.isToken(r)?[2,this.build(r,null,n)]:(t=this.getBootstrapToken(r),[2,this.build(t,r,n)])})})},e.prototype.createInstance=function(t,e,r){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(e){if(!t)throw new Error("cant not find bootstrap token.");if(!this.container.has(t)){if(!d.isClass(t))throw new Error("cant not find token "+t.toString()+" in container.");this.container.register(t)}return[2,this.resolveToken(t,r)]})})},e.prototype.buildStrategy=function(t,e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(e){return[2,t]})})},e.prototype.getBootstrapToken=function(e){return e.bootstrap},e.prototype.resolveToken=function(e,t){return this.container.resolve(e,t)},e.prototype.getBuilderViaConfig=function(e,t){return d.isToken(e)?t.resolve(e):e instanceof r?e:null},e.classAnnations={name:"BootBuilder",params:{constructor:[],build:["token","config","data"],buildByConfig:["config","data"],createInstance:["token","config","data"],buildStrategy:["instance","config"],getBootstrapToken:["config"],resolveToken:["token","data"],getBuilderViaConfig:["builder","container"]}},c.__decorate([d.Inject(d.ContainerToken),c.__metadata("design:type",Object)],e.prototype,"container",void 0),e=r=c.__decorate([d.Singleton(p.BootBuilderToken),c.__metadata("design:paramtypes",[])],e)}();t.BootBuilder=r});e(f);f.BootBuilder;var g=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(d.LifeScopeToken);t.registerDecorator(o.DIModule,d.CoreActions.bindProvider,d.CoreActions.cache,d.CoreActions.componentBeforeInit,d.CoreActions.componentInit,d.CoreActions.componentAfterInit),t.registerDecorator(o.Bootstrap,d.CoreActions.bindProvider,d.CoreActions.cache,d.CoreActions.componentBeforeInit,d.CoreActions.componentInit,d.CoreActions.componentAfterInit),e.register(a.ModuleBuilder),e.register(f.BootBuilder),e.register(u.DefaultApplicationBuilder)},e.classAnnations={name:"BootModule",params:{constructor:["container"],setup:[]}},e=c.__decorate([d.IocExt("setup"),c.__param(0,d.Inject(d.ContainerToken)),c.__metadata("design:paramtypes",[Object])],e)}();t.BootModule=r});e(g);g.BootModule;var h=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.classAnnations={name:"LoadedModule",params:{}},e}();t.LoadedModule=r});e(h);h.LoadedModule;var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var a="__exportProviders",u=function(t){function e(e){return t.call(this,e,"module_loader")||this}return c.__extends(e,t),e.classAnnations={name:"InjectModuleLoadToken",params:{constructor:["token"]}},e}(d.Registration);t.InjectModuleLoadToken=u;var r=function(){function e(){}var n;return(n=e).prototype.getContainer=function(e,t){var r;if(d.isToken(e)){if(!d.isClass(e))return t||this.createContainer();var n=e;if(n.__di)return n.__di;var o=this.getConfigure(n);o.container?n.__di=o.container:n.__di=t||this.createContainer(),r=n.__di}else r=e.container?e.container:e.container=t||this.createContainer();return r},e.prototype.createContainer=function(){return this.getContainerBuilder().create()},e.prototype.getContainerBuilder=function(){return this.containerBuilder||(this.containerBuilder=this.createContainerBuilder()),this.containerBuilder},e.prototype.createContainerBuilder=function(){return new d.DefaultContainerBuilder},e.prototype.load=function(a,s){return c.__awaiter(this,void 0,void 0,function(){var t,r,n,o,i;return c.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(a,s),r=d.isToken(a)?a:a.name,n=new u(r),d.isToken(n)&&t.has(n)?[2,t.resolve(n)]:(o=this.getConfigure(a,t),[4,this.registerDepdences(t,o)]);case 1:return o=e.sent(),i={moduleToken:d.isToken(a)?a:null,container:t,moduleConfig:o},r&&t.bindProvider(n,function(){return i}),[2,i]}})})},e.prototype.build=function(u,l){return c.__awaiter(this,void 0,void 0,function(){var t,r,n,o,i,a,s;return c.__generator(this,function(e){switch(e.label){case 0:return l instanceof h.LoadedModule?(t=l,[3,3]):[3,1];case 1:return[4,this.load(u,l)];case 2:t=e.sent(),e.label=3;case 3:return r=t.container,n=t.moduleConfig,(o=this.getBuilder(r,n))&&o!==this?[4,o.build(u,r)]:[3,5];case 4:return[2,e.sent()];case 5:return(i=t.moduleToken)?[3,7]:[4,this.getBootstrapBuilder(r,n.bootstrapBuilder).buildByConfig(n)];case 6:return[2,a=e.sent()];case 7:return[4,this.getBootstrapBuilder(r,n.moduleBuilder).build(i,n)];case 8:return a=e.sent(),s=a,d.isFunction(s.mdOnInit)&&s.mdOnInit(t),[2,a]}})})},e.prototype.bootstrap=function(o,i,a){return c.__awaiter(this,void 0,void 0,function(){var t,r,n;return c.__generator(this,function(e){switch(e.label){case 0:return[4,this.load(o,a)];case 1:return t=e.sent(),[4,this.build(o,t)];case 2:return r=e.sent(),t.moduleToken?(r&&d.isFunction(r.btBeforeCreate)&&r.btBeforeCreate(t),[4,this.getBootstrapBuilder(t.container,t.moduleConfig.bootstrapBuilder).buildByConfig(t.moduleConfig,i)]):[3,6];case 3:return n=e.sent(),d.isFunction(r.btAfterCreate)&&r.btAfterCreate(n),d.isFunction(r.mdOnStart)?[4,Promise.resolve(r.mdOnStart(n))]:[3,5];case 4:e.sent(),e.label=5;case 5:return d.isFunction(r.mdOnStarted)&&r.mdOnStarted(n),[3,7];case 6:n=r,e.label=7;case 7:return[2,n]}})})},e.prototype.getBuilder=function(e,t){var r;return d.isClass(t.builder)&&(e.has(t.builder)||e.register(t.builder)),d.isToken(t.builder)?r=e.resolve(t.builder):t.builder instanceof n&&(r=t.builder),r},e.prototype.getBootstrapBuilder=function(e,t){var r;return d.isClass(t)&&(e.has(t)||e.register(t)),d.isToken(t)?r=e.resolve(t):t instanceof f.BootBuilder&&(r=t),r||(r=this.getDefaultBootBuilder(e)),r},e.prototype.getDefaultBootBuilder=function(e){return e.resolve(p.BootBuilderToken)},e.prototype.importModule=function(r,n){return c.__awaiter(this,void 0,void 0,function(){var t;return c.__generator(this,function(e){switch(e.label){case 0:return n&&d.isClass(r)&&!this.isDIModule(r)?(n.register(r),[2,n]):[4,this.load(r)];case 1:return t=e.sent(),n.has(t.moduleToken)?[3,3]:[4,this.importConfigExports(n,t.container,t.moduleConfig)];case 2:e.sent(),t.container.parent=n,t.moduleToken&&n.bindProvider(t.moduleToken,t),e.label=3;case 3:return[2,n]}})})},e.prototype.getDecorator=function(){return o.DIModule.toString()},e.prototype.getConfigure=function(e,t){var r;if(d.isClass(e))r=this.getMetaConfig(e);else if(d.isToken(e)){var n=t?t.getTokenImpl(e):e;d.isClass(n)&&(r=this.getMetaConfig(n))}else{r=e;var o=this.getBootstrapToken(r);if(o){var i=d.isClass(o)?o:t?t.getTokenImpl(o):o;d.isClass(i)&&(r=d.lang.assign({},this.getMetaConfig(i),r||{}))}}return r||{}},e.prototype.registerDepdences=function(t,r){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(e){switch(e.label){case 0:return[4,this.registerExts(t,r)];case 1:return e.sent(),[4,this.registerConfgureDepds(t,r)];case 2:return[2,r=e.sent()]}})})},e.prototype.getBootstrapToken=function(e){return e.bootstrap},e.prototype.importConfigExports=function(o,i,r){return c.__awaiter(this,void 0,void 0,function(){var t,n=this;return c.__generator(this,function(e){switch(e.label){case 0:return r.exports&&r.exports.length?[4,Promise.all(r.exports.map(function(r){return c.__awaiter(n,void 0,void 0,function(){return c.__generator(this,function(e){return o.bindProvider(r,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.resolve.apply(i,[r].concat(e))}),[2,r]})})}))]:[3,2];case 1:e.sent(),e.label=2;case 2:return(t=r[a])&&t.length&&t.forEach(function(e){o.bindProvider(e,function(){return i.get(e)})}),[2,o]}})})},e.prototype.registerConfgureDepds=function(n,o){return c.__awaiter(this,void 0,void 0,function(){var t,r=this;return c.__generator(this,function(e){switch(e.label){case 0:return d.isArray(o.imports)&&o.imports.length?[4,n.get(d.ContainerBuilderToken).loader.loadTypes(o.imports,function(e){return r.isIocExt(e)||r.isDIModule(e)})]:[3,3];case 1:return t=e.sent(),[4,Promise.all(t.map(function(e){return r.importModule(e,n)}))];case 2:e.sent(),e.label=3;case 3:return d.isArray(o.providers)&&o.providers.length&&(o[a]=this.bindProvider(n,o.providers)),[2,o]}})})},e.prototype.getMetaConfig=function(e){var t=this.getDecorator();if(this.isDIModule(e)){var r=d.getTypeMetadata(t,e);if(r&&r.length){var n=r[0];return d.lang.omit(n,"builder")}}return null},e.prototype.isIocExt=function(e){return d.hasOwnClassMetadata(d.IocExt,e)},e.prototype.isDIModule=function(e){return!!d.isClass(e)&&(!!d.hasOwnClassMetadata(this.getDecorator(),e)||d.hasOwnClassMetadata(o.DIModule,e))},e.prototype.registerExts=function(t,e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(e){return t.has(g.BootModule)||t.register(g.BootModule),[2,t]})})},e.prototype.bindProvider=function(o,e){var i=[];return e.forEach(function(r,e){if(!d.isUndefined(r)&&!d.isNull(r))if(d.isProviderMap(r))r.forEach(function(e,t){i.push(e),o.bindProvider(e,t)});else if(r instanceof d.Provider)i.push(r.type),o.bindProvider(r.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.resolve.apply(r,[o].concat(e))});else if(d.isClass(r))o.has(r)||(i.push(r),o.register(r));else if(d.isBaseObject(r)){var t=r,n=!1;d.isToken(t.provide)?(d.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){d.isClass(e)&&!o.has(e)&&o.register(e)}),d.isUndefined(t.useValue)?d.isClass(t.useClass)?(o.has(t.useClass)||o.register(t.useClass),i.push(t.provide),o.bindProvider(t.provide,t.useClass)):d.isFunction(t.useFactory)?(i.push(t.provide),o.bindProvider(t.provide,function(){var e=[];return d.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return d.isClass(e)?o.get(e):e})),t.useFactory.apply(t,e)})):d.isToken(t.useExisting)?o.has(t.useExisting)?(i.push(t.provide),o.bindProvider(t.provide,t.useExisting)):console.log("has not register:",t.useExisting):n=!0:(i.push(t.provide),o.bindProvider(t.provide,function(){return t.useValue}))):n=!0,n&&d.lang.forIn(r,function(e,t){d.isUndefined(e)||(d.isClass(e)?o.bindProvider(t,e):d.isFunction(e)||d.isString(e)?o.bindProvider(t,function(){return e}):o.bindProvider(t,e),i.push(t))})}else d.isFunction(r)&&(i.push(name),o.bindProvider(name,function(){return r}))}),i},e.classAnnations={name:"ModuleBuilder",params:{constructor:[],getContainer:["token","defaultContainer"],createContainer:[],getContainerBuilder:[],createContainerBuilder:[],load:["token","defaultContainer"],build:["token","defaults"],bootstrap:["token","data","defaultContainer"],getBuilder:["container","cfg"],getBootstrapBuilder:["container","bootBuilder"],getDefaultBootBuilder:["container"],importModule:["token","container"],getDecorator:[],getConfigure:["token","container"],registerDepdences:["container","config"],getBootstrapToken:["cfg"],importConfigExports:["container","providerContainer","cfg"],registerConfgureDepds:["container","config"],getMetaConfig:["bootModule"],isIocExt:["token"],isDIModule:["token"],registerExts:["container","config"],bindProvider:["container","providers"]}},c.__decorate([d.Inject(d.ContainerBuilderToken),c.__metadata("design:type",Object)],e.prototype,"containerBuilder",void 0),e=n=c.__decorate([d.Singleton(l.ModuleBuilderToken),c.__metadata("design:paramtypes",[])],e)}();t.ModuleBuilder=r});e(a);a.InjectModuleLoadToken,a.ModuleBuilder;var u=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(i){function t(e){var t=i.call(this)||this;return t.baseURL=e,t.globalModules=[],t.customRegs=[],t}return c.__extends(t,i),t.create=function(e){return new t(e)},t.prototype.useConfiguration=function(e,t){var n;if(this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig())),d.isString(e)){if(t){var r=t.resolve(d.ContainerBuilderToken);n=r.loader.load([e]).then(function(e){return e.length?e[0]:null})}}else e&&(n=Promise.resolve(e));return n&&(this.globalConfig=this.globalConfig.then(function(r){return n.then(function(e){var t=e.default?e.default:e;return r=d.lang.assign(r||{},t||{})})})),this},t.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.globalModules=this.globalModules.concat(e),this},t.prototype.registerConfgureDepds=function(r,n){return c.__awaiter(this,void 0,void 0,function(){var t;return c.__generator(this,function(e){switch(e.label){case 0:return this.globalConfig||this.useConfiguration(),[4,this.globalConfig];case 1:return t=e.sent(),n=this.mergeGlobalConfig(t,n),this.bindAppConfig(n),[4,i.prototype.registerConfgureDepds.call(this,r,n)];case 2:return[2,n=e.sent()]}})})},t.prototype.mergeGlobalConfig=function(e,t){return d.lang.assign({},e,t)},t.prototype.registerExts=function(n,o){return c.__awaiter(this,void 0,void 0,function(){var t,r=this;return c.__generator(this,function(e){switch(e.label){case 0:return[4,i.prototype.registerExts.call(this,n,o)];case 1:return e.sent(),o.exports=o.exports||[],this.globalModules.length?(t=this.globalModules,[4,n.loadModule.apply(n,t)]):[3,3];case 2:e.sent(),e.label=3;case 3:return this.customRegs.length?[4,Promise.all(this.customRegs.map(function(t){return c.__awaiter(r,void 0,void 0,function(){return c.__generator(this,function(e){switch(e.label){case 0:return[4,t(n,o,this)];case 1:return[2,e.sent()]}})})}))]:[3,5];case 4:e.sent(),e.label=5;case 5:return[2,n]}})})},t.prototype.bindAppConfig=function(e){return this.baseURL&&(e.baseURL=this.baseURL),e},t.prototype.getDefaultConfig=function(){return{debug:!1}},t.classAnnations={name:"DefaultApplicationBuilder",params:{constructor:["baseURL"],create:["baseURL"],useConfiguration:["config","container"],use:["modules"],registerConfgureDepds:["container","config"],mergeGlobalConfig:["globalCfg","moduleCfg"],registerExts:["container","config"],bindAppConfig:["config"],getDefaultConfig:[]}},t}(a.ModuleBuilder);t.DefaultApplicationBuilder=r});e(u);u.DefaultApplicationBuilder;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),c.__exportStar(o,t),c.__exportStar(i,t),c.__exportStar(u,t),c.__exportStar(n,t),c.__exportStar(l,t),c.__exportStar(a,t),c.__exportStar(g,t),c.__exportStar(p,t),c.__exportStar(f,t),c.__exportStar(h,t)}))});