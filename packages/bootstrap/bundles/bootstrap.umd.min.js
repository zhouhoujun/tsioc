!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(s,a){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}s=s&&s.hasOwnProperty("default")?s.default:s,a=a&&a.hasOwnProperty("default")?a.default:a;var r=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(t){function e(e){return t.call(this,"_IOC_ModuleBuilder",e)||this}return s.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(a.Registration);t.InjectModuleBuilder=n,t.ModuleBuilderToken=new n("")});e(r);r.InjectModuleBuilder,r.ModuleBuilderToken;var i=t(function(e,t){function n(t,n,r,o,i){return a.createClassDecorator("DIModule",function(e){o&&o(e),e.next({match:function(e){return e&&(a.isString(e)||a.isObject(e)&&e instanceof a.Registration)},setMetadata:function(e,t){a.isString(t)?e.name=t:e.provide=t}}),e.next({match:function(e){return a.isString(e)||a.isToken(e)},setMetadata:function(e,t){a.isString(t)?e.name=t:e.builder=t}}),e.next({match:function(e){return a.isString(e)},setMetadata:function(e,t){e.name=t}})},function(e){(i&&(e=i(e)),!e.name&&a.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||r,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=n),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createDIModuleDecorator=n,t.DIModule=n("",r.ModuleBuilderToken)});e(i);i.createDIModuleDecorator,i.DIModule;var o=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(t){function e(e){return t.call(this,"Application",e)||this}return s.__extends(e,t),e.classAnnations={name:"InjectApplicationToken",params:{constructor:["desc"]}},e}(a.Registration);t.InjectApplicationToken=n,t.ApplicationToken=new n("")});e(o);o.InjectApplicationToken,o.ApplicationToken;var n=t(function(e,t){function n(e,t,n,r,o){return i.createDIModuleDecorator(e,t,n,r,o)}Object.defineProperty(t,"__esModule",{value:!0}),t.createBootstrapDecorator=n,t.Bootstrap=n("bootstrap",r.ModuleBuilderToken,o.ApplicationToken)});e(n);n.createBootstrapDecorator,n.Bootstrap;var u=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),s.__exportStar(i,t),s.__exportStar(n,t)});e(u);var c=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return(t=e).prototype.build=function(o,i){return s.__awaiter(this,void 0,void 0,function(){var t,n,r;return s.__generator(this,function(e){switch(e.label){case 0:return t=this.getConfigure(o),[4,(n=this.getBuilder(t)).createInstance(a.isToken(o)?o:null,t,i)];case 1:return r=e.sent(),[4,n.buildStrategy(r,t)];case 2:return e.sent(),[2,r]}})})},e.prototype.buildStrategy=function(t,e){return s.__awaiter(this,void 0,void 0,function(){return s.__generator(this,function(e){return[2,t]})})},e.prototype.getBuilder=function(e){var t;if(e.builder)t=this.getBuilderViaConfig(e.builder);else{var n=this.getBootstrapToken(e);n&&(t=this.getBuilderViaToken(n))}return t||this},e.prototype.getDecorator=function(){return u.DIModule.toString()},e.prototype.getConfigure=function(e){var t;if(a.isClass(e))t=this.getMetaConfig(e);else if(a.isToken(e)){var n=this.container.getTokenImpl(e);a.isClass(n)&&(t=this.getMetaConfig(n))}else{t=e;var r=this.getBootstrapToken(t),o=a.isClass(r)?r:this.container.getTokenImpl(r);a.isClass(o)&&(t=a.lang.assign({},this.getMetaConfig(o),t||{}))}return t||{}},e.prototype.createInstance=function(n,r,e){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:if(!(t=this.getBootstrapToken(r,n)))throw new Error("not find bootstrap token.");return[4,this.registerDepdences(r)];case 1:return e.sent(),a.isClass(t)&&(this.container.has(t)||this.container.register(t)),[2,this.container.resolve(t)]}})})},e.prototype.getBootstrapToken=function(e,t){return e.bootstrap||t},e.prototype.getBuilderViaConfig=function(e){return a.isToken(e)?this.container.resolve(e):e instanceof t?e:null},e.prototype.getBuilderViaToken=function(e){if(a.isToken(e)){var t=a.isClass(e)?e:this.container.getTokenImpl(e);if(t){var n=a.lang.first(a.getTypeMetadata(this.getDecorator(),t));if(n&&n.builder)return a.isToken(n.builder)?this.container.resolve(n.builder):n.builder}}return null},e.prototype.getMetaConfig=function(e){var t=this.getDecorator();if(a.hasClassMetadata(t,e)){var n=a.getTypeMetadata(t,e);if(n&&n.length){var r=n[0];return r.bootstrap=r.bootstrap||e,a.lang.omit(r,"builder")}}return null},e.prototype.registerDepdences=function(n){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return a.isArray(n.imports)&&n.imports.length?[4,(t=this.container).loadModule.apply(t,n.imports)]:[3,2];case 1:e.sent(),e.label=2;case 2:return a.isArray(n.providers)&&n.providers.length&&this.bindProvider(this.container,n.providers),[2,this.container]}})})},e.prototype.bindProvider=function(o,e){e.forEach(function(n,e){if(!a.isUndefined(n)&&!a.isNull(n))if(a.isProviderMap(n))n.forEach(function(e,t){o.bindProvider(e,t)});else if(n instanceof a.Provider)o.bindProvider(n.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.resolve.apply(n,[o].concat(e))});else if(a.isClass(n))o.has(n)||o.register(n);else if(a.isBaseObject(n)){var t=n,r=!1;a.isToken(t.provide)?(a.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){a.isClass(e)&&!o.has(e)&&o.register(e)}),a.isUndefined(t.useValue)?a.isClass(t.useClass)?(o.has(t.useClass)||o.register(t.useClass),o.bindProvider(t.provide,t.useClass)):a.isFunction(t.useFactory)?o.bindProvider(t.provide,function(){var e=[];return a.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return a.isClass(e)?o.get(e):e})),t.useFactory.apply(t,e)}):a.isToken(t.useExisting)?o.has(t.useExisting)?o.bindProvider(t.provide,t.useExisting):console.log("has not register:",t.useExisting):r=!0:o.bindProvider(t.provide,function(){return t.useValue})):r=!0,r&&a.lang.forIn(n,function(e,t){a.isUndefined(e)||(a.isClass(e)?o.bindProvider(t,e):a.isFunction(e)||a.isString(e)?o.bindProvider(t,function(){return e}):o.bindProvider(t,e))})}else a.isFunction(n)&&o.bindProvider(name,function(){return n})})},e.classAnnations={name:"ModuleBuilder",params:{constructor:[],build:["token","data"],buildStrategy:["instance","config"],getBuilder:["config"],getDecorator:[],getConfigure:["token"],createInstance:["token","cfg","data"],getBootstrapToken:["cfg","token"],getBuilderViaConfig:["builder"],getBuilderViaToken:["mdl"],getMetaConfig:["bootModule"],registerDepdences:["config"],bindProvider:["container","providers"]}},s.__decorate([a.Inject(a.ContainerToken),s.__metadata("design:type",Object)],e.prototype,"container",void 0),e=t=s.__decorate([a.Injectable(r.ModuleBuilderToken),s.__metadata("design:paramtypes",[])],e);var t}();t.ModuleBuilder=n});e(c);c.ModuleBuilder;var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(a.LifeScopeToken);t.registerDecorator(u.DIModule,a.CoreActions.bindProvider,a.CoreActions.cache,a.CoreActions.componentBeforeInit,a.CoreActions.componentInit,a.CoreActions.componentAfterInit),t.registerDecorator(u.Bootstrap,a.CoreActions.bindProvider,a.CoreActions.cache,a.CoreActions.componentBeforeInit,a.CoreActions.componentInit,a.CoreActions.componentAfterInit),e.register(c.ModuleBuilder),e.register(d.ApplicationBuilder)},e.classAnnations={name:"BootstrapModule",params:{constructor:["container"],setup:[]}},e=s.__decorate([a.IocExt("setup"),s.__param(0,a.Inject(a.ContainerToken)),s.__metadata("design:paramtypes",[Object])],e)}();t.BootstrapModule=n});e(l);l.BootstrapModule;var d=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.baseURL=e,this.usedModules=[],this.customRegs=[]}return e.prototype.getContainer=function(){return this.container||(this.container=this.getContainerBuilder().create()),this.container},e.prototype.setContainer=function(e){return e&&(this.container=e,this.builder=e.get(a.ContainerBuilderToken)),this},e.prototype.getContainerBuilder=function(){return this.builder||(this.builder=this.createContainerBuilder()),this.builder},e.prototype.setContainerBuilder=function(e){return this.builder=e,this.container=null,this},e.prototype.getModuleBuilder=function(){return this.moduleBuilder||(this.moduleBuilder=this.createModuleBuilder()),this.moduleBuilder},e.prototype.setModuleBuilder=function(e){return this.moduleBuilder=e,this},e.prototype.useConfiguration=function(e){var t;this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig()));var n=this.getContainerBuilder();return a.isString(e)?t=n.loader.load(e).then(function(e){return e.length?e[0]:null}):e&&(t=Promise.resolve(e)),t&&(this.globalConfig=this.globalConfig.then(function(n){return t.then(function(e){var t=e.default?e.default:e;return n=a.lang.assign(n||{},t||{})})})),this},e.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.usedModules=this.usedModules.concat(e),this},e.prototype.registerModules=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.customRegs=this.customRegs.concat(e),this},e.prototype.bootstrap=function(t){return s.__awaiter(this,void 0,void 0,function(){return s.__generator(this,function(e){switch(e.label){case 0:return[4,this.build(t)];case 1:return[2,e.sent()]}})})},e.prototype.build=function(o){return s.__awaiter(this,void 0,void 0,function(){var t,n,r;return s.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(),[4,this.registerExts(t)];case 1:return e.sent(),n=this.getModuleBuilder(),[4,this.mergeConfigure(n.getConfigure(o))];case 2:return r=e.sent(),this.bindConfiguration(t,r),[4,this.initContainer(r,t)];case 3:return e.sent(),r.bootstrap||(r.bootstrap=a.isToken(o)?o:null),[4,this.createInstance(n,r)];case 4:return[2,e.sent()]}})})},e.prototype.createInstance=function(e,t){return e.build(t)},e.prototype.createModuleBuilder=function(){return this.getContainer().get(r.ModuleBuilderToken)},e.prototype.createContainerBuilder=function(){return new a.DefaultContainerBuilder},e.prototype.registerExts=function(n){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return n.has(l.BootstrapModule)||n.register(l.BootstrapModule),this.usedModules.length?(t=this.usedModules,this.usedModules=[],[4,n.loadModule.apply(n,[n].concat(t))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2,n]}})})},e.prototype.initContainer=function(r,o){return s.__awaiter(this,void 0,void 0,function(){var t,n=this;return s.__generator(this,function(e){switch(e.label){case 0:return this.customRegs.length?(t=this.customRegs,this.customRegs=[],[4,Promise.all(t.map(function(e){return e(o,r,n)}))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2,o]}})})},e.prototype.bindConfiguration=function(e,t){this.baseURL&&(t.baseURL=this.baseURL)},e.prototype.mergeConfigure=function(n){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return this.globalConfig||this.useConfiguration(),[4,this.globalConfig];case 1:return t=e.sent(),[2,a.lang.assign({},t,n)]}})})},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"ApplicationBuilder",params:{constructor:["baseURL"],getContainer:[],setContainer:["container"],getContainerBuilder:[],setContainerBuilder:["builder"],getModuleBuilder:[],setModuleBuilder:["builder"],useConfiguration:["config"],use:["modules"],registerModules:["moduleRegs"],bootstrap:["token"],build:["token"],createInstance:["builder","config"],createModuleBuilder:[],createContainerBuilder:[],registerExts:["container"],initContainer:["config","container"],bindConfiguration:["container","config"],mergeConfigure:["cfg"],getDefaultConfig:[]}},e}();t.ApplicationBuilder=n});e(d);d.ApplicationBuilder;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),s.__exportStar(u,t),s.__exportStar(d,t),s.__exportStar(o,t),s.__exportStar(r,t),s.__exportStar(c,t),s.__exportStar(l,t)}))});