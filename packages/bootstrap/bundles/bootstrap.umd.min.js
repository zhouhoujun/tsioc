!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(l,c){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}l=l&&l.hasOwnProperty("default")?l.default:l,c=c&&c.hasOwnProperty("default")?c.default:c;var s=t(function(e,t){function r(t,r,o,n,i,s){return c.createClassDecorator("DIModule",function(e){i&&i(e)},function(e){(s&&(e=s(e)),!e.name&&c.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||n,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=r),e.bootBuilder||(e.bootBuilder=o),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createDIModuleDecorator=r,t.DIModule=r("module")});e(s);s.createDIModuleDecorator,s.DIModule;var o=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationBuilderToken=new c.InjectToken("DI_AppBuilder")});e(o);o.ApplicationBuilderToken;var r=t(function(e,t){function r(e,t,r,o,n,i){return s.createDIModuleDecorator(e,t,r,o,n,i)}Object.defineProperty(t,"__esModule",{value:!0}),t.createBootstrapDecorator=r,t.Bootstrap=r("bootstrap",o.ApplicationBuilderToken)});e(r);r.createBootstrapDecorator,r.Bootstrap;var n=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),l.__exportStar(s,t),l.__exportStar(r,t)});e(n);var i=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AppConfigurationToken=new c.InjectToken("DI_APP_Configuration")});e(i);i.AppConfigurationToken;var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_ModuleBuilder",e)||this}return l.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(c.Registration);t.InjectModuleBuilder=r,t.ModuleBuilderToken=new r("")});e(a);a.InjectModuleBuilder,a.ModuleBuilderToken;var u=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_ModuleBootstrap",e)||this}return l.__extends(e,t),e.classAnnations={name:"InjectBootstrapBuilder",params:{constructor:["desc"]}},e}(c.Registration);t.InjectBootstrapBuilder=r,t.BootstrapBuilderToken=new r("")});e(u);u.InjectBootstrapBuilder,u.BootstrapBuilderToken;var d=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return(r=e).prototype.build=function(n,i){return l.__awaiter(this,void 0,void 0,function(){var t,r,o;return l.__generator(this,function(e){switch(e.label){case 0:if(t=this.getBuilder(n),n.bootstrap||(n.bootstrap=t.getBootstrapToken(n)),!n.bootstrap)throw new Error("cant not find bootstrap token.");if(!(r=n.container))throw new Error("cant not find container.");return o=r.resolve(n.bootstrap,i),[4,t.buildStrategy(o,n)];case 1:return o=e.sent(),[2,n.bootInstance=o]}})})},e.prototype.getBootstrapToken=function(e){return e.bootstrap||e.moduleToken},e.prototype.buildStrategy=function(t,e){return l.__awaiter(this,void 0,void 0,function(){return l.__generator(this,function(e){return[2,t]})})},e.prototype.getBuilder=function(e){if(!e.bootBuilder){var t=void 0;e.moduleConfig.bootBuilder&&(t=this.getBuilderViaConfig(e.moduleConfig.bootBuilder,e.container)),t||(t=this),e.bootBuilder=t}return e.bootBuilder},e.prototype.getBuilderViaConfig=function(e,t){return c.isToken(e)?t.resolve(e):e instanceof r?e:null},e.classAnnations={name:"BootstrapBuilder",params:{constructor:[],build:["iocModule","data"],getBootstrapToken:["iocModule"],buildStrategy:["instance","iocModule"],getBuilder:["iocModule"],getBuilderViaConfig:["builder","container"]}},e=r=l.__decorate([c.Singleton(u.BootstrapBuilderToken),l.__metadata("design:paramtypes",[])],e);var r}();t.BootstrapBuilder=r});e(d);d.BootstrapBuilder;var p=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(c.LifeScopeToken);t.registerDecorator(n.DIModule,c.CoreActions.bindProvider,c.CoreActions.cache,c.CoreActions.componentBeforeInit,c.CoreActions.componentInit,c.CoreActions.componentAfterInit),t.registerDecorator(n.Bootstrap,c.CoreActions.bindProvider,c.CoreActions.cache,c.CoreActions.componentBeforeInit,c.CoreActions.componentInit,c.CoreActions.componentAfterInit),e.register(f.ModuleBuilder),e.register(d.BootstrapBuilder),e.register(g.DefaultApplicationBuilder)},e.classAnnations={name:"BootModule",params:{constructor:["container"],setup:[]}},e=l.__decorate([c.IocExt("setup"),l.__param(0,c.Inject(c.ContainerToken)),l.__metadata("design:paramtypes",[Object])],e)}();t.BootModule=r});e(p);p.BootModule;var f=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var s="__exportProviders",r=function(){function o(){}return o.prototype.getContainer=function(e,t){var r;if(c.isClass(e)){if(e.__di)return e.__di;var o=this.getConfigure(e);o.container?e.__di=o.container:e.__di=t||this.createContainer(),r=e.__di}else r=e.container?e.container:e.container=t||this.createContainer();return r},o.prototype.createContainer=function(){return this.getContainerBuilder().create()},o.prototype.getContainerBuilder=function(){return this.containerBuilder||(this.containerBuilder=this.createContainerBuilder()),this.containerBuilder},o.prototype.createContainerBuilder=function(){return new c.DefaultContainerBuilder},o.prototype.build=function(a,u){return l.__awaiter(this,void 0,void 0,function(){var t,r,o,n,i,s;return l.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(a,u),r=c.isToken(a)?a:a.name,c.isToken(r)&&t.has(r)?[2,t.resolve(r)]:(o=this.getConfigure(a,t),(n=this.getBuilder(t,o))&&n!==this?[4,n.build(a,t)]:[3,2]);case 1:return[2,e.sent()];case 2:return[4,this.registerDepdences(t,o)];case 3:return o=e.sent(),i=this.getBootstrapToken(o,r),(s=this.createModuleInstance(r,t)).bootstrap=i,s.container=t,s.bootBuilder||(s.bootBuilder=this.getBootstrapBuilder(t,o)),s.moduleConfig=o,c.isClass(i)&&(t.has(i)||t.register(i)),c.isToken(r)&&(s.moduleToken=r,t.bindProvider(r,s)),c.isFunction(s.mdOnLoaded)&&s.mdOnLoaded(s),[2,s]}})})},o.prototype.createModuleInstance=function(e,t){return!e||c.isString(e)||c.isClass(e)&&!t.has(e)&&t.register(e),t.resolve(e)},o.prototype.getBuilder=function(e,t){var r;return c.isClass(t.builder)&&(e.has(t.builder)||e.register(t.builder)),c.isToken(t.builder)?r=e.resolve(t.builder):t.builder instanceof o&&(r=t.builder),r},o.prototype.getBootstrapBuilder=function(e,t){var r;return c.isClass(t.bootBuilder)&&(e.has(t.bootBuilder)||e.register(t.bootBuilder)),c.isToken(t.bootBuilder)?r=e.resolve(t.bootBuilder):t.bootBuilder instanceof d.BootstrapBuilder&&(r=t.bootBuilder),r},o.prototype.bootstrap=function(o,n){return l.__awaiter(this,void 0,void 0,function(){var t,r;return l.__generator(this,function(e){switch(e.label){case 0:return[4,this.build(o,n)];case 1:return t=e.sent(),c.isFunction(t.mdBeforeCreate)&&t.mdBeforeCreate(t),[4,this.createBootstrap(t)];case 2:return r=e.sent(),c.isFunction(t.mdAfterCreate)&&t.mdAfterCreate(r),c.isFunction(t.mdOnStart)?[4,Promise.resolve(t.mdOnStart(r))]:[3,4];case 3:e.sent(),e.label=4;case 4:return c.isFunction(t.mdOnStarted)&&t.mdOnStarted(r),[2,t]}})})},o.prototype.createBootstrap=function(t){return l.__awaiter(this,void 0,void 0,function(){return l.__generator(this,function(e){switch(e.label){case 0:return[4,(t.bootBuilder||t.container.resolve(u.BootstrapBuilderToken)).build(t)];case 1:return[2,e.sent()]}})})},o.prototype.importModule=function(r,o){return l.__awaiter(this,void 0,void 0,function(){var t;return l.__generator(this,function(e){switch(e.label){case 0:return o&&c.isClass(r)&&!this.isDIModule(r)?(o.register(r),[2,o]):[4,this.build(r)];case 1:return t=e.sent(),o.has(t.moduleToken)?[3,3]:[4,this.importConfigExports(o,t.container,t.moduleConfig)];case 2:e.sent(),t.container.parent=o,t.moduleToken&&o.bindProvider(t.moduleToken,t),e.label=3;case 3:return[2,o]}})})},o.prototype.getDecorator=function(){return n.DIModule.toString()},o.prototype.getConfigure=function(e,t){var r;if(c.isClass(e))r=this.getMetaConfig(e);else if(c.isToken(e)){var o=t?t.getTokenImpl(e):e;c.isClass(o)&&(r=this.getMetaConfig(o))}else{r=e;var n=this.getBootstrapToken(r);if(n){var i=c.isClass(n)?n:t?t.getTokenImpl(n):n;c.isClass(i)&&(r=c.lang.assign({},this.getMetaConfig(i),r||{}))}}return r||{}},o.prototype.registerDepdences=function(t,r){return l.__awaiter(this,void 0,void 0,function(){return l.__generator(this,function(e){switch(e.label){case 0:return[4,this.registerExts(t,r)];case 1:return e.sent(),[4,this.registerConfgureDepds(t,r)];case 2:return[2,r=e.sent()]}})})},o.prototype.getBootstrapToken=function(e,t){return e.bootstrap},o.prototype.importConfigExports=function(n,i,r){return l.__awaiter(this,void 0,void 0,function(){var t,o=this;return l.__generator(this,function(e){switch(e.label){case 0:return r.exports&&r.exports.length?[4,Promise.all(r.exports.map(function(r){return l.__awaiter(o,void 0,void 0,function(){return l.__generator(this,function(e){return n.bindProvider(r,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.resolve.apply(i,[r].concat(e))}),[2,r]})})}))]:[3,2];case 1:e.sent(),e.label=2;case 2:return(t=r[s])&&t.length&&t.forEach(function(e){n.bindProvider(e,function(){return i.get(e)})}),[2,n]}})})},o.prototype.registerConfgureDepds=function(o,n){return l.__awaiter(this,void 0,void 0,function(){var t,r=this;return l.__generator(this,function(e){switch(e.label){case 0:return c.isArray(n.imports)&&n.imports.length?[4,o.get(c.ContainerBuilderToken).loader.loadTypes(n.imports,function(e){return r.isIocExt(e)||r.isDIModule(e)})]:[3,3];case 1:return t=e.sent(),[4,Promise.all(t.map(function(e){return r.importModule(e,o)}))];case 2:e.sent(),e.label=3;case 3:return c.isArray(n.providers)&&n.providers.length&&(n[s]=this.bindProvider(o,n.providers)),[2,n]}})})},o.prototype.getMetaConfig=function(e){var t=this.getDecorator();if(this.isDIModule(e)){var r=c.getTypeMetadata(t,e);if(r&&r.length){var o=r[0];return c.lang.omit(o,"builder")}}return null},o.prototype.isIocExt=function(e){return c.hasOwnClassMetadata(c.IocExt,e)},o.prototype.isDIModule=function(e){return!!c.isClass(e)&&(!!c.hasOwnClassMetadata(this.getDecorator(),e)||c.hasOwnClassMetadata(n.DIModule,e))},o.prototype.registerExts=function(t,e){return l.__awaiter(this,void 0,void 0,function(){return l.__generator(this,function(e){return t.has(p.BootModule)||t.register(p.BootModule),[2,t]})})},o.prototype.bindProvider=function(n,e){var i=[];return e.forEach(function(r,e){if(!c.isUndefined(r)&&!c.isNull(r))if(c.isProviderMap(r))r.forEach(function(e,t){i.push(e),n.bindProvider(e,t)});else if(r instanceof c.Provider)i.push(r.type),n.bindProvider(r.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.resolve.apply(r,[n].concat(e))});else if(c.isClass(r))n.has(r)||(i.push(r),n.register(r));else if(c.isBaseObject(r)){var t=r,o=!1;c.isToken(t.provide)?(c.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){c.isClass(e)&&!n.has(e)&&n.register(e)}),c.isUndefined(t.useValue)?c.isClass(t.useClass)?(n.has(t.useClass)||n.register(t.useClass),i.push(t.provide),n.bindProvider(t.provide,t.useClass)):c.isFunction(t.useFactory)?(i.push(t.provide),n.bindProvider(t.provide,function(){var e=[];return c.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return c.isClass(e)?n.get(e):e})),t.useFactory.apply(t,e)})):c.isToken(t.useExisting)?n.has(t.useExisting)?(i.push(t.provide),n.bindProvider(t.provide,t.useExisting)):console.log("has not register:",t.useExisting):o=!0:(i.push(t.provide),n.bindProvider(t.provide,function(){return t.useValue}))):o=!0,o&&c.lang.forIn(r,function(e,t){c.isUndefined(e)||(c.isClass(e)?n.bindProvider(t,e):c.isFunction(e)||c.isString(e)?n.bindProvider(t,function(){return e}):n.bindProvider(t,e),i.push(t))})}else c.isFunction(r)&&(i.push(name),n.bindProvider(name,function(){return r}))}),i},o.classAnnations={name:"BaseModuleBuilder",params:{constructor:[],getContainer:["token","defaultContainer"],createContainer:[],getContainerBuilder:[],createContainerBuilder:[],build:["token","defaultContainer"],createModuleInstance:["token","container"],getBuilder:["container","cfg"],getBootstrapBuilder:["container","cfg"],bootstrap:["token","defaultContainer"],createBootstrap:["iocModule"],importModule:["token","container"],getDecorator:[],getConfigure:["token","container"],registerDepdences:["container","config"],getBootstrapToken:["cfg","token"],importConfigExports:["container","providerContainer","cfg"],registerConfgureDepds:["container","config"],getMetaConfig:["bootModule"],isIocExt:["token"],isDIModule:["token"],registerExts:["container","config"],bindProvider:["container","providers"]}},l.__decorate([c.Inject(c.ContainerBuilderToken),l.__metadata("design:type",Object)],o.prototype,"containerBuilder",void 0),o}(),o=function(r){function e(){return null!==r&&r.apply(this,arguments)||this}return l.__extends(e,r),e.prototype.build=function(e,t){return r.prototype.build.call(this,e,t)},e.prototype.bootstrap=function(e,t){return r.prototype.bootstrap.call(this,e,t)},e.classAnnations={name:"ModuleBuilder",params:{build:["token","defaultContainer"],bootstrap:["token","defaultContainer"]}},e=l.__decorate([c.Singleton(a.ModuleBuilderToken),c.Injectable()],e)}(t.BaseModuleBuilder=r);t.ModuleBuilder=o});e(f);f.BaseModuleBuilder,f.ModuleBuilder;var g=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(i){function e(e){var t=i.call(this)||this;return t.baseURL=e,t.globalModules=[],t.customRegs=[],t}return l.__extends(e,i),e.prototype.useConfiguration=function(e,t){var o;if(this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig())),c.isString(e)){if(t){var r=t.resolve(c.ContainerBuilderToken);o=r.loader.load([e]).then(function(e){return e.length?e[0]:null})}}else e&&(o=Promise.resolve(e));return o&&(this.globalConfig=this.globalConfig.then(function(r){return o.then(function(e){var t=e.default?e.default:e;return r=c.lang.assign(r||{},t||{})})})),this},e.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.globalModules=this.globalModules.concat(e),this},e.prototype.registerConfgureDepds=function(r,o){return l.__awaiter(this,void 0,void 0,function(){var t;return l.__generator(this,function(e){switch(e.label){case 0:return this.globalConfig||this.useConfiguration(),[4,this.globalConfig];case 1:return t=e.sent(),o=this.mergeGlobalConfig(t,o),this.bindAppConfig(o),[4,i.prototype.registerConfgureDepds.call(this,r,o)];case 2:return[2,o=e.sent()]}})})},e.prototype.mergeGlobalConfig=function(e,t){return c.lang.assign({},e,t)},e.prototype.registerExts=function(o,n){return l.__awaiter(this,void 0,void 0,function(){var t,r=this;return l.__generator(this,function(e){switch(e.label){case 0:return[4,i.prototype.registerExts.call(this,o,n)];case 1:return e.sent(),n.exports=n.exports||[],this.globalModules.length?(t=this.globalModules,[4,o.loadModule.apply(o,t)]):[3,3];case 2:e.sent(),e.label=3;case 3:return this.customRegs.length?[4,Promise.all(this.customRegs.map(function(t){return l.__awaiter(r,void 0,void 0,function(){return l.__generator(this,function(e){switch(e.label){case 0:return[4,t(o,n,this)];case 1:return[2,e.sent()]}})})}))]:[3,5];case 4:e.sent(),e.label=5;case 5:return[2,o]}})})},e.prototype.bindAppConfig=function(e){return this.baseURL&&(e.baseURL=this.baseURL),e},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"DefaultApplicationBuilder",params:{constructor:["baseURL"],useConfiguration:["config","container"],use:["modules"],registerConfgureDepds:["container","config"],mergeGlobalConfig:["globalCfg","moduleCfg"],registerExts:["container","config"],bindAppConfig:["config"],getDefaultConfig:[]}},e}(f.BaseModuleBuilder);t.DefaultApplicationBuilder=r});e(g);g.DefaultApplicationBuilder;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),l.__exportStar(n,t),l.__exportStar(i,t),l.__exportStar(g,t),l.__exportStar(o,t),l.__exportStar(a,t),l.__exportStar(f,t),l.__exportStar(p,t),l.__exportStar(u,t),l.__exportStar(d,t)}))});