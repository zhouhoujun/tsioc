!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(s,u){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}s=s&&s.hasOwnProperty("default")?s.default:s,u=u&&u.hasOwnProperty("default")?u.default:u;var r=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Bootstrap=u.createClassDecorator("Bootstrap")});e(r);r.Bootstrap;var o=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DefModule=u.createClassDecorator("DefModule")});e(o);o.DefModule;var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),s.__exportStar(r,t),s.__exportStar(o,t)});e(a);var n=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"_IOC_ModuleBuilder",e)||this}return s.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(u.Registration);t.InjectModuleBuilder=r,t.ModuleBuilderToken=new r("")});e(n);n.InjectModuleBuilder,n.ModuleBuilderToken;var i=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.build=function(n,i){return s.__awaiter(this,void 0,void 0,function(){var t,r,o;return s.__generator(this,function(e){switch(e.label){case 0:return t=this.getConfigure(n,i),(r=this.getBootstrapToken(t,u.isToken(n)?n:null))?(o=this.container,[4,this.registerDepdences(t)]):[2,Promise.reject("not find bootstrap token.")];case 1:return e.sent(),u.isClass(r)&&(o.has(r)||o.register(r)),[2,o.resolve(r)]}})})},e.prototype.getBootstrapToken=function(e,t){return e.bootstrap||t},e.prototype.getConfigure=function(e,t){var r;if(t=t||a.DefModule,u.isClass(e))r=this.getMetaConfig(e,t);else if(u.isToken(e)){var o=this.container.getTokenImpl(e);u.isClass(o)&&(r=this.getMetaConfig(o,t))}else{r=e;var n=this.getBootstrapToken(r),i=u.isClass(n)?n:this.container.getTokenImpl(n);u.isClass(i)&&(r=u.lang.assign({},this.getMetaConfig(i,t),r||{}))}return r||{}},e.prototype.getMetaConfig=function(e,t){if(u.hasClassMetadata(t,e)){var r=u.getTypeMetadata(t,e);if(r&&r.length){var o=r[0];return o.bootstrap=o.bootstrap||e,o}}return null},e.prototype.registerDepdences=function(r){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return u.isArray(r.imports)&&r.imports.length?[4,(t=this.container).loadModule.apply(t,r.imports)]:[3,2];case 1:e.sent(),e.label=2;case 2:return u.isArray(r.providers)&&r.providers.length&&this.bindProvider(this.container,r.providers),[2,this.container]}})})},e.prototype.bindProvider=function(n,e){e.forEach(function(r,e){if(!u.isUndefined(r)&&!u.isNull(r))if(u.isProviderMap(r))r.forEach(function(e,t){n.bindProvider(e,t)});else if(r instanceof u.Provider)n.bindProvider(r.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.resolve.apply(r,[n].concat(e))});else if(u.isClass(r))n.has(r)||n.register(r);else if(u.isBaseObject(r)){var t=r,o=!1;u.isToken(t.provide)?(u.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){u.isClass(e)&&!n.has(e)&&n.register(e)}),u.isUndefined(t.useValue)?u.isClass(t.useClass)?(n.has(t.useClass)||n.register(t.useClass),n.bindProvider(t.provide,t.useClass)):u.isFunction(t.useFactory)?n.bindProvider(t.provide,function(){var e=[];return u.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return u.isClass(e)?n.get(e):e})),t.useFactory.apply(t,e)}):u.isToken(t.useExisting)?n.has(t.useExisting)?n.bindProvider(t.provide,t.useExisting):console.log("has not register:",t.useExisting):o=!0:n.bindProvider(t.provide,function(){return t.useValue})):o=!0,o&&u.lang.forIn(r,function(e,t){u.isUndefined(e)||(u.isClass(e)?n.bindProvider(t,e):u.isFunction(e)||u.isString(e)?n.bindProvider(t,function(){return e}):n.bindProvider(t,e))})}else u.isFunction(r)&&n.bindProvider(name,function(){return r})})},e.classAnnations={name:"ModuleBuilder",params:{constructor:[],build:["token","moduleDecorator"],getBootstrapToken:["cfg","token"],getConfigure:["token","moduleDecorator"],getMetaConfig:["bootModule","moduleDecorator"],registerDepdences:["config"],bindProvider:["container","providers"]}},s.__decorate([u.Inject(u.ContainerToken),s.__metadata("design:type",Object)],e.prototype,"container",void 0),e=s.__decorate([u.Injectable(n.ModuleBuilderToken),s.__metadata("design:paramtypes",[])],e)}();t.ModuleBuilder=r});e(i);i.ModuleBuilder;var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(u.LifeScopeToken);t.registerDecorator(a.DefModule,u.CoreActions.bindProvider,u.CoreActions.cache,u.CoreActions.componentBeforeInit,u.CoreActions.componentInit,u.CoreActions.componentAfterInit),t.registerDecorator(a.Bootstrap,u.CoreActions.bindProvider,u.CoreActions.cache,u.CoreActions.componentBeforeInit,u.CoreActions.componentInit,u.CoreActions.componentAfterInit),e.register(i.ModuleBuilder),e.register(c.ApplicationBuilder)},e.classAnnations={name:"BootstrapModule",params:{constructor:["container"],setup:[]}},e=s.__decorate([u.IocExt("setup"),s.__param(0,u.Inject(u.ContainerToken)),s.__metadata("design:paramtypes",[Object])],e)}();t.BootstrapModule=r});e(l);l.BootstrapModule;var c=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.baseURL=e,this.usedModules=[],this.customRegs=[]}return e.prototype.getContainer=function(){return this.container||(this.container=this.getContainerBuilder().create()),this.container},e.prototype.setContainer=function(e){return e&&(this.container=e,this.builder=e.get(u.ContainerBuilderToken)),this},e.prototype.getContainerBuilder=function(){return this.builder||(this.builder=this.createContainerBuilder()),this.builder},e.prototype.setContainerBuilder=function(e){return this.builder=e,this.container=null,this},e.prototype.getModuleBuilder=function(){return this.moduleBuilder||(this.moduleBuilder=this.createModuleBuilder()),this.moduleBuilder},e.prototype.setModuleBuilder=function(e){return this.moduleBuilder=e,this},e.prototype.useConfiguration=function(e){var t;this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig()));var r=this.getContainerBuilder();return u.isString(e)?t=r.loader.load(e).then(function(e){return e.length?e[0]:null}):e&&(t=Promise.resolve(e)),t&&(this.globalConfig=this.globalConfig.then(function(r){return t.then(function(e){var t=e.default?e.default:e;return r=u.lang.assign(r||{},t||{})})})),this},e.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.usedModules=this.usedModules.concat(e),this},e.prototype.registerModules=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.customRegs=this.customRegs.concat(e),this},e.prototype.bootstrap=function(t){return s.__awaiter(this,void 0,void 0,function(){return s.__generator(this,function(e){switch(e.label){case 0:return[4,this.build(t)];case 1:return[2,e.sent()]}})})},e.prototype.build=function(n){return s.__awaiter(this,void 0,void 0,function(){var t,r,o;return s.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(),[4,this.registerExts(t)];case 1:return e.sent(),r=this.getModuleBuilder(),[4,this.mergeConfigure(this.getModuleConfigure(r,n))];case 2:return o=e.sent(),this.bindConfiguration(t,o),[4,this.initContainer(o,t)];case 3:return e.sent(),o.bootstrap||(o.bootstrap=u.isToken(n)?n:null),[4,r.build(o)];case 4:return[2,e.sent()]}})})},e.prototype.createModuleBuilder=function(){return this.getContainer().get(n.ModuleBuilderToken)},e.prototype.createContainerBuilder=function(){return new u.DefaultContainerBuilder},e.prototype.getModuleConfigure=function(e,t){return e.getConfigure(t)},e.prototype.registerExts=function(r){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return r.has(l.BootstrapModule)||r.register(l.BootstrapModule),this.usedModules.length?(t=this.usedModules,this.usedModules=[],[4,r.loadModule.apply(r,[r].concat(t))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2,r]}})})},e.prototype.initContainer=function(o,n){return s.__awaiter(this,void 0,void 0,function(){var t,r=this;return s.__generator(this,function(e){switch(e.label){case 0:return this.customRegs.length?(t=this.customRegs,this.customRegs=[],[4,Promise.all(t.map(function(e){return e(n,o,r)}))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2,n]}})})},e.prototype.bindConfiguration=function(e,t){this.baseURL&&(t.baseURL=this.baseURL)},e.prototype.mergeConfigure=function(r){return s.__awaiter(this,void 0,void 0,function(){var t;return s.__generator(this,function(e){switch(e.label){case 0:return this.globalConfig||this.useConfiguration(),[4,this.globalConfig];case 1:return t=e.sent(),[2,u.lang.assign({},t,r)]}})})},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"ApplicationBuilder",params:{constructor:["baseURL"],getContainer:[],setContainer:["container"],getContainerBuilder:[],setContainerBuilder:["builder"],getModuleBuilder:[],setModuleBuilder:["builder"],useConfiguration:["config"],use:["modules"],registerModules:["moduleRegs"],bootstrap:["token"],build:["token"],createModuleBuilder:[],createContainerBuilder:[],getModuleConfigure:["builer","boot"],registerExts:["container"],initContainer:["config","container"],bindConfiguration:["container","config"],mergeConfigure:["cfg"],getDefaultConfig:[]}},e}();t.ApplicationBuilder=r});e(c);c.ApplicationBuilder;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),s.__exportStar(a,t),s.__exportStar(c,t),s.__exportStar(n,t),s.__exportStar(i,t),s.__exportStar(l,t)}))});