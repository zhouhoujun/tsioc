!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(d,p){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}d=d&&d.hasOwnProperty("default")?d.default:d,p=p&&p.hasOwnProperty("default")?p.default:p;var o=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_ModuleBuilder",e)||this}return d.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(p.Registration);t.InjectModuleBuilder=r,t.ModuleBuilderToken=new r(""),t.RootModuleBuilderToken=new r("RootModule"),t.RootContainerToken=new p.InjectToken("DI_RootContainer")});e(o);o.InjectModuleBuilder,o.ModuleBuilderToken,o.RootModuleBuilderToken,o.RootContainerToken;var r=t(function(e,t){function r(t,r,n,o,i){return p.createClassDecorator("DIModule",function(e){o&&o(e)},function(e){(i&&(e=i(e)),!e.name&&p.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||n,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=r),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createDIModuleDecorator=r,t.DIModule=r("module",o.ModuleBuilderToken)});e(r);r.createDIModuleDecorator,r.DIModule;var n=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationBuilderToken=new p.InjectToken("DI_AppBuilder")});e(n);n.ApplicationBuilderToken;var i=t(function(e,t){function r(t,r,n,o,i){return p.createClassDecorator("Bootstrap",function(e){o&&o(e)},function(e){(i&&(e=i(e)),!e.name&&p.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||n,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=r),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createBootstrapDecorator=r,t.Bootstrap=r("bootstrap",n.ApplicationBuilderToken)});e(i);i.createBootstrapDecorator,i.Bootstrap;var s=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),d.__exportStar(r,t),d.__exportStar(i,t)});e(s);var a=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.AppConfigurationToken=new p.InjectToken("DI_APP_Configuration")});e(a);a.AppConfigurationToken;var u=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(p.LifeScopeToken);t.registerDecorator(s.DIModule,p.CoreActions.bindProvider,p.CoreActions.cache,p.CoreActions.componentBeforeInit,p.CoreActions.componentInit,p.CoreActions.componentAfterInit),t.registerDecorator(s.Bootstrap,p.CoreActions.bindProvider,p.CoreActions.cache,p.CoreActions.componentBeforeInit,p.CoreActions.componentInit,p.CoreActions.componentAfterInit),e.register(c.ModuleBuilder),e.register(l.ApplicationBuilder)},e.classAnnations={name:"BootstrapModule",params:{constructor:["container"],setup:[]}},e=d.__decorate([p.IocExt("setup"),d.__param(0,p.Inject(p.ContainerToken)),d.__metadata("design:paramtypes",[Object])],e)}();t.BootstrapModule=r});e(u);u.BootstrapModule;var c=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var l="__exportProviders",r=function(){function e(){}return e.prototype.getContainer=function(){return this.container},e.prototype.resetContainer=function(){this.container=this.getContainerBuilder().create()},e.prototype.getContainerBuilder=function(){return this.getContainer().resolve(p.ContainerBuilderToken)},e.prototype.build=function(o,i){return d.__awaiter(this,void 0,void 0,function(){var t,r,n;return d.__generator(this,function(e){switch(e.label){case 0:return t=this.getConfigure(o),[4,this.mergeConfigure(t)];case 1:return t=e.sent(),[4,(r=this.getBuilder(t)).createInstance(p.isToken(o)?o:null,t,i)];case 2:return n=e.sent(),[4,r.buildStrategy(n,t)];case 3:return e.sent(),[2,n]}})})},e.prototype.buildStrategy=function(t,e){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(e){return[2,t]})})},e.prototype.importModule=function(u,c){return void 0===c&&(c=!1),d.__awaiter(this,void 0,void 0,function(){var t,r,n,o,i,s,a=this;return d.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(),p.isClass(u)&&!this.isDIModule(u)?(t.register(u),[2,t]):(r=this.getConfigure(u),n=this.getBuilder(r,c),c&&n.resetContainer(),o=n.getContainer(),[4,n.registerDepdences(o,r)]);case 1:return e.sent(),r.exports&&r.exports.length&&r.exports.forEach(function(r){if(p.isClass(r)){if(a.isDIModule(r))return;if(a.isIocExt(r))return void t.register(r)}t.bindProvider(r,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return o.resolve.apply(o,[r].concat(e))})}),(i=r[l])&&i.length&&i.forEach(function(e){t.bindProvider(e,function(){return o.get(e)})}),s=this.getBootstrapToken(r,p.isClass(u)?u:null),p.isToken(s)&&t.bindProvider(s,function(){return n.createInstance(s,r)}),[2,t]}})})},e.prototype.getBuilder=function(e,t){var r;if(void 0===t&&(t=!1),e.builder)r=this.getBuilderViaConfig(e.builder);else{var n=this.getBootstrapToken(e);n&&(r=this.getBuilderViaToken(n))}return r||(r=t?this.createBuilder():this),r.rootContainer=this.rootContainer,r},e.prototype.getDecorator=function(){return s.DIModule.toString()},e.prototype.getConfigure=function(e){var t,r=this.getContainer();if(p.isClass(e))t=this.getMetaConfig(e);else if(p.isToken(e)){var n=r.getTokenImpl(e);p.isClass(n)&&(t=this.getMetaConfig(n))}else{t=e;var o=this.getBootstrapToken(t),i=p.isClass(o)?o:r.getTokenImpl(o);p.isClass(i)&&(t=p.lang.assign({},this.getMetaConfig(i),t||{}))}return t||{}},e.prototype.createInstance=function(r,n,e){return d.__awaiter(this,void 0,void 0,function(){var t;return d.__generator(this,function(e){switch(e.label){case 0:if(!this.getBootstrapToken(n,r))throw new Error("not find bootstrap token.");return t=this.getContainer(),[4,this.registerDepdences(t,n)];case 1:return e.sent(),[2,this.resolveToken(t,r,n)]}})})},e.prototype.registerDepdences=function(t,r){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(e){switch(e.label){case 0:return[4,this.registerExts(t,r)];case 1:return e.sent(),this.canRegRootDepds()?[4,this.registerRootDepds(t,r)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[4,this.registerConfgureDepds(t,r)];case 4:return e.sent(),[2,t]}})})},e.prototype.resolveToken=function(e,t,r){return p.isClass(t)&&(e.has(t)||e.register(t)),e.resolve(t)},e.prototype.registerRootDepds=function(r,e){return d.__awaiter(this,void 0,void 0,function(){var t;return d.__generator(this,function(e){return this.canRegRootDepds()&&((t=this.rootContainer.get(a.AppConfigurationToken)).exports&&t.exports.length||t[l])&&this.importModule(t),[2,r]})})},e.prototype.canRegRootDepds=function(){return!!this.rootContainer},e.prototype.registerConfgureDepds=function(n,o){return d.__awaiter(this,void 0,void 0,function(){var t,r=this;return d.__generator(this,function(e){switch(e.label){case 0:return p.isArray(o.imports)&&o.imports.length?[4,n.get(p.ContainerBuilderToken).loader.loadTypes(o.imports,function(e){return r.isIocExt(e)||r.isDIModule(e)})]:[3,3];case 1:return t=e.sent(),[4,Promise.all(t.map(function(e){return r.importModule(e)}))];case 2:e.sent(),e.label=3;case 3:return p.isArray(o.providers)&&o.providers.length&&(o[l]=this.bindProvider(n,o.providers)),[2,n]}})})},e.prototype.createBuilder=function(){return new e},e.prototype.getBootstrapToken=function(e,t){return e.bootstrap||t},e.prototype.getBuilderViaConfig=function(e){return p.isToken(e)?this.getContainer().resolve(e):e instanceof n?e:null},e.prototype.getBuilderViaToken=function(e){if(p.isToken(e)){var t=p.isClass(e)?e:this.getContainer().getTokenImpl(e);if(t){var r=p.lang.first(p.getTypeMetadata(this.getDecorator(),t));if(r&&r.builder)return p.isToken(r.builder)?this.getContainer().resolve(r.builder):r.builder}}return null},e.prototype.mergeConfigure=function(t){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(e){return[2,t]})})},e.prototype.getMetaConfig=function(e){var t=this.getDecorator();if(this.isDIModule(e)){var r=p.getTypeMetadata(t,e);if(r&&r.length){var n=r[0];return n.bootstrap=n.bootstrap||e,p.lang.omit(n,"builder")}}return null},e.prototype.isIocExt=function(e){return p.hasOwnClassMetadata(p.IocExt,e)},e.prototype.isDIModule=function(e){return!!p.isClass(e)&&(!!p.hasOwnClassMetadata(this.getDecorator(),e)||p.hasOwnClassMetadata(s.DIModule,e))},e.prototype.registerExts=function(t,e){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(e){return t.has(u.BootstrapModule)||t.register(u.BootstrapModule),[2,t]})})},e.prototype.bindProvider=function(o,e){var i=[];return e.forEach(function(r,e){if(!p.isUndefined(r)&&!p.isNull(r))if(p.isProviderMap(r))r.forEach(function(e,t){i.push(e),o.bindProvider(e,t)});else if(r instanceof p.Provider)i.push(r.type),o.bindProvider(r.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.resolve.apply(r,[o].concat(e))});else if(p.isClass(r))o.has(r)||(i.push(r),o.register(r));else if(p.isBaseObject(r)){var t=r,n=!1;p.isToken(t.provide)?(p.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){p.isClass(e)&&!o.has(e)&&o.register(e)}),p.isUndefined(t.useValue)?p.isClass(t.useClass)?(o.has(t.useClass)||o.register(t.useClass),i.push(t.provide),o.bindProvider(t.provide,t.useClass)):p.isFunction(t.useFactory)?(i.push(t.provide),o.bindProvider(t.provide,function(){var e=[];return p.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return p.isClass(e)?o.get(e):e})),t.useFactory.apply(t,e)})):p.isToken(t.useExisting)?o.has(t.useExisting)?(i.push(t.provide),o.bindProvider(t.provide,t.useExisting)):console.log("has not register:",t.useExisting):n=!0:(i.push(t.provide),o.bindProvider(t.provide,function(){return t.useValue}))):n=!0,n&&p.lang.forIn(r,function(e,t){p.isUndefined(e)||(p.isClass(e)?o.bindProvider(t,e):p.isFunction(e)||p.isString(e)?o.bindProvider(t,function(){return e}):o.bindProvider(t,e),i.push(t))})}else p.isFunction(r)&&(i.push(name),o.bindProvider(name,function(){return r}))}),i},e.classAnnations={name:"BaseModuleBuilder",params:{constructor:[],getContainer:[],resetContainer:[],getContainerBuilder:[],build:["token","data"],buildStrategy:["instance","config"],importModule:["token","forceNew"],getBuilder:["config","forceNew"],getDecorator:[],getConfigure:["token"],createInstance:["token","cfg","data"],registerDepdences:["container","config"],resolveToken:["container","token","config"],registerRootDepds:["container","config"],canRegRootDepds:[],registerConfgureDepds:["container","config"],createBuilder:[],getBootstrapToken:["cfg","token"],getBuilderViaConfig:["builder"],getBuilderViaToken:["mdl"],mergeConfigure:["cfg"],getMetaConfig:["bootModule"],isIocExt:["token"],isDIModule:["token"],registerExts:["container","config"],bindProvider:["container","providers"]}},e}(),n=function(e){function t(){return e.call(this)||this}return d.__extends(t,e),(r=t).prototype.createBuilder=function(){return new r},t.classAnnations={name:"ModuleBuilder",params:{constructor:[],createBuilder:[]}},d.__decorate([p.Inject(p.ContainerToken),d.__metadata("design:type",Object)],t.prototype,"container",void 0),t=r=d.__decorate([p.Injectable(o.ModuleBuilderToken),d.__metadata("design:paramtypes",[])],t);var r}(t.BaseModuleBuilder=r);t.ModuleBuilder=n});e(c);c.BaseModuleBuilder,c.ModuleBuilder;var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(s){function e(e){var t=s.call(this)||this;return t.baseURL=e,t.globalModules=[],t.customRegs=[],t}return d.__extends(e,s),(t=e).prototype.getContainer=function(){if(!this.container){var e=this.getContainerBuilder();this.container=e.create()}return this.container},e.prototype.getContainerBuilder=function(){return this.containerBuilder||(this.containerBuilder=this.createContainerBuilder()),this.containerBuilder},e.prototype.createContainerBuilder=function(){return new p.DefaultContainerBuilder},e.prototype.useConfiguration=function(e){var t;this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig()));var r=this.getContainerBuilder();return p.isString(e)?t=r.loader.load([e]).then(function(e){return e.length?e[0]:null}):e&&(t=Promise.resolve(e)),t&&(this.globalConfig=this.globalConfig.then(function(r){return t.then(function(e){var t=e.default?e.default:e;return r=p.lang.assign(r||{},t||{})})})),this},e.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.globalModules=this.globalModules.concat(e),this},e.prototype.bootstrap=function(o){return d.__awaiter(this,void 0,void 0,function(){var t,r,n;return d.__generator(this,function(e){switch(e.label){case 0:return[4,this.build(o)];case 1:return t=e.sent(),n=t.container||this.getContainer(),t.config&&p.isToken(o)&&t.config.bootstrap!==o&&(!n.has(o)&&p.isClass(o)&&n.register(o),n.has(o)&&(r=n.resolve(o))),r=r||t,p.isFunction(r.onStart)?[4,Promise.resolve(r.onStart(t))]:[3,3];case 2:e.sent(),e.label=3;case 3:return p.isFunction(r.onStarted)&&r.onStarted(t),[2,t]}})})},e.prototype.build=function(t,r){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(e){switch(e.label){case 0:return this.rootContainer?[3,2]:[4,this.registerRoot()];case 1:e.sent(),e.label=2;case 2:return this.resetContainer(),this.container.bindProvider(o.RootContainerToken,this.rootContainer),this.rootContainer.has(o.RootModuleBuilderToken)?[4,this.rootContainer.get(o.RootModuleBuilderToken).build(t,r)]:[3,4];case 3:return[2,e.sent()];case 4:return[4,s.prototype.build.call(this,t,r)];case 5:return[2,e.sent()]}})})},e.prototype.registerRoot=function(){return d.__awaiter(this,void 0,void 0,function(){var t;return d.__generator(this,function(e){switch(e.label){case 0:return this.rootContainer?[3,3]:(this.rootContainer=this.getContainerBuilder().create(),[4,this.getGlobalConfigure()]);case 1:return t=e.sent(),this.bindAppConfig(t),[4,this.registerDepdences(this.rootContainer,t)];case 2:e.sent(),this.rootContainer.bindProvider(a.AppConfigurationToken,t),e.label=3;case 3:return[2,this.rootContainer]}})})},e.prototype.getGlobalConfigure=function(){return this.globalConfig||this.useConfiguration(),this.globalConfig},e.prototype.canRegRootDepds=function(){return!1},e.prototype.createBuilder=function(e){return new t(e)},e.prototype.registerExts=function(o,i){return d.__awaiter(this,void 0,void 0,function(){var t,r,n=this;return d.__generator(this,function(e){switch(e.label){case 0:return[4,s.prototype.registerExts.call(this,o,i)];case 1:return e.sent(),i.exports=i.exports||[],this.customRegs.length?[4,Promise.all(this.customRegs.map(function(r){return d.__awaiter(n,void 0,void 0,function(){var t;return d.__generator(this,function(e){switch(e.label){case 0:return[4,r(o,i,this)];case 1:return t=e.sent(),p.isArray(t)&&t.length&&(i.exports=i.exports.concat(t)),[2]}})})}))]:[3,3];case 2:e.sent(),e.label=3;case 3:return this.globalModules.length?(t=this.globalModules,[4,o.loadModule.apply(o,t)]):[3,5];case 4:(r=e.sent()).length&&(i.exports=i.exports.concat(r)),e.label=5;case 5:return[2,o]}})})},e.prototype.mergeConfigure=function(r){return d.__awaiter(this,void 0,void 0,function(){var t;return d.__generator(this,function(e){switch(e.label){case 0:return[4,s.prototype.mergeConfigure.call(this,r)];case 1:return r=e.sent(),t=this.rootContainer.get(a.AppConfigurationToken),[2,p.lang.assign({},p.lang.omit(t||{},"imports","providers","bootstrap","builder","exports"),r)]}})})},e.prototype.bindAppConfig=function(e){return this.baseURL&&(e.baseURL=this.baseURL),e},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"ApplicationBuilder",params:{constructor:["baseURL"],getContainer:[],getContainerBuilder:[],createContainerBuilder:[],useConfiguration:["config"],use:["modules"],bootstrap:["token"],build:["token","data"],registerRoot:[],getGlobalConfigure:[],canRegRootDepds:[],createBuilder:["baseURL"],registerExts:["container","config"],mergeConfigure:["cfg"],bindAppConfig:["config"],getDefaultConfig:[]}},e=t=d.__decorate([p.Injectable(n.ApplicationBuilderToken),d.__metadata("design:paramtypes",[String])],e);var t}(c.BaseModuleBuilder);t.ApplicationBuilder=r});e(l);l.ApplicationBuilder;var f=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(t){function e(e){return t.call(this,"DI_Application",e)||this}return d.__extends(e,t),e.classAnnations={name:"InjectApplicationToken",params:{constructor:["desc"]}},e}(p.Registration);t.InjectApplicationToken=r,t.ApplicationToken=new r("")});e(f);f.InjectApplicationToken,f.ApplicationToken;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),d.__exportStar(s,t),d.__exportStar(a,t),d.__exportStar(l,t),d.__exportStar(f,t),d.__exportStar(n,t),d.__exportStar(o,t),d.__exportStar(c,t),d.__exportStar(u,t)}))});