!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("tslib"),require("@ts-ioc/core")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core"],t):(e.bootstrap=e.bootstrap||{},e.bootstrap.umd=e.bootstrap.umd||{},e.bootstrap.umd.js=t(e.tslib_1,e.core_1))}(this,function(a,u){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function t(e,t){return e(t={exports:{}},t.exports),t.exports}a=a&&a.hasOwnProperty("default")?a.default:a,u=u&&u.hasOwnProperty("default")?u.default:u;var r=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(t){function e(e){return t.call(this,"DI_ModuleBuilder",e)||this}return a.__extends(e,t),e.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},e}(u.Registration);t.InjectModuleBuilder=n,t.ModuleBuilderToken=new n("")});e(r);r.InjectModuleBuilder,r.ModuleBuilderToken;var o=t(function(e,t){function n(t,n,r,i,o){return u.createClassDecorator("DIModule",function(e){i&&i(e),e.next({match:function(e){return e&&(u.isString(e)||u.isObject(e)&&e instanceof u.Registration)},setMetadata:function(e,t){u.isString(t)?e.name=t:e.provide=t}}),e.next({match:function(e){return u.isString(e)||u.isToken(e)},setMetadata:function(e,t){u.isString(t)?e.name=t:e.builder=t}}),e.next({match:function(e){return u.isString(e)||u.isBoolean(e)},setMetadata:function(e,t){u.isString(t)?e.name=t:u.isBoolean(t)&&(e.singleton=t)}})},function(e){(o&&(e=o(e)),!e.name&&u.isClass(e.type))&&(/^[a-z]$/.test(e.type.name)&&e.type.classAnnations?e.name=e.type.classAnnations.name:e.name=e.type.name);return e.provide=e.provide||r,e.alias=e.alias||e.name,e.decorType=t,e.builder||(e.builder=n),e})}Object.defineProperty(t,"__esModule",{value:!0}),t.createDIModuleDecorator=n,t.DIModule=n("module",r.ModuleBuilderToken)});e(o);o.createDIModuleDecorator,o.DIModule;var i=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(t){function e(e){return t.call(this,"DI_Application",e)||this}return a.__extends(e,t),e.classAnnations={name:"InjectApplicationToken",params:{constructor:["desc"]}},e}(u.Registration);t.InjectApplicationToken=n,t.ApplicationToken=new n("")});e(i);i.InjectApplicationToken,i.ApplicationToken;var n=t(function(e,t){function n(e,t,n,r,i){return o.createDIModuleDecorator(e,t,n,r,i)}Object.defineProperty(t,"__esModule",{value:!0}),t.createBootstrapDecorator=n,t.Bootstrap=n("bootstrap",r.ModuleBuilderToken,i.ApplicationToken)});e(n);n.createBootstrapDecorator,n.Bootstrap;var s=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),a.__exportStar(o,t),a.__exportStar(n,t)});e(s);var c=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ApplicationBuilderToken=new u.InjectToken("DI_AppBuilder"),t.ApplicationBuilderFactoryToken=new u.InjectToken("DI_AppBuilder_Factory")});e(c);c.ApplicationBuilderToken,c.ApplicationBuilderFactoryToken;var l=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return(t=e).prototype.build=function(i,o){return a.__awaiter(this,void 0,void 0,function(){var t,n,r;return a.__generator(this,function(e){switch(e.label){case 0:return t=this.getConfigure(i),[4,(n=this.getBuilder(t)).createInstance(u.isToken(i)?i:null,t,o)];case 1:return r=e.sent(),[4,n.buildStrategy(r,t)];case 2:return e.sent(),[2,r]}})})},e.prototype.buildStrategy=function(t,e){return a.__awaiter(this,void 0,void 0,function(){return a.__generator(this,function(e){return[2,t]})})},e.prototype.getBuilder=function(e){var t;if(e.builder)t=this.getBuilderViaConfig(e.builder);else{var n=this.getBootstrapToken(e);n&&(t=this.getBuilderViaToken(n))}return t||this},e.prototype.getDecorator=function(){return s.DIModule.toString()},e.prototype.getConfigure=function(e){var t;if(u.isClass(e))t=this.getMetaConfig(e);else if(u.isToken(e)){var n=this.container.getTokenImpl(e);u.isClass(n)&&(t=this.getMetaConfig(n))}else{t=e;var r=this.getBootstrapToken(t),i=u.isClass(r)?r:this.container.getTokenImpl(r);u.isClass(i)&&(t=u.lang.assign({},this.getMetaConfig(i),t||{}))}return t||{}},e.prototype.createInstance=function(n,r,e){return a.__awaiter(this,void 0,void 0,function(){var t;return a.__generator(this,function(e){switch(e.label){case 0:if(!(t=this.getBootstrapToken(r,n)))throw new Error("not find bootstrap token.");return[4,this.registerDepdences(r)];case 1:return e.sent(),u.isClass(t)&&(this.container.has(t)||this.container.register(t)),[2,this.container.resolve(t)]}})})},e.prototype.getBootstrapToken=function(e,t){return e.bootstrap||t},e.prototype.getBuilderViaConfig=function(e){return u.isToken(e)?this.container.resolve(e):e instanceof t?e:null},e.prototype.getBuilderViaToken=function(e){if(u.isToken(e)){var t=u.isClass(e)?e:this.container.getTokenImpl(e);if(t){var n=u.lang.first(u.getTypeMetadata(this.getDecorator(),t));if(n&&n.builder)return u.isToken(n.builder)?this.container.resolve(n.builder):n.builder}}return null},e.prototype.getMetaConfig=function(e){var t=this.getDecorator();if(u.hasClassMetadata(t,e)){var n=u.getTypeMetadata(t,e);if(n&&n.length){var r=n[0];return r.bootstrap=r.bootstrap||e,u.lang.omit(r,"builder")}}return null},e.prototype.registerDepdences=function(s){return a.__awaiter(this,void 0,void 0,function(){var t,o,n,r=this;return a.__generator(this,function(e){switch(e.label){case 0:return u.isArray(s.imports)&&s.imports.length?(t=this.container.get(u.ContainerBuilderToken),o=this.getDecorator(),[4,t.loader.loadTypes(s.imports,function(e){return u.hasOwnClassMetadata(u.IocExt,e)||u.hasOwnClassMetadata(o,e)})]):[3,3];case 1:return e.sent().forEach(function(i){return a.__awaiter(r,void 0,void 0,function(){var t,n,r=this;return a.__generator(this,function(e){switch(e.label){case 0:return this.container.has(c.ApplicationBuilderFactoryToken)&&u.hasClassMetadata(o,i)?(t=u.lang.first(u.getTypeMetadata(o,i)))?[4,(n=this.container.get(c.ApplicationBuilderFactoryToken)).build(i)]:[3,2]:[3,3];case 1:e.sent(),t.exports&&t.exports.length&&t.exports.forEach(function(e){r.container.bindProvider(e,function(){return n.getContainer().resolve(e)})}),t.providers&&t.providers.length&&this.bindProvider(this.container,s.providers),this.container.bindProvider(i,function(){return n.build(i)}),e.label=2;case 2:return[3,4];case 3:this.container.register(i),e.label=4;case 4:return[2]}})})}),[4,(n=this.container).loadModule.apply(n,s.imports)];case 2:e.sent(),e.label=3;case 3:return u.isArray(s.providers)&&s.providers.length&&this.bindProvider(this.container,s.providers),[2,this.container]}})})},e.prototype.bindProvider=function(i,e){e.forEach(function(n,e){if(!u.isUndefined(n)&&!u.isNull(n))if(u.isProviderMap(n))n.forEach(function(e,t){i.bindProvider(e,t)});else if(n instanceof u.Provider)i.bindProvider(n.type,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.resolve.apply(n,[i].concat(e))});else if(u.isClass(n))i.has(n)||i.register(n);else if(u.isBaseObject(n)){var t=n,r=!1;u.isToken(t.provide)?(u.isArray(t.deps)&&t.deps.length&&t.deps.forEach(function(e){u.isClass(e)&&!i.has(e)&&i.register(e)}),u.isUndefined(t.useValue)?u.isClass(t.useClass)?(i.has(t.useClass)||i.register(t.useClass),i.bindProvider(t.provide,t.useClass)):u.isFunction(t.useFactory)?i.bindProvider(t.provide,function(){var e=[];return u.isArray(t.deps)&&t.deps.length&&(e=t.deps.map(function(e){return u.isClass(e)?i.get(e):e})),t.useFactory.apply(t,e)}):u.isToken(t.useExisting)?i.has(t.useExisting)?i.bindProvider(t.provide,t.useExisting):console.log("has not register:",t.useExisting):r=!0:i.bindProvider(t.provide,function(){return t.useValue})):r=!0,r&&u.lang.forIn(n,function(e,t){u.isUndefined(e)||(u.isClass(e)?i.bindProvider(t,e):u.isFunction(e)||u.isString(e)?i.bindProvider(t,function(){return e}):i.bindProvider(t,e))})}else u.isFunction(n)&&i.bindProvider(name,function(){return n})})},e.classAnnations={name:"ModuleBuilder",params:{constructor:[],build:["token","data"],buildStrategy:["instance","config"],getBuilder:["config"],getDecorator:[],getConfigure:["token"],createInstance:["token","cfg","data"],getBootstrapToken:["cfg","token"],getBuilderViaConfig:["builder"],getBuilderViaToken:["mdl"],getMetaConfig:["bootModule"],registerDepdences:["config"],bindProvider:["container","providers"]}},a.__decorate([u.Inject(u.ContainerToken),a.__metadata("design:type",Object)],e.prototype,"container",void 0),e=t=a.__decorate([u.Injectable(r.ModuleBuilderToken),a.__metadata("design:paramtypes",[])],e);var t}();t.ModuleBuilder=n});e(l);l.ModuleBuilder;var d=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.container=e}return e.prototype.setup=function(){var e=this.container,t=e.get(u.LifeScopeToken);t.registerDecorator(s.DIModule,u.CoreActions.bindProvider,u.CoreActions.cache,u.CoreActions.componentBeforeInit,u.CoreActions.componentInit,u.CoreActions.componentAfterInit),t.registerDecorator(s.Bootstrap,u.CoreActions.bindProvider,u.CoreActions.cache,u.CoreActions.componentBeforeInit,u.CoreActions.componentInit,u.CoreActions.componentAfterInit),e.register(l.ModuleBuilder),e.register(p.ApplicationBuilder)},e.classAnnations={name:"BootstrapModule",params:{constructor:["container"],setup:[]}},e=a.__decorate([u.IocExt("setup"),a.__param(0,u.Inject(u.ContainerToken)),a.__metadata("design:paramtypes",[Object])],e)}();t.BootstrapModule=n});e(d);d.BootstrapModule;var p=t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.baseURL=e,this.usedModules=[],this.customRegs=[]}return e.prototype.getContainer=function(){return this.container||(this.container=this.getContainerBuilder().create()),this.container},e.prototype.setContainer=function(e){return e&&(this.container=e,this.builder=e.get(u.ContainerBuilderToken)),this},e.prototype.getContainerBuilder=function(){return this.builder||(this.builder=this.createContainerBuilder()),this.builder},e.prototype.setContainerBuilder=function(e){return this.builder=e,this.container=null,this},e.prototype.getModuleBuilder=function(){return this.moduleBuilder||(this.moduleBuilder=this.createModuleBuilder()),this.moduleBuilder},e.prototype.setModuleBuilder=function(e){return this.moduleBuilder=e,this},e.prototype.useConfiguration=function(e){var t;this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig()));var n=this.getContainerBuilder();return u.isString(e)?t=n.loader.load([e]).then(function(e){return e.length?e[0]:null}):e&&(t=Promise.resolve(e)),t&&(this.globalConfig=this.globalConfig.then(function(n){return t.then(function(e){var t=e.default?e.default:e;return n=u.lang.assign(n||{},t||{})})})),this},e.prototype.use=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.usedModules=this.usedModules.concat(e),this},e.prototype.registerModules=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.customRegs=this.customRegs.concat(e),this},e.prototype.bootstrap=function(r){return a.__awaiter(this,void 0,void 0,function(){var t,n;return a.__generator(this,function(e){switch(e.label){case 0:return[4,this.build(r)];case 1:return(t=e.sent()).config&&u.isToken(r)&&t.config.bootstrap!==r&&(!this.container.has(r)&&u.isClass(r)&&this.container.register(r),this.container.has(r)&&(n=this.container.resolve(r))),n=n||t,u.isFunction(n.onStart)?[4,Promise.resolve(n.onStart(t))]:[3,3];case 2:e.sent(),e.label=3;case 3:return u.isFunction(n.onStarted)&&n.onStarted(t),[2,n]}})})},e.prototype.build=function(i){return a.__awaiter(this,void 0,void 0,function(){var t,n,r;return a.__generator(this,function(e){switch(e.label){case 0:return t=this.getContainer(),[4,this.registerExts(t)];case 1:return e.sent(),n=this.getModuleBuilder(),[4,this.mergeConfigure(n.getConfigure(i))];case 2:return r=e.sent(),this.bindConfiguration(t,r),[4,this.initContainer(r,t)];case 3:return e.sent(),r.bootstrap||(r.bootstrap=u.isToken(i)?i:null),[4,this.createInstance(n,r)];case 4:return[2,e.sent()]}})})},e.prototype.createInstance=function(e,t){return e.build(t)},e.prototype.createModuleBuilder=function(){return this.getContainer().get(r.ModuleBuilderToken)},e.prototype.createContainerBuilder=function(){return new u.DefaultContainerBuilder},e.prototype.registerExts=function(r){return a.__awaiter(this,void 0,void 0,function(){var t,n=this;return a.__generator(this,function(e){switch(e.label){case 0:return this.container.bindProvider(c.ApplicationBuilderToken,this),this.container.bindProvider(c.ApplicationBuilderFactoryToken,function(){return n.createContainerBuilder()}),r.has(d.BootstrapModule)||r.register(d.BootstrapModule),this.usedModules.length?(t=this.usedModules,this.usedModules=[],[4,r.loadModule.apply(r,[r].concat(t))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2,r]}})})},e.prototype.initContainer=function(r,i){return a.__awaiter(this,void 0,void 0,function(){var t,n=this;return a.__generator(this,function(e){switch(e.label){case 0:return this.customRegs.length?(t=this.customRegs,this.customRegs=[],[4,Promise.all(t.map(function(e){return e(i,r,n)}))]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2,i]}})})},e.prototype.bindConfiguration=function(e,t){this.baseURL&&(t.baseURL=this.baseURL)},e.prototype.mergeConfigure=function(n){return a.__awaiter(this,void 0,void 0,function(){var t;return a.__generator(this,function(e){switch(e.label){case 0:return this.globalConfig||this.useConfiguration(),[4,this.globalConfig];case 1:return t=e.sent(),[2,u.lang.assign({},t,n)]}})})},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"ApplicationBuilder",params:{constructor:["baseURL"],getContainer:[],setContainer:["container"],getContainerBuilder:[],setContainerBuilder:["builder"],getModuleBuilder:[],setModuleBuilder:["builder"],useConfiguration:["config"],use:["modules"],registerModules:["moduleRegs"],bootstrap:["token"],build:["token"],createInstance:["builder","config"],createModuleBuilder:[],createContainerBuilder:[],registerExts:["container"],initContainer:["config","container"],bindConfiguration:["container","config"],mergeConfigure:["cfg"],getDefaultConfig:[]}},e}();t.ApplicationBuilder=n});e(p);p.ApplicationBuilder;return e(t(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),a.__exportStar(s,t),a.__exportStar(p,t),a.__exportStar(i,t),a.__exportStar(c,t),a.__exportStar(r,t),a.__exportStar(l,t),a.__exportStar(d,t)}))});